<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ET Panthiya.lk Quiz Portal</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --warning: #f72585;
            --info: #560bad;
            --danger: #e63946;
            --radius: 12px;
            --shadow: 0 10px 20px rgba(0,0,0,0.1);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --glass: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: var(--light);
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
        }

        /* Particle Background */
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        /* Day Greeting */
        .day-greeting {
            text-align: center;
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
            opacity: 0.9;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        /* Header Section */
        .header {
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.8), rgba(63, 55, 201, 0.9));
            color: white;
            padding: 2rem 1rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow);
            z-index: 10;
            backdrop-filter: blur(5px);
            border-bottom: 1px solid var(--glass-border);
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://etpanthiya.lk/wp-content/uploads/2023/05/etp-logo.png') no-repeat center center;
            background-size: cover;
            opacity: 0.1;
            z-index: -1;
        }

        .profile-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: white;
            margin: 0 auto 1rem;
            overflow: hidden;
            border: 5px solid white;
            box-shadow: var(--shadow);
            position: relative;
            animation: float 6s ease-in-out infinite;
        }

        .profile-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .title {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            animation: fadeInDown 1s ease;
            font-family: 'Montserrat', sans-serif;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto 1.5rem;
            animation: fadeIn 1.5s ease;
        }

        .header-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.8rem 1.8rem;
            border-radius: 50px;
            font-weight: 600;
            text-decoration: none;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            border: none;
            outline: none;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .btn-primary {
            background-color: white;
            color: var(--primary);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background-color: var(--accent);
            color: white;
        }

        .btn-secondary:hover {
            background-color: var(--secondary);
            transform: translateY(-3px);
        }

        .btn-whatsapp {
            background-color: #25D366;
            color: white;
        }

        .btn-whatsapp:hover {
            background-color: #128C7E;
            transform: translateY(-3px);
        }

        /* Notice Section */
        .notice-section {
            background-color: var(--glass);
            backdrop-filter: blur(10px);
            max-width: 900px;
            margin: 2rem auto;
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border-left: 5px solid var(--warning);
            animation: slideInUp 1s ease;
            border: 1px solid var(--glass-border);
        }

        .notice-title {
            color: var(--warning);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .notice-content {
            line-height: 1.6;
        }

        /* Lessons Grid */
        .lessons-container {
            padding: 2rem 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .section-title {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2rem;
            color: white;
            position: relative;
            display: inline-block;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Montserrat', sans-serif;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(to right, var(--primary), var(--accent));
            border-radius: 2px;
        }

        .lessons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .lesson-card {
            background-color: var(--glass);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: relative;
            transform: translateY(0);
            border: 1px solid var(--glass-border);
        }

        .lesson-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }

        .lesson-image {
            height: 180px;
            width: 100%;
            object-fit: cover;
        }

        .lesson-content {
            padding: 1.5rem;
        }

        .lesson-title {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
            color: white;
        }

        .lesson-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
        }

        .lesson-levels {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .level-btn {
            padding: 0.4rem 0.8rem;
            background-color: rgba(255,255,255,0.1);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            outline: none;
            color: white;
        }

        .level-btn:hover {
            background-color: var(--accent);
            color: white;
        }

        .level-btn.locked {
            background-color: rgba(0,0,0,0.2);
            color: rgba(255,255,255,0.5);
            cursor: not-allowed;
        }

        .level-btn.active {
            background-color: var(--primary);
            color: white;
        }

        .level-btn.completed {
            background-color: var(--success);
            color: white;
        }

        /* Floating Action Buttons */
        .fab-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            z-index: 100;
        }

        .fab {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            border: none;
            outline: none;
        }

        .fab:hover {
            transform: scale(1.1);
        }

        .fab-whatsapp {
            background-color: #25D366;
        }

        .fab-papers {
            background-color: var(--info);
        }

        .fab-menu {
            background-color: var(--dark);
        }

        .fab-dropdown {
            position: absolute;
            bottom: 70px;
            right: 0;
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transform: scale(0);
            transform-origin: bottom right;
            transition: var(--transition);
            opacity: 0;
        }

        .fab-dropdown.show {
            transform: scale(1);
            opacity: 1;
        }

        .fab-item {
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            text-decoration: none;
            color: var(--dark);
            transition: var(--transition);
            white-space: nowrap;
        }

        .fab-item:hover {
            background-color: var(--light);
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            backdrop-filter: blur(5px);
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--radius);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            transform: translateY(20px);
            transition: var(--transition);
            position: relative;
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--warning);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            font-family: inherit;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
            outline: none;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Quiz Timer Modal */
        .quiz-modal {
            max-width: 800px;
        }

        .quiz-header {
            background-color: var(--primary);
            color: white;
            padding: 1.5rem;
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .quiz-title {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .quiz-level {
            opacity: 0.9;
        }

        .quiz-timer {
            font-size: 1.2rem;
            font-weight: 600;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .timer-warning {
            color: #ffcc00;
        }

        .timer-danger {
            color: #ff3333;
            animation: pulse 1s infinite;
        }

        .quiz-iframe {
            width: 100%;
            height: 500px;
            border: none;
            background-color: white;
        }

        .quiz-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--danger);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: var(--transition);
        }

        .quiz-close-btn:hover {
            transform: scale(1.1);
        }

        /* Profile Section */
        .profile-section {
            display: none;
            background-color: var(--glass);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            max-width: 500px;
            margin: 2rem auto;
            animation: fadeIn 0.5s ease;
            border: 1px solid var(--glass-border);
            color: white;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .profile-pic {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
        }

        .profile-info h3 {
            margin-bottom: 0.2rem;
            color: white;
        }

        .profile-info p {
            color: rgba(255,255,255,0.8);
        }

        .profile-details {
            margin-top: 1.5rem;
        }

        .detail-row {
            display: flex;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .detail-label {
            font-weight: 600;
            width: 120px;
            color: rgba(255,255,255,0.8);
        }

        .detail-value {
            flex: 1;
        }

        .logout-btn {
            display: block;
            margin-top: 1.5rem;
            text-align: center;
            color: var(--warning);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
            background: none;
            border: none;
            cursor: pointer;
            width: 100%;
            padding: 0.5rem;
            border-radius: var(--radius);
        }

        .logout-btn:hover {
            color: #d00000;
            background: rgba(255,255,255,0.1);
        }

        .delete-account-btn {
            display: block;
            margin-top: 0.5rem;
            text-align: center;
            color: var(--danger);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
            background: none;
            border: none;
            cursor: pointer;
            width: 100%;
            padding: 0.5rem;
            border-radius: var(--radius);
        }

        .delete-account-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Auth Indicator */
        .auth-indicator {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background-color: var(--glass);
            backdrop-filter: blur(10px);
            padding: 0.5rem 1rem;
            border-radius: 50px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 100;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--glass-border);
            color: white;
        }

        .auth-indicator:hover {
            transform: translateY(-3px);
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Loading Spinner */
        .spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .spinner.show {
            display: flex;
        }

        .spinner-circle {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--dark);
            color: white;
            padding: 1rem 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: 1000;
            opacity: 0;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            max-width: 90%;
            text-align: center;
        }

        .toast.show {
            opacity: 1;
            bottom: 3rem;
        }

        .toast.success {
            background-color: #28a745;
        }

        .toast.error {
            background-color: #dc3545;
        }

        .toast.warning {
            background-color: #ffc107;
            color: var(--dark);
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            height: 5px;
            background-color: rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1001;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--primary), var(--accent));
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Terms Modal */
        .terms-modal {
            z-index: 2000;
        }

        .terms-content {
            max-height: 70vh;
            overflow-y: auto;
            padding: 1rem;
        }

        .terms-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .terms-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        /* SMS Verification Modal */
        .verification-modal .modal-content {
            max-width: 400px;
        }

        .verification-code-inputs {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .verification-code-input {
            width: 40px;
            height: 50px;
            text-align: center;
            font-size: 1.5rem;
            border: 2px solid #ddd;
            border-radius: 5px;
        }

        .verification-code-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .resend-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            display: none;
        }

        .resend-btn.active {
            display: inline;
        }

        .countdown {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        /* Student Info Form */
        .student-form .form-group {
            margin-bottom: 1rem;
        }

        .student-form label {
            font-size: 0.9rem;
            color: #555;
        }

        /* Confirm Exit Modal */
        .confirm-exit-modal .modal-content {
            max-width: 400px;
            text-align: center;
        }

        .confirm-exit-modal .modal-footer {
            justify-content: center;
        }

        /* Animations */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .title {
                font-size: 2rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            .lessons-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .fab-container {
                bottom: 1rem;
                right: 1rem;
            }

            .quiz-iframe {
                height: 400px;
            }
        }

        @media (max-width: 480px) {
            .header-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .profile-circle {
                width: 100px;
                height: 100px;
            }

            .modal-content {
                width: 95%;
            }

            .verification-code-input {
                width: 30px;
                height: 40px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Particles Background -->
    <div id="particles-js"></div>

    <!-- Progress Bar -->
    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <!-- Loading Spinner -->
    <div class="spinner" id="spinner">
        <div class="spinner-circle"></div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Auth Indicator -->
    <div class="auth-indicator" id="authIndicator">
        <div class="user-avatar" id="userAvatar">G</div>
        <span id="authText">Guest</span>
    </div>

    <!-- Header Section -->
    <header class="header">
        <div class="day-greeting" id="dayGreeting">
            <i class="fas fa-sun"></i>
            <span id="greetingText">Good Morning</span>
        </div>
        <div class="profile-circle">
            <img src="https://etpanthiya.lk/wp-content/uploads/2023/05/etp-logo.png" alt="Tutor">
        </div>
        <h1 class="title">ET Panthiya.lk Quiz Portal</h1>
        <p class="subtitle">Test your knowledge and improve your engineering technology skills with our interactive quiz portal. Complete lessons, track progress, and become an expert!</p>
        
        <div class="header-buttons">
            <a href="https://etpanthiya.lk" class="btn btn-primary">
                <i class="fas fa-globe"></i> Visit ET Panthiya.lk
            </a>
            <a href="#" class="btn btn-secondary" id="profileBtn">
                <i class="fas fa-user"></i> My Profile
            </a>
            <a href="https://chat.whatsapp.com/yourgroup" class="btn btn-whatsapp">
                <i class="fab fa-whatsapp"></i> Join WhatsApp Group
            </a>
        </div>
    </header>

    <!-- Notice Section -->
    <section class="notice-section">
        <h3 class="notice-title"><i class="fas fa-exclamation-circle"></i> Important Notice</h3>
        <p class="notice-content">
            Welcome to the ET Panthiya Quiz Portal! Guest users can access Level 1 of all lessons without signing in. 
            To unlock Levels 2-20, please sign up or log in. Each quiz has a 35-minute time limit. 
            Make sure to complete your answers before time runs out!
        </p>
    </section>

    <!-- Profile Section -->
    <section class="profile-section" id="profileSection">
        <div class="profile-header">
            <img src="https://via.placeholder.com/150" alt="Profile" class="profile-pic" id="profilePic">
            <div class="profile-info">
                <h3 id="profileName">Guest User</h3>
                <p id="profileEmail">guest@example.com</p>
            </div>
        </div>
        
        <div class="profile-details">
            <div class="detail-row">
                <span class="detail-label">Completed Lessons:</span>
                <span class="detail-value" id="completedLessons">0/17</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Completed Levels:</span>
                <span class="detail-value" id="completedLevels">0/340</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Member Since:</span>
                <span class="detail-value" id="memberSince">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Account Status:</span>
                <span class="detail-value" id="accountStatus">Guest</span>
            </div>
        </div>
        
        <button class="logout-btn" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i> Log Out
        </button>
        <button class="delete-account-btn" id="deleteAccountBtn">
            <i class="fas fa-trash-alt"></i> Delete Account
        </button>
    </section>

    <!-- Lessons Grid -->
    <section class="lessons-container">
        <h2 class="section-title">Available Lessons</h2>
        <div class="lessons-grid" id="lessonsGrid">
            <!-- Lessons will be dynamically inserted here -->
        </div>
    </section>

    <!-- Floating Action Buttons -->
    <div class="fab-container">
        <div class="fab fab-whatsapp" id="fabWhatsapp">
            <i class="fab fa-whatsapp"></i>
        </div>
        <div class="fab fab-papers" id="fabPapers">
            <i class="fas fa-book"></i>
        </div>
        <div class="fab fab-menu" id="fabMenu">
            <i class="fas fa-ellipsis-v"></i>
        </div>
        
        <div class="fab-dropdown" id="fabDropdown">
            <a href="https://etpanthiya.lk/student-portal" class="fab-item" target="_blank">
                <i class="fas fa-user-graduate"></i> Student Portal
            </a>
            <a href="https://etpanthiya.lk/feedback" class="fab-item" target="_blank">
                <i class="fas fa-comment-alt"></i> Give Feedback
            </a>
            <a href="https://etpanthiya.lk/results" class="fab-item" target="_blank">
                <i class="fas fa-chart-bar"></i> Results
            </a>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="authModalTitle">Sign In</h3>
                <button class="modal-close" id="authModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <div id="authForm">
                    <div class="form-group">
                        <label for="authEmail" class="form-label">Email</label>
                        <input type="email" id="authEmail" class="form-control" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="authPassword" class="form-label">Password</label>
                        <input type="password" id="authPassword" class="form-control" placeholder="Enter your password">
                    </div>
                    <div class="form-group" id="authNameGroup" style="display: none;">
                        <label for="authName" class="form-label">Full Name</label>
                        <input type="text" id="authName" class="form-control" placeholder="Enter your full name">
                    </div>
                    <div class="form-group form-check" id="rememberMeGroup">
                        <input type="checkbox" class="form-check-input" id="rememberMe">
                        <label class="form-check-label" for="rememberMe">Remember me</label>
                    </div>
                </div>
                <p id="authToggleText">Don't have an account? <a href="#" id="authToggleLink">Sign up</a></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="authCancelBtn">Cancel</button>
                <button class="btn btn-primary" id="authSubmitBtn">Sign In</button>
            </div>
        </div>
    </div>

    <!-- SMS Verification Modal -->
    <div class="modal verification-modal" id="verificationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Phone Verification</h3>
            </div>
            <div class="modal-body">
                <p>We've sent a 6-digit verification code to your phone number. Please enter it below:</p>
                
                <div class="verification-code-inputs" id="verificationInputs">
                    <input type="text" class="verification-code-input" maxlength="1" data-index="0">
                    <input type="text" class="verification-code-input" maxlength="1" data-index="1">
                    <input type="text" class="verification-code-input" maxlength="1" data-index="2">
                    <input type="text" class="verification-code-input" maxlength="1" data-index="3">
                    <input type="text" class="verification-code-input" maxlength="1" data-index="4">
                    <input type="text" class="verification-code-input" maxlength="1" data-index="5">
                </div>
                
                <button class="btn btn-primary" id="verifyCodeBtn" style="width: 100%;">Verify</button>
                
                <div class="countdown" id="countdown">Resend code in 2:00</div>
                <button class="resend-btn" id="resendBtn">Resend Code</button>
            </div>
        </div>
    </div>

    <!-- Student Info Modal -->
    <div class="modal" id="studentInfoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Complete Your Profile</h3>
            </div>
            <div class="modal-body student-form">
                <form id="studentForm" action="https://formsubmit.co/hiranrusiru@gmail.com" method="POST">
                    <input type="hidden" name="_subject" value="New Student Registration - ET Panthiya">
                    <input type="hidden" name="_captcha" value="false">
                    <input type="hidden" name="_next" value="https://etpanthiya.lk/thank-you">
                    <input type="hidden" name="email" id="formEmail">
                    
                    <div class="form-group">
                        <label for="studentName">Full Name</label>
                        <input type="text" id="studentName" name="name" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="school">School</label>
                        <input type="text" id="school" name="school" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="examYear">Exam Year</label>
                        <input type="number" id="examYear" name="examYear" class="form-control" min="2000" max="2030" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Gender</label>
                        <div style="display: flex; gap: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="radio" name="gender" value="Male" required> Male
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="radio" name="gender" value="Female"> Female
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="district">District</label>
                        <select id="district" name="district" class="form-control" required>
                            <option value="">Select District</option>
                            <option value="Colombo">Colombo</option>
                            <option value="Gampaha">Gampaha</option>
                            <option value="Kalutara">Kalutara</option>
                            <!-- Add more districts as needed -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="whatsappNumber">WhatsApp Number</label>
                        <input type="tel" id="whatsappNumber" name="whatsappNumber" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Terms Modal -->
    <div class="modal terms-modal" id="termsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Terms and Conditions</h3>
            </div>
            <div class="modal-body terms-content">
                <h4>1. Acceptance of Terms</h4>
                <p>By accessing or using the ET Panthiya Quiz Portal, you agree to be bound by these Terms and Conditions.</p>
                
                <h4>2. User Responsibilities</h4>
                <p>You are responsible for maintaining the confidentiality of your account and password and for restricting access to your computer or device.</p>
                
                <h4>3. Privacy Policy</h4>
                <p>Your use of our services is also governed by our Privacy Policy, which explains how we collect, use, and protect your personal information.</p>
                
                <h4>4. Intellectual Property</h4>
                <p>All content, including quizzes, lessons, and materials on this portal, are the property of ET Panthiya and are protected by copyright laws.</p>
                
                <h4>5. Prohibited Activities</h4>
                <p>You agree not to engage in any activity that interferes with or disrupts the services or servers and networks connected to the services.</p>
                
                <h4>6. Limitation of Liability</h4>
                <p>ET Panthiya shall not be liable for any indirect, incidental, special, consequential, or punitive damages resulting from your use of the services.</p>
                
                <div class="terms-checkbox">
                    <input type="checkbox" id="agreeTerms" required>
                    <label for="agreeTerms">I have read and agree to the Terms and Conditions</label>
                </div>
            </div>
            <div class="modal-footer terms-footer">
                <button class="btn btn-secondary" id="declineTermsBtn">Decline</button>
                <button class="btn btn-primary" id="acceptTermsBtn" disabled>Accept</button>
            </div>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div class="modal" id="quizModal">
        <div class="modal-content quiz-modal">
            <button class="quiz-close-btn" id="quizCloseBtn">
                <i class="fas fa-times"></i>
            </button>
            <div class="quiz-header">
                <h3 class="quiz-title" id="quizTitle">Lesson Title</h3>
                <p class="quiz-level" id="quizLevel">Level 1</p>
                <div class="quiz-timer" id="quizTimer">
                    <i class="fas fa-clock"></i>
                    <span id="timeRemaining">35:00</span>
                </div>
            </div>
            <div id="formPreloader" style="display: none; text-align: center; padding: 2rem;">
                <div class="spinner-circle" style="margin: 0 auto;"></div>
                <p>Loading quiz...</p>
            </div>
            <iframe class="quiz-iframe" id="quizIframe" src="about:blank"></iframe>
        </div>
    </div>

    <!-- Confirm Exit Modal -->
    <div class="modal confirm-exit-modal" id="confirmExitModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Confirm Exit</h3>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to leave this quiz? Your progress will be lost if you exit now.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelExitBtn">Cancel</button>
                <button class="btn btn-danger" id="confirmExitBtn">Exit Quiz</button>
            </div>
        </div>
    </div>

    <!-- Particles.js Library -->
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAf1282ikjQ7MUSP4fKrGQjRTAb1kDWUV8",
            authDomain: "quiz-app-5b02d.firebaseapp.com",
            projectId: "quiz-app-5b02d",
            storageBucket: "quiz-app-5b02d.firebasestorage.app",
            messagingSenderId: "345835769588",
            appId: "1:345835769588:web:702129bc15f30f3d5f18a1"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // App Data
        const lessons = [
            { id: 1, title: "ET හැඳින්වීම", image: "https://source.unsplash.com/random/600x400/?engineering,technology", questions: 10 },
            { id: 2, title: "ඉංජිනේරු ඇඳීම Drawing", image: "https://source.unsplash.com/random/600x400/?drawing,technical", questions: 15 },
            { id: 3, title: "නිෂ්පාදන තාක්ෂණවේදය Production", image: "https://source.unsplash.com/random/600x400/?production,manufacturing", questions: 12 },
            { id: 4, title: "ගොඩනැගිලි තාක්ෂණවේදය", image: "https://source.unsplash.com/random/600x400/?construction,building", questions: 14 },
            { id: 5, title: "යන්ත්‍ර වල බල සම්ප්‍රේෂණය හා චලිත හැසිරීම්", image: "https://source.unsplash.com/random/600x400/?machinery,mechanical", questions: 18 },
            { id: 6, title: "ඉංජිනේරු ආරක්ෂාව Safety", image: "https://source.unsplash.com/random/600x400/?safety,helmet", questions: 10 },
            { id: 7, title: "ස්වයංචල තාක්ෂණය Automobile", image: "https://source.unsplash.com/random/600x400/?car,automobile", questions: 16 },
            { id: 8, title: "විදුලි තාක්ෂණවේදය Electrical", image: "https://source.unsplash.com/random/600x400/?electricity,wires", questions: 15 },
            { id: 9, title: "ඒකක හා මිනුම්", image: "https://source.unsplash.com/random/600x400/?measurement,tools", questions: 12 },
            { id: 10, title: "විදුලි යන්ත්‍ර හා බල පද්ධති (මෝටර් පාඩම)", image: "https://source.unsplash.com/random/600x400/?motor,engine", questions: 20 },
            { id: 11, title: "ප්‍රමිති හා පිරිවිතර", image: "https://source.unsplash.com/random/600x400/?standards,quality", questions: 10 },
            { id: 12, title: "බිම් මැනුම්", image: "https://source.unsplash.com/random/600x400/?surveying,land", questions: 14 },
            { id: 13, title: "තරල යන්‍ත්‍ර", image: "https://source.unsplash.com/random/600x400/?fluid,hydraulics", questions: 16 },
            { id: 14, title: "ඉලෙක්ට්‍රොනික් තාක්ෂණය", image: "https://source.unsplash.com/random/600x400/?electronics,circuit", questions: 18 },
            { id: 15, title: "ජල සම්පාදනය හා කසල අපහනය", image: "https://source.unsplash.com/random/600x400/?water,waste", questions: 12 },
            { id: 16, title: "ප්‍රමාණ බිල්පත් සැකසීම ඇස්තමේන්තුකරණය (TDS BOQ)", image: "https://source.unsplash.com/random/600x400/?invoice,accounting", questions: 15 },
            { id: 17, title: "ව්‍යවසායකත්වය හා කළමනාකරණය", image: "https://source.unsplash.com/random/600x400/?business,management", questions: 10 }
        ];

        const levelsPerLesson = 20;
        const quizTimeLimit = 35 * 60; // 35 minutes in seconds
        const googleFormsBaseUrl = "https://docs.google.com/forms/d/e/";

        // These would be replaced with actual form IDs for each level
        const formIds = Array(17).fill().map(() => 
            Array(20).fill().map(() => 
                "1FAIpQLS" + Math.random().toString(36).substring(2, 15) + "/viewform"
            )
        );

        // DOM Elements
        const lessonsGrid = document.getElementById('lessonsGrid');
        const authModal = document.getElementById('authModal');
        const authModalTitle = document.getElementById('authModalTitle');
        const authModalClose = document.getElementById('authModalClose');
        const authForm = document.getElementById('authForm');
        const authEmail = document.getElementById('authEmail');
        const authPassword = document.getElementById('authPassword');
        const authName = document.getElementById('authName');
        const authNameGroup = document.getElementById('authNameGroup');
        const authToggleText = document.getElementById('authToggleText');
        const authToggleLink = document.getElementById('authToggleLink');
        const authCancelBtn = document.getElementById('authCancelBtn');
        const authSubmitBtn = document.getElementById('authSubmitBtn');
        const quizModal = document.getElementById('quizModal');
        const quizTitle = document.getElementById('quizTitle');
        const quizLevel = document.getElementById('quizLevel');
        const quizTimer = document.getElementById('quizTimer');
        const timeRemaining = document.getElementById('timeRemaining');
        const quizIframe = document.getElementById('quizIframe');
        const profileBtn = document.getElementById('profileBtn');
        const profileSection = document.getElementById('profileSection');
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        const profilePic = document.getElementById('profilePic');
        const completedLessons = document.getElementById('completedLessons');
        const completedLevels = document.getElementById('completedLevels');
        const memberSince = document.getElementById('memberSince');
        const logoutBtn = document.getElementById('logoutBtn');
        const deleteAccountBtn = document.getElementById('deleteAccountBtn');
        const authIndicator = document.getElementById('authIndicator');
        const userAvatar = document.getElementById('userAvatar');
        const authText = document.getElementById('authText');
        const fabWhatsapp = document.getElementById('fabWhatsapp');
        const fabPapers = document.getElementById('fabPapers');
        const fabMenu = document.getElementById('fabMenu');
        const fabDropdown = document.getElementById('fabDropdown');
        const progressBar = document.getElementById('progressBar');
        const spinner = document.getElementById('spinner');
        const toast = document.getElementById('toast');
        const dayGreeting = document.getElementById('dayGreeting');
        const greetingText = document.getElementById('greetingText');
        const verificationModal = document.getElementById('verificationModal');
        const verificationInputs = document.getElementById('verificationInputs');
        const verifyCodeBtn = document.getElementById('verifyCodeBtn');
        const resendBtn = document.getElementById('resendBtn');
        const countdown = document.getElementById('countdown');
        const studentInfoModal = document.getElementById('studentInfoModal');
        const studentForm = document.getElementById('studentForm');
        const formEmail = document.getElementById('formEmail');
        const termsModal = document.getElementById('termsModal');
        const agreeTerms = document.getElementById('agreeTerms');
        const acceptTermsBtn = document.getElementById('acceptTermsBtn');
        const declineTermsBtn = document.getElementById('declineTermsBtn');
        const quizCloseBtn = document.getElementById('quizCloseBtn');
        const confirmExitModal = document.getElementById('confirmExitModal');
        const cancelExitBtn = document.getElementById('cancelExitBtn');
        const confirmExitBtn = document.getElementById('confirmExitBtn');
        const formPreloader = document.getElementById('formPreloader');
        const rememberMe = document.getElementById('rememberMe');

        // App State
        let currentUser = null;
        let isSignUp = false;
        let currentLesson = null;
        let currentLevel = null;
        let timerInterval = null;
        let timeLeft = quizTimeLimit;
        let completedLevelsData = {};
        let users = {};
        let isProfileVisible = false;
        let generatedCode = "";
        let phoneNumber = "";
        let resendAttempts = 0;
        let countdownInterval = null;
        let countdownTime = 120; // 2 minutes in seconds
        let hasAcceptedTerms = localStorage.getItem('hasAcceptedTerms') === 'true';
        let isVerificationInProgress = false;

        // Initialize the app
        function init() {
            renderLessons();
            setupEventListeners();
            checkAuthState();
            setupScrollProgress();
            setupDayGreeting();
            
            // Initialize particles.js
            particlesJS('particles-js', {
                particles: {
                    number: { value: 80, density: { enable: true, value_area: 800 } },
                    color: { value: "#ffffff" },
                    shape: { type: "circle" },
                    opacity: { value: 0.5, random: true },
                    size: { value: 3, random: true },
                    line_linked: { enable: true, distance: 150, color: "#ffffff", opacity: 0.4, width: 1 },
                    move: { enable: true, speed: 2, direction: "none", random: true, straight: false, out_mode: "out" }
                },
                interactivity: {
                    detect_on: "canvas",
                    events: {
                        onhover: { enable: true, mode: "repulse" },
                        onclick: { enable: true, mode: "push" }
                    }
                }
            });

            // Check if terms need to be shown
            if (!hasAcceptedTerms && currentUser) {
                setTimeout(() => {
                    termsModal.classList.add('show');
                    document.body.style.overflow = 'hidden';
                }, 1000);
            }
        }

        // Set up day greeting
        function setupDayGreeting() {
            const hour = new Date().getHours();
            let greeting = "";
            let icon = "";
            
            if (hour < 12) {
                greeting = "Good Morning";
                icon = "fa-sun";
            } else if (hour < 18) {
                greeting = "Good Afternoon";
                icon = "fa-sun";
            } else {
                greeting = "Good Evening";
                icon = "fa-moon";
            }
            
            greetingText.textContent = greeting;
            dayGreeting.querySelector('i').className = `fas ${icon}`;
        }

        // Render lessons grid
        function renderLessons() {
            lessonsGrid.innerHTML = '';
            
            lessons.forEach(lesson => {
                const lessonCard = document.createElement('div');
                lessonCard.className = 'lesson-card';
                lessonCard.innerHTML = `
                    <img src="${lesson.image}" alt="${lesson.title}" class="lesson-image">
                    <div class="lesson-content">
                        <h3 class="lesson-title">${lesson.title}</h3>
                        <div class="lesson-meta">
                            <span><i class="fas fa-question-circle"></i> ${lesson.questions} Questions</span>
                            <span><i class="fas fa-clock"></i> 35 Minutes</span>
                        </div>
                        <div class="lesson-levels" id="levels-${lesson.id}"></div>
                    </div>
                `;
                
                lessonsGrid.appendChild(lessonCard);
                renderLevels(lesson.id);
            });
        }

        // Render levels for a lesson
        function renderLevels(lessonId) {
            const levelsContainer = document.getElementById(`levels-${lessonId}`);
            levelsContainer.innerHTML = '';
            
            for (let i = 1; i <= levelsPerLesson; i++) {
                const levelBtn = document.createElement('button');
                levelBtn.className = 'level-btn';
                levelBtn.textContent = `Level ${i}`;
                levelBtn.dataset.lesson = lessonId;
                levelBtn.dataset.level = i;
                
                // Check if level is completed
                const isCompleted = completedLevelsData[`${lessonId}-${i}`] || false;
                if (isCompleted) {
                    levelBtn.classList.add('completed');
                } else if (i === 1) {
                    levelBtn.classList.add('active');
                }
                
                // Lock levels beyond 1 for guests
                if (!currentUser && i > 1) {
                    levelBtn.classList.add('locked');
                }
                
                levelBtn.addEventListener('click', () => handleLevelClick(lessonId, i));
                levelsContainer.appendChild(levelBtn);
            }
        }

        // Handle level click
        function handleLevelClick(lessonId, level) {
            if (!currentUser && level > 1) {
                showToast('Please sign up or log in to access this level', 'warning');
                showAuthModal();
                return;
            }
            
            currentLesson = lessonId;
            currentLevel = level;
            
            // Set quiz details
            const lesson = lessons.find(l => l.id === lessonId);
            quizTitle.textContent = lesson.title;
            quizLevel.textContent = `Level ${level}`;
            
            // Reset timer
            timeLeft = quizTimeLimit;
            updateTimerDisplay();
            
            // Show preloader
            formPreloader.style.display = 'block';
            quizIframe.style.display = 'none';
            
            // Show quiz modal
            quizModal.classList.add('show');
            document.body.style.overflow = 'hidden';
            
            // Load Google Form after a short delay to show preloader
            setTimeout(() => {
                quizIframe.src = googleFormsBaseUrl + formIds[lessonId-1][level-1];
                quizIframe.onload = () => {
                    formPreloader.style.display = 'none';
                    quizIframe.style.display = 'block';
                };
            }, 500);
            
            // Start timer
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
        }

        // Update timer
        function updateTimer() {
            timeLeft--;
            updateTimerDisplay();
            
            // Show warnings at specific time intervals
            if (timeLeft === 15 * 60) {
                showToast('15 minutes remaining!', 'warning');
            } else if (timeLeft === 10 * 60) {
                showToast('10 minutes remaining!', 'warning');
            } else if (timeLeft === 5 * 60) {
                showToast('5 minutes remaining! Hurry up!', 'warning');
            }
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                showToast('Time is up! Quiz will be submitted automatically.', 'error');
                setTimeout(() => {
                    quizModal.classList.remove('show');
                    document.body.style.overflow = '';
                }, 3000);
                
                // Mark as completed if not already
                if (!completedLevelsData[`${currentLesson}-${currentLevel}`]) {
                    completedLevelsData[`${currentLesson}-${currentLevel}`] = true;
                    saveCompletedLevels();
                    renderLevels(currentLesson);
                    updateProfileStats();
                }
            }
        }

        // Update timer display
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timeRemaining.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            
            // Change color based on time remaining
            if (timeLeft <= 60) {
                quizTimer.classList.add('timer-danger');
                quizTimer.classList.remove('timer-warning');
            } else if (timeLeft <= 300) {
                quizTimer.classList.add('timer-warning');
                quizTimer.classList.remove('timer-danger');
            } else {
                quizTimer.classList.remove('timer-warning', 'timer-danger');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Auth modal
            authModalClose.addEventListener('click', (e) => {
                if (isVerificationInProgress) {
                    e.preventDefault();
                    showToast('Please complete the verification process', 'warning');
                    return;
                }
                authModal.classList.remove('show');
                document.body.style.overflow = '';
            });
            
            authCancelBtn.addEventListener('click', (e) => {
                if (isVerificationInProgress) {
                    e.preventDefault();
                    showToast('Please complete the verification process', 'warning');
                    return;
                }
                authModal.classList.remove('show');
                document.body.style.overflow = '';
            });
            
            authToggleLink.addEventListener('click', (e) => {
                e.preventDefault();
                toggleAuthMode();
            });
            
            authSubmitBtn.addEventListener('click', handleAuthSubmit);
            
            // Quiz modal close (click outside)
            quizModal.addEventListener('click', (e) => {
                if (e.target === quizModal) {
                    showConfirmExitModal();
                }
            });
            
            // Quiz close button
            quizCloseBtn.addEventListener('click', () => {
                showConfirmExitModal();
            });
            
            // Confirm exit modal
            cancelExitBtn.addEventListener('click', () => {
                confirmExitModal.classList.remove('show');
            });
            
            confirmExitBtn.addEventListener('click', () => {
                clearInterval(timerInterval);
                quizModal.classList.remove('show');
                confirmExitModal.classList.remove('show');
                document.body.style.overflow = '';
            });
            
            // Profile button
            profileBtn.addEventListener('click', toggleProfile);
            
            // Logout button
            logoutBtn.addEventListener('click', handleLogout);
            
            // Delete account button
            deleteAccountBtn.addEventListener('click', handleDeleteAccount);
            
            // Auth indicator
            authIndicator.addEventListener('click', () => {
                if (currentUser) {
                    toggleProfile();
                } else {
                    showAuthModal();
                }
            });
            
            // Floating action buttons
            fabWhatsapp.addEventListener('click', () => {
                window.open('https://chat.whatsapp.com/yourgroup', '_blank');
            });
            
            fabPapers.addEventListener('click', () => {
                window.open('https://etpanthiya.lk/papers', '_blank');
            });
            
            fabMenu.addEventListener('click', toggleFabDropdown);
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!fabMenu.contains(e.target) && !fabDropdown.contains(e.target)) {
                    fabDropdown.classList.remove('show');
                }
            });
            
            // Verification code inputs
            const codeInputs = verificationInputs.querySelectorAll('.verification-code-input');
            codeInputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value.length === 1) {
                        if (index < codeInputs.length - 1) {
                            codeInputs[index + 1].focus();
                        } else {
                            verifyCodeBtn.focus();
                        }
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && e.target.value.length === 0 && index > 0) {
                        codeInputs[index - 1].focus();
                    }
                });
            });
            
            verifyCodeBtn.addEventListener('click', verifyCode);
            resendBtn.addEventListener('click', resendCode);
            
            // Terms modal
            agreeTerms.addEventListener('change', (e) => {
                acceptTermsBtn.disabled = !e.target.checked;
            });
            
            acceptTermsBtn.addEventListener('click', () => {
                hasAcceptedTerms = true;
                localStorage.setItem('hasAcceptedTerms', 'true');
                termsModal.classList.remove('show');
                document.body.style.overflow = '';
                showToast('Thank you for accepting our terms!', 'success');
            });
            
            declineTermsBtn.addEventListener('click', () => {
                auth.signOut();
                currentUser = null;
                updateAuthState();
                termsModal.classList.remove('show');
                document.body.style.overflow = '';
                showToast('You must accept the terms to use this service', 'error');
            });
            
            // Remember me checkbox
            rememberMe.addEventListener('change', (e) => {
                localStorage.setItem('rememberMe', e.target.checked);
            });
        }

        // Toggle FAB dropdown
        function toggleFabDropdown() {
            fabDropdown.classList.toggle('show');
        }

        // Toggle auth mode between sign in and sign up
        function toggleAuthMode() {
            isSignUp = !isSignUp;
            
            if (isSignUp) {
                authModalTitle.textContent = 'Sign Up';
                authSubmitBtn.textContent = 'Sign Up';
                authToggleText.innerHTML = 'Already have an account? <a href="#" id="authToggleLink">Sign in</a>';
                authNameGroup.style.display = 'block';
            } else {
                authModalTitle.textContent = 'Sign In';
                authSubmitBtn.textContent = 'Sign In';
                authToggleText.innerHTML = 'Don\'t have an account? <a href="#" id="authToggleLink">Sign up</a>';
                authNameGroup.style.display = 'none';
            }
        }

        // Handle auth form submission
        async function handleAuthSubmit() {
            const email = authEmail.value.trim();
            const password = authPassword.value.trim();
            const name = authName.value.trim();
            
            if (!email || !password) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            if (isSignUp && !name) {
                showToast('Please enter your name', 'error');
                return;
            }
            
            showSpinner();
            
            try {
                if (isSignUp) {
                    // Sign up with Firebase
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await userCredential.user.updateProfile({ displayName: name });
                    
                    // Save additional user data to database
                    await database.ref('users/' + userCredential.user.uid).set({
                        name: name,
                        email: email,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    currentUser = {
                        uid: userCredential.user.uid,
                        email: email,
                        name: name,
                        joined: new Date().toISOString()
                    };
                    
                    showToast('Account created successfully!', 'success');
                    
                    // Show phone verification
                    showVerificationModal();
                    isVerificationInProgress = true;
                } else {
                    // Sign in with Firebase
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    
                    // Get user data from database
                    const snapshot = await database.ref('users/' + userCredential.user.uid).once('value');
                    const userData = snapshot.val();
                    
                    currentUser = {
                        uid: userCredential.user.uid,
                        email: userCredential.user.email,
                        name: userCredential.user.displayName || userData.name,
                        joined: userData.createdAt ? new Date(userData.createdAt).toISOString() : new Date().toISOString()
                    };
                    
                    showToast('Signed in successfully!', 'success');
                    
                    // Load completed levels
                    loadCompletedLevels();
                }
                
                updateAuthState();
                
                if (!isSignUp) {
                    authModal.classList.remove('show');
                    document.body.style.overflow = '';
                }
            } catch (error) {
                console.error('Authentication error:', error);
                let errorMessage = 'Authentication failed. ';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage += 'Email already in use.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage += 'Invalid email address.';
                        break;
                    case 'auth/weak-password':
                        errorMessage += 'Password should be at least 6 characters.';
                        break;
                    case 'auth/user-not-found':
                        errorMessage += 'User not found.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage += 'Wrong password.';
                        break;
                    default:
                        errorMessage += 'Please try again.';
                }
                
                showToast(errorMessage, 'error');
            } finally {
                hideSpinner();
            }
        }

        // Show verification modal
        function showVerificationModal() {
            // Clear any previous inputs
            const inputs = verificationInputs.querySelectorAll('.verification-code-input');
            inputs.forEach(input => input.value = '');
            
            // Reset resend button
            resendAttempts = 0;
            resendBtn.classList.remove('active');
            
            // Start countdown
            startCountdown();
            
            // Generate verification code
            generatedCode = Math.floor(100000 + Math.random() * 900000).toString();
            console.log('Generated code:', generatedCode); // For testing only
            
            // Show modal
            verificationModal.classList.add('show');
            
            // Focus first input
            inputs[0].focus();
        }

        // Start countdown timer
        function startCountdown() {
            countdownTime = 120; // 2 minutes
            updateCountdownDisplay();
            
            if (countdownInterval) clearInterval(countdownInterval);
            
            countdownInterval = setInterval(() => {
                countdownTime--;
                updateCountdownDisplay();
                
                if (countdownTime <= 0) {
                    clearInterval(countdownInterval);
                    resendBtn.classList.add('active');
                }
            }, 1000);
        }

        // Update countdown display
        function updateCountdownDisplay() {
            const minutes = Math.floor(countdownTime / 60);
            const seconds = countdownTime % 60;
            countdown.textContent = `Resend code in ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        // Verify entered code
        function verifyCode() {
            const inputs = verificationInputs.querySelectorAll('.verification-code-input');
            let enteredCode = '';
            
            inputs.forEach(input => {
                enteredCode += input.value;
            });
            
            if (enteredCode.length !== 6) {
                showToast('Please enter a 6-digit code', 'error');
                return;
            }
            
            if (enteredCode === generatedCode) {
                clearInterval(countdownInterval);
                verificationModal.classList.remove('show');
                showToast('Phone number verified successfully!', 'success');
                isVerificationInProgress = false;
                
                // Show student info form
                showStudentInfoModal();
            } else {
                showToast('Invalid verification code', 'error');
            }
        }

        // Resend verification code
        function resendCode() {
            if (resendAttempts >= 3) {
                showToast('Maximum resend attempts reached', 'error');
                return;
            }
            
            resendAttempts++;
            showToast(`New code sent (attempt ${resendAttempts}/3)`, 'success');
            
            // Generate new code
            generatedCode = Math.floor(100000 + Math.random() * 900000).toString();
            console.log('New generated code:', generatedCode); // For testing only
            
            // Reset countdown
            startCountdown();
            resendBtn.classList.remove('active');
        }

        // Show student info modal
        function showStudentInfoModal() {
            formEmail.value = currentUser.email;
            studentInfoModal.classList.add('show');
        }

        // Show auth modal
        function showAuthModal() {
            isSignUp = false;
            authModalTitle.textContent = 'Sign In';
            authSubmitBtn.textContent = 'Sign In';
            authToggleText.innerHTML = 'Don\'t have an account? <a href="#" id="authToggleLink">Sign up</a>';
            authNameGroup.style.display = 'none';
            
            authEmail.value = '';
            authPassword.value = '';
            authName.value = '';
            
            authModal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        // Check auth state
        function checkAuthState() {
            // Check remember me
            const remember = localStorage.getItem('rememberMe') === 'true';
            rememberMe.checked = remember;
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in
                    const snapshot = await database.ref('users/' + user.uid).once('value');
                    const userData = snapshot.val();
                    
                    currentUser = {
                        uid: user.uid,
                        email: user.email,
                        name: user.displayName || userData.name,
                        joined: userData.createdAt ? new Date(userData.createdAt).toISOString() : new Date().toISOString()
                    };
                    
                    // Load completed levels
                    loadCompletedLevels();
                    
                    updateAuthState();
                } else {
                    // User is signed out
                    currentUser = null;
                    updateAuthState();
                }
            });
        }

        // Load completed levels from Firebase
        async function loadCompletedLevels() {
            if (!currentUser) return;
            
            try {
                const snapshot = await database.ref('completedLevels/' + currentUser.uid).once('value');
                completedLevelsData = snapshot.val() || {};
                renderLessons();
                updateProfileStats();
            } catch (error) {
                console.error('Error loading completed levels:', error);
            }
        }

        // Save completed levels to Firebase
        async function saveCompletedLevels() {
            if (!currentUser) return;
            
            try {
                await database.ref('completedLevels/' + currentUser.uid).set(completedLevelsData);
            } catch (error) {
                console.error('Error saving completed levels:', error);
            }
        }

        // Update auth state UI
        function updateAuthState() {
            if (currentUser) {
                // Update auth indicator
                authText.textContent = currentUser.name.split(' ')[0];
                userAvatar.textContent = currentUser.name.charAt(0).toUpperCase();
                
                // Update profile section
                profileName.textContent = currentUser.name;
                profileEmail.textContent = currentUser.email;
                profilePic.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name)}&background=${encodeURIComponent('4361ee')}&color=fff`;
                
                // Update completed levels stats
                updateProfileStats();
                
                // Store current user ID
                localStorage.setItem('currentUser', currentUser.uid);
            } else {
                authText.textContent = 'Guest';
                userAvatar.textContent = 'G';
                profileSection.style.display = 'none';
                localStorage.removeItem('currentUser');
            }
            
            // Re-render levels to update locked state
            renderLessons();
        }

        // Update profile stats
        function updateProfileStats() {
            if (!currentUser) return;
            
            // Calculate completed lessons and levels
            const completedLevelsCount = Object.keys(completedLevelsData).length;
            const completedLessonsCount = new Set(
                Object.keys(completedLevelsData).map(key => key.split('-')[0])
            ).size;
            
            completedLessons.textContent = `${completedLessonsCount}/${lessons.length}`;
            completedLevels.textContent = `${completedLevelsCount}/${lessons.length * levelsPerLesson}`;
            memberSince.textContent = new Date(currentUser.joined).toLocaleDateString();
            document.getElementById('accountStatus').textContent = 'Verified';
        }

        // Toggle profile visibility
        function toggleProfile() {
            if (!currentUser) {
                showAuthModal();
                return;
            }
            
            isProfileVisible = !isProfileVisible;
            profileSection.style.display = isProfileVisible ? 'block' : 'none';
            
            if (isProfileVisible) {
                updateProfileStats();
            }
        }

        // Handle logout
        function handleLogout() {
            auth.signOut();
            currentUser = null;
            updateAuthState();
            showToast('You have been logged out', 'success');
            profileSection.style.display = 'none';
            isProfileVisible = false;
        }

        // Handle delete account
        async function handleDeleteAccount() {
            if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                return;
            }
            
            showSpinner();
            
            try {
                // Delete user from Firebase Auth
                await auth.currentUser.delete();
                
                // Delete user data from database
                await database.ref('users/' + currentUser.uid).remove();
                await database.ref('completedLevels/' + currentUser.uid).remove();
                
                currentUser = null;
                updateAuthState();
                showToast('Your account has been deleted', 'success');
                profileSection.style.display = 'none';
            } catch (error) {
                console.error('Error deleting account:', error);
                showToast('Failed to delete account. Please reauthenticate.', 'error');
            } finally {
                hideSpinner();
            }
        }

        // Show confirm exit modal
        function showConfirmExitModal() {
            confirmExitModal.classList.add('show');
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Show loading spinner
        function showSpinner() {
            spinner.classList.add('show');
        }

        // Hide loading spinner
        function hideSpinner() {
            spinner.classList.remove('show');
        }

        // Setup scroll progress bar
        function setupScrollProgress() {
            window.addEventListener('scroll', () => {
                const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
                const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                const scrolled = (winScroll / height) * 100;
                progressBar.style.width = scrolled + '%';
            });
        }

        // Initialize the app
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
