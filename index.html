<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ET Panthiya.lk Quiz Portal 2025</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <style>
        :root {
            --primary: #6c5ce7;
            --primary-dark: #5649c7;
            --secondary: #a29bfe;
            --accent: #fd79a8;
            --dark: #2d3436;
            --light: #f5f6fa;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #d63031;
            --info: #0984e3;
            --card-bg: rgba(255, 255, 255, 0.9);
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            --border-radius: 12px;
            --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            background-attachment: fixed;
        }

        /* Preloader Styles */
        .preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .preloader.fade-out {
            opacity: 0;
        }

        .loader {
            width: 80px;
            height: 80px;
            position: relative;
        }

        .loader div {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent);
            animation: load 1.2s linear infinite;
        }

        .loader div:nth-child(1) {
            top: 8px;
            left: 8px;
            animation-delay: 0s;
        }

        .loader div:nth-child(2) {
            top: 8px;
            left: 32px;
            animation-delay: -0.4s;
        }

        .loader div:nth-child(3) {
            top: 8px;
            left: 56px;
            animation-delay: -0.8s;
        }

        .loader div:nth-child(4) {
            top: 32px;
            left: 8px;
            animation-delay: -0.4s;
        }

        .loader div:nth-child(5) {
            top: 32px;
            left: 32px;
            animation-delay: -0.8s;
        }

        .loader div:nth-child(6) {
            top: 32px;
            left: 56px;
            animation-delay: -1.2s;
        }

        .loader div:nth-child(7) {
            top: 56px;
            left: 8px;
            animation-delay: -0.8s;
        }

        .loader div:nth-child(8) {
            top: 56px;
            left: 32px;
            animation-delay: -1.2s;
        }

        .loader div:nth-child(9) {
            top: 56px;
            left: 56px;
            animation-delay: -1.6s;
        }

        @keyframes load {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(0.5);
                opacity: 0.5;
            }
        }

        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 18px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* Quiz Preloader Styles */
.quiz-preloader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 1007; /* Higher than other elements */
    backdrop-filter: blur(5px);
}

.quiz-loader {
    width: 80px;
    height: 80px;
    position: relative;
}

.quiz-loader div {
    position: absolute;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--accent);
    animation: load 1.2s linear infinite;
}

.quiz-loader div:nth-child(1) {
    top: 8px;
    left: 8px;
    animation-delay: 0s;
}

.quiz-loader div:nth-child(2) {
    top: 8px;
    left: 32px;
    animation-delay: -0.4s;
}

.quiz-loader div:nth-child(3) {
    top: 8px;
    left: 56px;
    animation-delay: -0.8s;
}

.quiz-loader div:nth-child(4) {
    top: 32px;
    left: 8px;
    animation-delay: -0.4s;
}

.quiz-loader div:nth-child(5) {
    top: 32px;
    left: 32px;
    animation-delay: -0.8s;
}

.quiz-loader div:nth-child(6) {
    top: 32px;
    left: 56px;
    animation-delay: -1.2s;
}

.quiz-loader div:nth-child(7) {
    top: 56px;
    left: 8px;
    animation-delay: -0.8s;
}

.quiz-loader div:nth-child(8) {
    top: 56px;
    left: 32px;
    animation-delay: -1.2s;
}

.quiz-loader div:nth-child(9) {
    top: 56px;
    left: 56px;
    animation-delay: -1.6s;
}

.quiz-loading-text {
    color: white;
    margin-top: 20px;
    font-size: 18px;
    letter-spacing: 2px;
    text-transform: uppercase;
}

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
            display: none;
        }

        .container.show {
            opacity: 1;
            transform: translateY(0);
            display: block;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            color: white;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            font-weight: 800;
            background: linear-gradient(to right, #fff, #a29bfe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: var(--light);
            font-size: 1.1rem;
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .logo-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 4px solid white;
            margin: 0 auto 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(255,255,255,0.2);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .logo-circle img {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
        }

        /* Banner */
        .banner {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 30px;
            color: white;
            text-align: center;
            box-shadow: var(--box-shadow);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .banner h2 {
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .banner p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .updated-date {
            font-size: 0.9rem;
            margin-top: 5px;
            color: rgba(255,255,255,0.7);
            font-style: italic;
        }

        /* Lessons Grid */
        .lessons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .lesson-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
            border: none;
        }

        .lesson-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .lesson-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, var(--primary), var(--accent));
        }

        .lesson-card .lesson-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 3px solid var(--light);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .lesson-card h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .lesson-card p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .lesson-meta {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .time-indicator, .question-count {
            display: inline-block;
            background: rgba(108, 92, 231, 0.1);
            color: var(--primary);
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .btn-start-quiz {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
            width: 100%;
        }

        .btn-start-quiz:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(108, 92, 231, 0.4);
        }

        /* Level Selection Modal */
        .level-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1006;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .level-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--box-shadow);
            transform: scale(0.9);
            opacity: 0;
            transition: var(--transition);
            overflow: hidden;
        }

        .level-modal.show .level-content {
            transform: scale(1);
            opacity: 1;
        }

        .level-header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .level-header h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .level-header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .level-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .levels-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .level-btn {
            background: #f5f6fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .level-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .level-btn.completed {
            background: rgba(0, 184, 148, 0.1);
            border-color: var(--success);
        }

        .level-btn.completed::after {
            content: '✓';
            position: absolute;
            top: 2px;
            right: 5px;
            color: var(--success);
            font-weight: bold;
        }

        .level-btn.locked {
            background: rgba(214, 48, 49, 0.1);
            border-color: var(--danger);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .level-btn.locked::after {
            content: '🔒';
            position: absolute;
            top: 2px;
            right: 5px;
        }

        .level-footer {
            text-align: center;
            padding: 15px;
            border-top: 1px solid #eee;
        }

        .btn-close-levels {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-close-levels:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        /* Progress circle */
        .progress-circle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #f0f0f0;
        }

        .progress-circle::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid #e0e0e0;
        }

        .progress-circle-fill {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            clip: rect(0, 12px, 24px, 0);
            background: var(--success);
            transform: rotate(0deg);
        }

        /* Level lock indicator */
        .level-lock {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--danger);
        }

        /* Auth Modals */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: flex-start;
            backdrop-filter: blur(5px);
            overflow-y: auto;
            padding: 20px 0;
        }

        .auth-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--box-shadow);
            transform: scale(0.9);
            opacity: 0;
            transition: var(--transition);
            overflow: hidden;
            margin: 20px 0;
            position: relative;
        }

        .auth-modal.show .auth-content {
            transform: scale(1);
            opacity: 1;
        }

        .auth-header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .auth-header h2 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .auth-header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .auth-body {
            padding: 30px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .auth-tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: var(--transition);
            border-bottom: 3px solid transparent;
        }

        .auth-tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
            outline: none;
        }

        .remember-me {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .remember-me input {
            margin-right: 10px;
            width: 20px;
            height: 20px;
        }

        .phone-input {
            display: flex;
            align-items: center;
        }

        .phone-input .prefix {
            background: #f5f6fa;
            padding: 12px;
            border: 1px solid #ddd;
            border-right: none;
            border-radius: 8px 0 0 8px;
            font-weight: 600;
        }

        .phone-input input {
            border-radius: 0 8px 8px 0 !important;
        }

        .btn-auth {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
            margin-top: 10px;
        }

        .btn-auth:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(108, 92, 231, 0.4);
        }

        .auth-footer {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .auth-footer a {
            color: var(--primary);
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
        }

        .otp-container {
            display: none;
        }

        .otp-inputs {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .otp-inputs input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 1.2rem;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .otp-inputs input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
        }

        .resend-otp {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .resend-otp a {
            color: var(--primary);
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
        }

        .resend-otp a.disabled {
            color: var(--text-secondary);
            pointer-events: none;
        }

        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Student Details Modal */
        .student-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1001;
            justify-content: center;
            align-items: flex-start;
            backdrop-filter: blur(5px);
            overflow-y: auto;
            padding: 20px 0;
        }

        .student-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--box-shadow);
            transform: scale(0.9);
            opacity: 0;
            transition: var(--transition);
            overflow: hidden;
            margin: 20px 0;
        }

        .student-modal.show .student-content {
            transform: scale(1);
            opacity: 1;
        }

        .student-header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .student-header h2 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .student-header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .student-body {
            padding: 30px;
        }

        /* Terms Modal */
        .terms-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1002;
            justify-content: center;
            align-items: flex-start;
            backdrop-filter: blur(5px);
            overflow-y: auto;
            padding: 20px 0;
        }

        .terms-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--box-shadow);
            transform: scale(0.9);
            opacity: 0;
            transition: var(--transition);
            overflow: hidden;
            margin: 20px 0;
        }

        .terms-modal.show .terms-content {
            transform: scale(1);
            opacity: 1;
        }

        .terms-header {
            background: var(--warning);
            color: var(--dark);
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .terms-header h2 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .terms-body {
            padding: 30px;
            color: var(--text-primary);
            max-height: 300px;
            overflow-y: auto;
        }

        .terms-body p {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .terms-checkbox {
            display: flex;
            align-items: center;
            margin: 20px 0;
        }

        .terms-checkbox input {
            margin-right: 10px;
            width: 20px;
            height: 20px;
        }

        .btn-terms {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
            margin-top: 10px;
        }

        .btn-terms:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(108, 92, 231, 0.4);
        }

        .btn-terms:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Quiz Container */
        .quiz-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1003;
            flex-direction: column;
        }

        .quiz-header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .quiz-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .timer {
            background: rgba(0, 0, 0, 0.2);
            padding: 5px 15px;
            border-radius: 50px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .timer i {
            margin-right: 8px;
        }

        .quiz-iframe {
            flex: 1;
            border: none;
            width: 100%;
        }

        .btn-close-quiz {
            background: var(--danger);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            margin-left: 15px;
        }

        .btn-close-quiz:hover {
            transform: rotate(90deg);
        }

        /* Alert Modal */
        .alert-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1004;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .alert-content {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: var(--box-shadow);
            transform: scale(0.9);
            opacity: 0;
            transition: var(--transition);
        }

        .alert-modal.show .alert-content {
            transform: scale(1);
            opacity: 1;
        }

        .alert-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .alert-icon.warning {
            color: var(--warning);
        }

        .alert-icon.danger {
            color: var(--danger);
        }

        .alert-title {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .alert-message {
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .btn-alert {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-block;
        }

        .btn-alert:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4);
        }

        /* Welcome Modal */
        .welcome-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1005;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .welcome-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--box-shadow);
            transform: scale(0.9);
            opacity: 0;
            transition: var(--transition);
            overflow: hidden;
        }

        .welcome-modal.show .welcome-content {
            transform: scale(1);
            opacity: 1;
        }

        .welcome-header {
            height: 150px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .welcome-header img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid white;
            object-fit: cover;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .welcome-body {
            padding: 30px;
            text-align: center;
        }

        .welcome-body h2 {
            color: var(--primary);
            margin-bottom: 15px;
        }

        .welcome-body p {
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* Floating Notification */
        .notification {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--dark);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            z-index: 999;
            transform: translateX(150%);
            transition: var(--transition);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .notification.warning {
            background: var(--warning);
            color: var(--dark);
        }

        .notification.danger {
            background: var(--danger);
        }

        .notification.success {
            background: var(--success);
        }

        /* WhatsApp Floating Button */
        .whatsapp-float {
            position: fixed;
            bottom: 120px;
            left: 30px;
            width: 60px;
            height: 60px;
            background: #25D366;
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            z-index: 999;
            cursor: pointer;
            transition: var(--transition);
            animation: pulse-whatsapp 2s infinite;
        }

        .whatsapp-float:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        /* Quick Actions Dropdown */
        .quick-actions {
            position: fixed;
            bottom: 200px;
            left: 30px;
            z-index: 999;
        }

        .quick-actions-btn {
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: var(--transition);
        }

        .quick-actions-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .quick-actions-menu {
            position: absolute;
            bottom: 70px;
            left: 0;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 200px;
            transform: scale(0.9);
            opacity: 0;
            transition: var(--transition);
            pointer-events: none;
            z-index: 1000;
        }

        .quick-actions-menu.show {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }

        .quick-actions-menu a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: var(--text-primary);
            text-decoration: none;
            transition: var(--transition);
        }

        .quick-actions-menu a:hover {
            background: #f5f6fa;
        }

        .quick-actions-menu a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* Papers Floating Button */
        .papers-float {
            position: fixed;
            bottom: 60px;
            left: 30px;
            width: 60px;
            height: 60px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            z-index: 999;
            cursor: pointer;
            transition: var(--transition);
            animation: pulse-papers 2s infinite;
        }

        .papers-float:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        @keyframes pulse-papers {
            0% {
                box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(52, 152, 219, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(52, 152, 219, 0);
            }
        }

        @keyframes pulse-whatsapp {
            0% {
                box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(37, 211, 102, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(37, 211, 102, 0);
            }
        }

        /* Particles Background */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        /* ET Panthiya Link */
        .etpanthiya-link {
            display: inline-block;
            margin-top: 30px;
            background: linear-gradient(to right, #00b894, #00cec9);
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0, 184, 148, 0.3);
            transition: var(--transition);
            margin-right: 15px;
        }

        .whatsapp-group-link {
            display: inline-block;
            margin-top: 30px;
            background: linear-gradient(to right, #25D366, #128C7E);
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.3);
            transition: var(--transition);
        }

        .etpanthiya-link:hover, .whatsapp-group-link:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 184, 148, 0.4);
        }

        .etpanthiya-link i, .whatsapp-group-link i {
            margin-right: 8px;
        }

        .links-container {
            text-align: center;
            margin-bottom: 30px;
        }

        /* Back Button */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.5);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
        }

        .back-button.show {
            opacity: 1;
            pointer-events: auto;
        }

        .back-button:hover {
            background: rgba(0,0,0,0.7);
            transform: translateX(-3px);
        }

        /* User Profile */
        .user-profile {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(5px);
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
            z-index: 999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .user-profile:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* Profile Info Popup */
        .profile-popup {
            position: fixed;
            top: 70px;
            right: 20px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 300px;
            z-index: 1000;
            transform: scale(0.95);
            opacity: 0;
            transition: var(--transition);
            pointer-events: none;
        }

        .profile-popup.show {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }

        .profile-header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 15px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            text-align: center;
            position: relative;
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            color: var(--primary);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            font-size: 1.5rem;
            margin: 0 auto 10px;
            border: 3px solid white;
        }

        .profile-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .profile-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .badge-silver {
            background: linear-gradient(to right, #bdc3c7, #9b9b9b);
            color: white;
        }

        .badge-gold {
            background: linear-gradient(to right, #FFD700, #D4AF37);
            color: white;
        }

        .badge-diamond {
            background: linear-gradient(to right, #b9f2ff, #00b4d8);
            color: white;
        }

        .profile-body {
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .profile-detail {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .profile-detail:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .detail-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 3px;
        }

        .detail-value {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .btn-logout {
            display: block;
            width: 100%;
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 15px;
            text-align: center;
        }

        .btn-logout:hover {
            background: #c0392b;
        }

        .btn-close-popup {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .auth-content, .student-content, .terms-content {
                margin: 10px 0;
            }
            
            .auth-body, .student-body, .terms-body {
                padding: 20px;
            }

            .profile-popup {
                width: 280px;
                right: 10px;
            }

            .levels-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .whatsapp-float {
                width: 50px;
                height: 50px;
                font-size: 25px;
                bottom: 100px;
                left: 20px;
            }

            .quick-actions {
                left: 20px;
                bottom: 160px;
            }

            .quick-actions-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .papers-float {
                left: 20px;
                bottom: 50px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }

        @media (max-width: 576px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .lesson-card {
                padding: 15px;
            }
            
            .lesson-card h3 {
                font-size: 1.1rem;
            }

            .auth-content {
                padding: 15px;
            }

            .logo-circle {
                width: 150px;
                height: 150px;
            }

            .logo-circle img {
                width: 130px;
                height: 130px;
            }

            .etpanthiya-link, .whatsapp-group-link {
                display: block;
                margin: 15px auto;
                width: 90%;
                max-width: 300px;
            }
            
            .auth-tabs {
                justify-content: space-between;
            }
            
            .auth-tab {
                padding: 10px;
                font-size: 0.9rem;
            }
            
            .otp-inputs input {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            /* Mobile keyboard fix */
            .auth-modal, .student-modal, .terms-modal {
                align-items: flex-start;
                padding-top: 20px;
            }
            
            .auth-content, .student-content, .terms-content {
                margin-top: 20px;
            }

            .profile-popup {
                width: 90%;
                right: 5%;
            }

            .levels-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .quick-actions {
                left: 20px;
                bottom: 150px;
            }

            .quick-actions-btn {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }

            .quick-actions-menu {
                width: 180px;
            }

            .papers-float {
                left: 20px;
                bottom: 40px;
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
        }

        /* Animation Classes */
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }
    </style>
</head>
<body>
    <!-- Preloader -->
    <div class="preloader">
        <div class="loader">
            <div></div><div></div><div></div>
            <div></div><div></div><div></div>
            <div></div><div></div><div></div>
        </div>
        <div class="loading-text">Loading Interactive Quiz Portal</div>
    </div>

    <!-- Quiz Preloader -->
<div class="quiz-preloader" id="quizPreloader">
    <div class="quiz-loader">
        <div></div><div></div><div></div>
        <div></div><div></div><div></div>
        <div></div><div></div><div></div>
    </div>
    <div class="quiz-loading-text">Loading Quiz Content</div>
</div> 

    <!-- Back Button -->
    <div class="back-button" id="backButton">
        <i class="fas fa-arrow-left"></i>
    </div>

    <!-- User Profile -->
    <div class="user-profile" id="userProfile">
        <div class="user-avatar" id="userAvatar">G</div>
    </div>

    <!-- Profile Info Popup -->
    <div class="profile-popup" id="profilePopup">
        <div class="profile-header">
            <button class="btn-close-popup" id="btnCloseProfile">
                <i class="fas fa-times"></i>
            </button>
            <div class="profile-avatar" id="profileAvatar">G</div>
            <div class="profile-name" id="profileName">Guest</div>
            <div class="profile-badge" id="profileBadge">Not Logged In</div>
        </div>
        <div class="profile-body" id="profileBody">
            <!-- User details will be populated here -->
        </div>
        <button class="btn-logout" id="btnLogout">Log Out</button>
    </div>

    <!-- Particles Background -->
    <div class="particles" id="particles-js"></div>

    <!-- WhatsApp Floating Button -->
    <div class="whatsapp-float" id="whatsappButton">
        <i class="fab fa-whatsapp"></i>
    </div>

    <!-- Quick Actions Dropdown -->
    <div class="quick-actions">
        <div class="quick-actions-btn" id="quickActionsBtn">
            <i class="fas fa-ellipsis-v"></i>
        </div>
        <div class="quick-actions-menu" id="quickActionsMenu">
            <a href="https://example.com/attendance" target="_blank">
                <i class="fas fa-user-check"></i> Attendance
            </a>
            <a href="https://example.com/feedback" target="_blank">
                <i class="fas fa-comment-dots"></i> Anonymous Feedback
            </a>
            <a href="https://example.com/results" target="_blank">
                <i class="fas fa-chart-bar"></i> Results
            </a>
        </div>
    </div>

    <!-- Papers Floating Button -->
    <div class="papers-float" id="papersButton">
        <i class="fas fa-file-alt"></i>
    </div>

    <!-- Main Container -->
    <div class="container">
        <div class="header">
            <div class="logo-circle">
                <img src="UDR.jpg" alt="Quiz Logo">
            </div>
            <h1>ET Panthiya.lk Quiz Portal</h1>
            <p>"The Quiz Portal"  ET Panthiya.lk අපේ වැඩක් ✨🎉. Enjoy & Learn 😎😜</p>
        </div>

        <!-- Links Container -->
        <div class="links-container">
            <a href="https://etpanthiya.lk" class="etpanthiya-link" target="_blank">
                <i class="fas fa-external-link-alt"></i> Visit ET Panthiya
            </a>
            <a href="https://wa.me/94779817525?text=Hello%20Quiz%20Support,%20I%20need%20help%20with..." class="whatsapp-group-link" target="_blank">
                <i class="fab fa-whatsapp"></i> Join WhatsApp Group
            </a>
        </div>

        <!-- Banner -->
        <div class="banner pulse">
            <h2>🚀 Important Notice!</h2>
            <p>පාඩම් 17 න්ම MCQ අපි Upload කරනවා. Update කරපු දවසේ ඉදන් දවස් 14 කට පස්සෙ අපි ආයේ අලුත්   MCQ Add කරනවා 😍 පාඩමෙන් පාඩමට තියෙන ප්‍රශ්න ගානයි Time එකයි ඔයාලට බලාගන්න පුලුවන්. 
උපකාරක සේවාව සදහා  පහත WhatsApp Button එක ඔස්සෙ අප සමග සම්බන්ද වන්න 
All The best 😚!</p>
            <div class="updated-date">Last updated: June 15, 2025</div>
        </div>

        <!-- Lessons Grid -->
        <div class="lessons-grid">
            <!-- Lesson 1 -->
            <div class="lesson-card" data-lesson="1">
                <img src="1.png" alt=" ET හැඳින්වීම" class="lesson-image">
                <h3> ET හැඳින්වීම</h3>
                <p>2025-05-02</p>
                <div class="lesson-meta">
                    <div class="time-indicator"><i class="fas fa-clock"></i> 30 minutes</div>
                    <div class="question-count"><i class="fas fa-question-circle"></i> 15 questions</div>
                </div>
                <button class="btn-start-quiz" data-lesson="1">Start Quiz</button>
            </div>

            <!-- Lesson 2 -->
            <div class="lesson-card" data-lesson="2">
                <img src="2.png" alt=" ඉංජිනේරු ඇඳීම Drawing" class="lesson-image">
                <h3> ඉංජිනේරු ඇඳීම Drawing</h3>
                <p>2025-05-02</p>
                <div class="lesson-meta">
                    <div class="time-indicator"><i class="fas fa-clock"></i> 30 minutes</div>
                    <div class="question-count"><i class="fas fa-question-circle"></i> 15 questions</div>
                </div>
                <button class="btn-start-quiz" data-lesson="2">Start Quiz</button>
            </div>

            <!-- Lesson 3 -->
            <div class="lesson-card" data-lesson="3">
                <img src="3.png" alt="නිෂ්පාදන තාක්ෂණවේදය Production" class="lesson-image">
                <h3>නිෂ්පාදන තාක්ෂණවේදය Production</h3>
                <p>2025-05-02</p>
                <div class="lesson-meta">
                    <div class="time-indicator"><i class="fas fa-clock"></i> 30 minutes</div>
                    <div class="question-count"><i class="fas fa-question-circle"></i> 15 questions</div>
                </div>
                <button class="btn-start-quiz" data-lesson="3">Start Quiz</button>
            </div>

            <!-- Lesson 4 -->
            <div class="lesson-card" data-lesson="4">
                <img src="4.png" alt=" ගොඩනැගිලි තාක්ෂණවේදය" class="lesson-image">
                <h3> ගොඩනැගිලි තාක්ෂණවේදය</h3>
                <p>2025-05-02</p>
                <div class="lesson-meta">
                    <div class="time-indicator"><i class="fas fa-clock"></i> 30 minutes</div>
                    <div class="question-count"><i class="fas fa-question-circle"></i> 15 questions</div>
                </div>
                <button class="btn-start-quiz" data-lesson="4">Start Quiz</button>
            </div>

            <!-- Lesson 5 -->
            <div class="lesson-card" data-lesson="5">
                <img src="5.png" alt=" යන්ත්‍ර වල බල සම්ප්‍රේෂණය හා චලිත හැසිරීම්" class="lesson-image">
                <h3> යන්ත්‍ර වල බල සම්ප්‍රේෂණය හා චලිත හැසිරීම්</h3>
                <p>2025-05-02</p>
                <div class="lesson-meta">
                    <div class="time-indicator"><i class="fas fa-clock"></i> 30 minutes</div>
                    <div class="question-count"><i class="fas fa-question-circle"></i> 15 questions</div>
                </div>
                <button class="btn-start-quiz" data-lesson="5">Start Quiz</button>
            </div>

            <!-- Lesson 6 -->
            <div class="lesson-card" data-lesson="6">
                <img src="6.png" alt=" ඉංජිනේරු ආරක්ෂාව Safety" class="lesson-image">
                <h3> ඉංජිනේරු ආරක්ෂාව Safety</h3>
                <p>2025-05-02</p>
                <div class="lesson-meta">
                    <div class="time-indicator"><i class="fas fa-clock"></i> 30 minutes</div>
                    <div class="question-count"><i class="fas fa-question-circle"></i> 15 questions</div>
                </div>
                <button class="btn-start-quiz" data-lesson="6">Start Quiz</button>
            </div>

            <!-- Lesson 7 -->
            <div class="lesson-card" data-lesson="7">
                <img src="7.png" alt=" ස්වයංචල තාක්ෂණය Automobile" class="lesson-image">
                <h3> ස්වයංචල තාක්ෂණය Automobile</h3>
                <p>2025-05-02</p>
                <div class="lesson-meta">
                    <div class="time-indicator"><i class="fas fa-clock"></i> 30 minutes</div>
                    <div class="question-count"><i class="fas fa-question-circle"></i> 15 questions</div>
                </div>
                <button class="btn-start-quiz" data-lesson="7">Start Quiz</button>
            </div>

            <!-- Lesson 8 -->
            <div class="lesson-card" data-lesson="8">
                <img src="8.png" alt="විදුලි තාක්ෂණවේදය Electrical" class="lesson-image">
                <h3> විදුලි තාක්ෂණවේදය Electrical</h3>
                <p>2025-05-02</p>
                <div class="lesson-meta">
                    <div class="time-indicator"><i class="fas fa-clock"></i> 30 minutes</div>
                    <div class="question-count"><i class="fas fa-question-circle"></i> 15 questions</div>
                </div>
                <button class="btn-start-quiz" data-lesson="8">Start Quiz</button>
            </div>

            <!-- Lesson 9 -->
            <div class="lesson-card" data-lesson="9">
                <img src="9.png" alt=" ඒකක හා මිනුම්" class="lesson-image">
                <h3> ඒකක හා මිනුම්</h3>
                <p>2025-05-02</p>
                <div class="lesson-meta">
                    <div class="time-indicator"><i class="fas fa-clock"></i> 30 minutes</div>
                    <div class="question-count"><i class="fas fa-question-circle"></i> 15 questions</div>
                </div>
                <button class="btn-start-quiz" data-lesson="9">Start Quiz</button>
            </div>

            <!-- Lesson 10 -->
            <div class="lesson-card" data-lesson="10">
                <img src="10.png" alt="විදුලි යන්ත්‍ර හා බල පද්ධති (මෝටර් පාඩම)" class="lesson-image">
                <h3>විදුලි යන්ත්‍ර හා බල පද්ධති (මෝටර් පාඩම)</h3>
                <p>2025-05-02</p>
                <div class="lesson-meta">
                    <div class="time-indicator"><i class="fas fa-clock"></i> 30 minutes</div>
                    <div class="question-count"><i class="fas fa-question-circle"></i> 15 questions</div>
                </div>
                <button class="btn-start-quiz" data-lesson="10">Start Quiz</button>
            </div>

            <!-- Lesson 11 -->
            <div class="lesson-card" data-lesson="11">
                <img src="11.png" alt=" ප්‍රමිති හා පිරිවිතර" class="lesson-image">
                <h3> ප්‍රමිති හා පිරිවිතර</h3>
                <p>2025-05-02</p>
                <div class="lesson-meta">
                    <div class="time-indicator"><i class="fas fa-clock"></i> 30 minutes</div>
                    <div class="question-count"><i class="fas fa-question-circle"></i> 15 questions</div>
                </div>
                <button class="btn-start-quiz" data-lesson="11">Start Quiz</button>
            </div>

            <!-- Lesson 12 -->
            <div class="lesson-card" data-lesson="12">
                <img src="12.png" alt=" බිම් මැනුම්" class="lesson-image">
                <h3> බිම් මැනුම්</h3>
                <p>2025-05-02</p>
                <div class="lesson-meta">
                    <div class="time-indicator"><i class="fas fa-clock"></i> 30 minutes</div>
                    <div class="question-count"><i class="fas fa-question-circle"></i> 15 questions</div>
                </div>
                <button class="btn-start-quiz" data-lesson="12">Start Quiz</button>
            </div>

            <!-- Lesson 13 -->
            <div class="lesson-card" data-lesson="13">
                <img src="13.png" alt=" තරල යන්‍ත්‍ර" class="lesson-image">
                <h3> තරල යන්‍ත්‍ර</h3>
                <p>2025-05-02</p>
                <div class="lesson-meta">
                    <div class="time-indicator"><i class="fas fa-clock"></i> 30 minutes</div>
                    <div class="question-count"><i class="fas fa-question-circle"></i> 15 questions</div>
                </div>
                <button class="btn-start-quiz" data-lesson="13">Start Quiz</button>
            </div>

            <!-- Lesson 14 -->
            <div class="lesson-card" data-lesson="14">
                <img src="14.png" alt="ඉලෙක්ට්‍රොනික් තාක්ෂණය" class="lesson-image">
                <h3>ඉලෙක්ට්‍රොනික් තාක්ෂණය</h3>
                <p>2025-05-02</p>
                <div class="lesson-meta">
                    <div class="time-indicator"><i class="fas fa-clock"></i> 30 minutes</div>
                    <div class="question-count"><i class="fas fa-question-circle"></i> 15 questions</div>
                </div>
                <button class="btn-start-quiz" data-lesson="14">Start Quiz</button>
            </div>

            <!-- Lesson 15 -->
            <div class="lesson-card" data-lesson="15">
                <img src="15.png" alt=" ජල සම්පාදනය හා කසල අපහනය" class="lesson-image">
                <h3> ජල සම්පාදනය හා කසල අපහනය</h3>
                <p>2025-05-02</p>
                <div class="lesson-meta">
                    <div class="time-indicator"><i class="fas fa-clock"></i> 30 minutes</div>
                    <div class="question-count"><i class="fas fa-question-circle"></i> 15 questions</div>
                </div>
                <button class="btn-start-quiz" data-lesson="15">Start Quiz</button>
            </div>

            <!-- Lesson 16 -->
            <div class="lesson-card" data-lesson="16">
                <img src="16.png" alt="ප්‍රමාණ බිල්පත් සැකසීම ඇස්තමේන්තුකරණය (TDS BOQ)" class="lesson-image">
                <h3>ප්‍රමාණ බිල්පත් සැකසීම ඇස්තමේන්තුකරණය (TDS BOQ)</h3>
                <p>2025-05-02</p>
                <div class="lesson-meta">
                    <div class="time-indicator"><i class="fas fa-clock"></i> 30 minutes</div>
                    <div class="question-count"><i class="fas fa-question-circle"></i> 15 questions</div>
                </div>
                <button class="btn-start-quiz" data-lesson="16">Start Quiz</button>
            </div>

            <!-- Lesson 17 -->
            <div class="lesson-card" data-lesson="17">
                <img src="17.png" alt=" ව්‍යවසායකත්වය හා කළමනාකරණය" class="lesson-image">
                <h3> ව්‍යවසායකත්වය හා කළමනාකරණය</h3>
                <p>2025-05-02</p>
                <div class="lesson-meta">
                    <div class="time-indicator"><i class="fas fa-clock"></i> 30 minutes</div>
                    <div class="question-count"><i class="fas fa-question-circle"></i> 15 questions</div>
                </div>
                <button class="btn-start-quiz" data-lesson="17">Start Quiz</button>
            </div>
        </div>
    </div>

    <!-- Level Selection Modal -->
    <div class="level-modal" id="levelModal">
        <div class="level-content">
            <div class="level-header">
                <h2 id="levelModalTitle">Select Level</h2>
                <p id="levelModalSubtitle">Choose a level to start the quiz</p>
            </div>
            <div class="level-body">
                <div class="levels-grid" id="levelsGrid">
                    <!-- Levels will be added dynamically -->
                </div>
            </div>
            <div class="level-footer">
                <button class="btn-close-levels" id="btnCloseLevels">Close</button>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-content">
            <div class="auth-header">
                <h2 id="authModalTitle">Welcome Back!</h2>
                <p id="authModalSubtitle">Please login to continue</p>
            </div>
            <div class="auth-body">
                <div class="auth-tabs">
                    <div class="auth-tab active" data-tab="login">Login</div>
                    <div class="auth-tab" data-tab="signup">Sign Up</div>
                </div>
                
                <!-- Login Form -->
                <div class="auth-form active" id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password">
                    </div>
                    <div class="remember-me">
                        <input type="checkbox" id="rememberMe">
                        <label for="rememberMe">Remember me</label>
                    </div>
                    <button class="btn-auth" id="btnLogin">Login</button>
                    <div class="auth-footer">
                        Don't have an account? <a id="showSignup">Sign up</a>
                    </div>
                </div>
                
                <!-- Signup Form Part 1 - Phone Verification -->
                <div class="auth-form" id="signupPhoneForm">
                    <div class="form-group">
                        <label for="signupPhone">Phone Number (with country code)</label>
                        <input type="tel" id="signupPhone" placeholder="e.g., 94769343928" required>
                    </div>
                    <button class="btn-auth" id="btnSendOtp">
                        <span id="sendSpinner" class="loading" style="display: none;"></span>
                        <span id="sendText">Send Verification Code</span>
                    </button>
                    <div class="auth-footer">
                        Already have an account? <a id="showLoginFromSignup">Login</a>
                    </div>
                </div>
                
                <!-- Signup Form Part 2 - OTP Verification -->
                <div class="auth-form" id="signupOtpForm">
                    <div class="form-group">
                        <label for="verificationCode">Enter 6-Digit Verification Code:</label>
                        <input type="text" id="verificationCode" placeholder="Enter code received via SMS" maxlength="6">
                    </div>
                    <button class="btn-auth" id="btnVerifyOtp">Verify Phone Number</button>
                    <div class="resend-otp">
                        Didn't receive code? <a id="resendOtp">Resend OTP</a>
                    </div>
                </div>
                
                <!-- Signup Form Part 3 - Email & Password -->
                <div class="auth-form" id="signupForm">
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" placeholder="Create a password (min 6 chars)">
                    </div>
                    <div class="remember-me">
                        <input type="checkbox" id="rememberMeSignup" checked>
                        <label for="rememberMeSignup">Remember me</label>
                    </div>
                    <button class="btn-auth" id="btnSignup">Complete Sign Up</button>
                    <div class="auth-footer">
                        Already have an account? <a id="showLoginFromEmail">Login</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div class="student-modal" id="studentModal">
        <div class="student-content">
            <div class="student-header">
                <h2>Student Information</h2>
                <p>Please provide your details to continue</p>
            </div>
            <div class="student-body">
                <form id="studentForm">
                    <div class="form-group">
                        <label for="studentName">Full Name</label>
                        <input type="text" id="studentName" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label for="studentEmail">Email</label>
                        <input type="email" id="studentEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="studentExamYear">Exam Year</label>
                        <input type="number" id="studentExamYear" min="2023" max="2030" placeholder="Enter exam year" required>
                    </div>
                    <div class="form-group">
                        <label for="studentSchool">School</label>
                        <input type="text" id="studentSchool" placeholder="Enter your school" required>
                    </div>
                    <div class="form-group">
                        <label for="studentDistrict">District</label>
                        <input type="text" id="studentDistrict" placeholder="Enter your district" required>
                    </div>
                    <div class="form-group">
                        <label for="studentWhatsapp">WhatsApp Number</label>
                        <div class="phone-input">
                            <span class="prefix">+94</span>
                            <input type="tel" id="studentWhatsapp" placeholder="7XXXXXXXX" maxlength="9" required>
                        </div>
                    </div>
                    <button type="submit" class="btn-auth" id="btnSaveStudent">Save Information</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Terms and Conditions Modal -->
    <div class="terms-modal" id="termsModal">
        <div class="terms-content">
            <div class="terms-header">
                <h2>Terms and Conditions</h2>
            </div>
            <div class="terms-body">
                <p><strong>1. Acceptance of Terms</strong><br>
                By using this quiz portal, you agree to these terms and conditions. If you do not agree, please do not use this service.</p>
                
                <p><strong>2. Data Collection</strong><br>
                We collect personal information including your name, email, phone number, school, and district solely for the purpose of providing feedback on our software and maintaining updates. This information helps us improve our services and tailor them to your needs.</p>
                
                <p><strong>3. Data Protection</strong><br>
                Your information will be stored securely and will not be shared with any third parties without your explicit consent, except as required by law.</p>
                
                <p><strong>4. User Responsibilities</strong><br>
                You agree to provide accurate and complete information when registering. You are responsible for maintaining the confidentiality of your account credentials.</p>
                
                <p><strong>5. Privacy Policy</strong><br>
                Our privacy policy explains how we collect, use, and protect your personal data. By using this service, you consent to our privacy practices.</p>
                
                <p><strong>6. Service Modifications</strong><br>
                We reserve the right to modify or discontinue the service at any time without notice. We are not liable for any modification, suspension, or discontinuance of the service.</p>
                
                <p><strong>7. Limitation of Liability</strong><br>
                The quiz portal is provided "as is" without warranties of any kind. We are not liable for any direct, indirect, incidental, or consequential damages resulting from your use of this service.</p>
                
                <div class="terms-checkbox">
                    <input type="checkbox" id="agreeTerms" required>
                    <label for="agreeTerms">I agree to the above terms and conditions</label>
                </div>
                
                <button class="btn-terms" id="btnAcceptTerms" disabled>I Agree & Continue</button>
            </div>
        </div>
    </div>

    <!-- Quiz Container -->
    <div class="quiz-container" id="quizContainer">
        <div class="quiz-header">
            <div class="quiz-title" id="quizTitle">Quiz Title</div>
            <div class="timer">
                <i class="fas fa-clock"></i>
                <span id="quizTimer">30:00</span>
            </div>
            <button class="btn-close-quiz" id="btnCloseQuiz">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <iframe class="quiz-iframe" id="quizIframe" frameborder="0"></iframe>
    </div>

    <!-- Time Warning Modal -->
    <div class="alert-modal" id="timeWarningModal">
        <div class="alert-content">
            <div class="alert-icon warning">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="alert-title">Time Warning!</h3>
            <p class="alert-message" id="timeWarningMessage">You have 10 minutes remaining to complete your quiz.</p>
            <button class="btn-alert" id="btnAcknowledgeWarning">Continue Quiz</button>
        </div>
    </div>

    <!-- Time Up Modal -->
    <div class="alert-modal" id="timeUpModal">
        <div class="alert-content">
            <div class="alert-icon danger">
                <i class="fas fa-hourglass-end"></i>
            </div>
            <h3 class="alert-title">Time's Up!</h3>
            <p class="alert-message">Your quiz time has expired. The quiz will now be submitted automatically.</p>
            <button class="btn-alert" id="btnAcknowledgeTimeUp">OK</button>
        </div>
    </div>

    <!-- Welcome Modal -->
    <div class="welcome-modal" id="welcomeModal">
        <div class="welcome-content">
            <div class="welcome-header">
                <img src="https://images.unsplash.com/photo-1522202176988-66273c2fd55f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=500&q=80" alt="Welcome">
            </div>
            <div class="welcome-body">
                <h2>Welcome to Interactive Quiz Portal 2025!</h2>
                <p>Test your knowledge across 17 comprehensive lessons with customized time limits for each quiz. Please login or sign up to get started.</p>
                <button class="btn-alert" id="btnWelcomeContinue">Get Started</button>
            </div>
        </div>
    </div>

    <!-- Floating Notification -->
    <div class="notification" id="floatingNotification">
        <i class="fas fa-info-circle"></i>
        <span id="notificationMessage">Notification message</span>
    </div>

    <!-- Audio Elements -->
    <audio id="startSound" src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3" preload="auto"></audio>
    <audio id="warningSound" src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" preload="auto"></audio>
    <audio id="timeUpSound" src="https://assets.mixkit.co/sfx/preview/mixkit-unlock-game-notification-253.mp3" preload="auto"></audio>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAf1282ikjQ7MUSP4fKrGQjRTAb1kDWUV8",
            authDomain: "quiz-app-5b02d.firebaseapp.com",
            projectId: "quiz-app-5b02d",
            storageBucket: "quiz-app-5b02d.appspot.com",
            messagingSenderId: "345835769588",
            appId: "1:345835769588:web:702129bc15f30f3d5f18a1"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Your TextIt.biz credentials
        const TEXTIT_ID = "94760273554";  // Your registered phone number
        const TEXTIT_PW = "2204";        // Your password
        
        // Store the generated verification code
        let generatedCode = "";

        // Enable Firestore persistence
        firebase.firestore().enablePersistence()
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.log("Persistence can only be enabled in one tab at a time");
                } else if (err.code == 'unimplemented') {
                    console.log("The current browser does not support all of the features required to enable persistence");
                }
            });

        // Audio elements
        const startSound = document.getElementById('startSound');
        const warningSound = document.getElementById('warningSound');
        const timeUpSound = document.getElementById('timeUpSound');

        // Google Form URLs for each lesson level (replace with your actual form URLs)
        const formUrls = {
            1: Array(20).fill().map((_, i) => `https://docs.google.com/forms/d/e/1FAIpQLSf.../viewform?embedded=true&level=${i+1}`),
            2: Array(20).fill().map((_, i) => `https://docs.google.com/forms/d/e/1FAIpQLSf.../viewform?embedded=true&level=${i+1}`),
            // Add URLs for all 17 lessons with 20 levels each
            // ...
            17: Array(20).fill().map((_, i) => `https://docs.google.com/forms/d/e/1FAIpQLSf.../viewform?embedded=true&level=${i+1}`)
        };

        // Lesson titles for display
        const lessonTitles = {
            1: "ET හැඳින්වීම",
            2: "ඉංජිනේරු ඇඳීම Drawing",
            3: "නිෂ්පාදන තාක්ෂණවේදය Production",
            4: "ගොඩනැගිලි තාක්ෂණවේදය",
            5: "යන්ත්‍ර වල බල සම්ප්‍රේෂණය හා චලිත හැසිරීම්",
            6: "ඉංජිනේරු ආරක්ෂාව Safety",
            7: "ස්වයංචල තාක්ෂණය Automobile",
            8: "විදුලි තාක්ෂණවේදය Electrical",
            9: "ඒකක හා මිනුම්",
            10: "විදුලි යන්ත්‍ර හා බල පද්ධති (මෝටර් පාඩම)",
            11: "ප්‍රමිති හා පිරිවිතර",
            12: "බිම් මැනුම්",
            13: "තරල යන්‍ත්‍ර",
            14: "ඉලෙක්ට්‍රොනික් තාක්ෂණය",
            15: "ජල සම්පාදනය හා කසල අපහනය",
            16: "ප්‍රමාණ බිල්පත් සැකසීම ඇස්තමේන්තුකරණය (TDS BOQ)",
            17: "ව්‍යවසායකත්වය හා කළමනාකරණය"
        };

        // Variables for timer
        let quizTimer;
        let timeLeft;
        let quizActive = false;
        let quizDuration = 30; // Default duration in minutes
        let warned10 = false;
        let warned5 = false;
        let currentLesson = null;
        let currentLevel = null;
        let verificationId = null;
        let otpAttempts = 0;
        let lastOtpSentTime = 0;
        let otpResendTimer;


        // DOM Elements
        const quizPreloader = document.getElementById('quizPreloader');
        const quizLoader = document.querySelector('.quiz-loader');
        const quizLoadingText = document.querySelector('.quiz-loading-text');
        const backButton = document.getElementById('backButton');
        const userProfile = document.getElementById('userProfile');
        const userAvatar = document.getElementById('userAvatar');
        const profilePopup = document.getElementById('profilePopup');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileName = document.getElementById('profileName');
        const profileBadge = document.getElementById('profileBadge');
        const profileBody = document.getElementById('profileBody');
        const btnCloseProfile = document.getElementById('btnCloseProfile');
        const btnLogout = document.getElementById('btnLogout');
        const whatsappButton = document.getElementById('whatsappButton');
        const quickActionsBtn = document.getElementById('quickActionsBtn');
        const quickActionsMenu = document.getElementById('quickActionsMenu');
        const papersButton = document.getElementById('papersButton');
        const mainContainer = document.querySelector('.container');
        const authModal = document.getElementById('authModal');
        const authModalTitle = document.getElementById('authModalTitle');
        const authModalSubtitle = document.getElementById('authModalSubtitle');
        const authTabs = document.querySelectorAll('.auth-tab');
        const loginForm = document.getElementById('loginForm');
        const signupPhoneForm = document.getElementById('signupPhoneForm');
        const signupOtpForm = document.getElementById('signupOtpForm');
        const signupForm = document.getElementById('signupForm');
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const rememberMe = document.getElementById('rememberMe');
        const btnLogin = document.getElementById('btnLogin');
        const signupEmail = document.getElementById('signupEmail');
        const signupPassword = document.getElementById('signupPassword');
        const signupPhone = document.getElementById('signupPhone');
        const btnSendOtp = document.getElementById('btnSendOtp');
        const btnSignup = document.getElementById('btnSignup');
        const verificationCode = document.getElementById('verificationCode');
        const btnVerifyOtp = document.getElementById('btnVerifyOtp');
        const resendOtp = document.getElementById('resendOtp');
        const showSignup = document.getElementById('showSignup');
        const showLoginFromSignup = document.getElementById('showLoginFromSignup');
        const showLoginFromEmail = document.getElementById('showLoginFromEmail');
        const studentModal = document.getElementById('studentModal');
        const studentForm = document.getElementById('studentForm');
        const studentName = document.getElementById('studentName');
        const studentEmail = document.getElementById('studentEmail');
        const studentExamYear = document.getElementById('studentExamYear');
        const studentSchool = document.getElementById('studentSchool');
        const studentDistrict = document.getElementById('studentDistrict');
        const studentWhatsapp = document.getElementById('studentWhatsapp');
        const btnSaveStudent = document.getElementById('btnSaveStudent');
        const termsModal = document.getElementById('termsModal');
        const agreeTerms = document.getElementById('agreeTerms');
        const btnAcceptTerms = document.getElementById('btnAcceptTerms');
        const quizContainer = document.getElementById('quizContainer');
        const quizIframe = document.getElementById('quizIframe');
        const quizTitle = document.getElementById('quizTitle');
        const quizTimerDisplay = document.getElementById('quizTimer');
        const btnCloseQuiz = document.getElementById('btnCloseQuiz');
        const timeWarningModal = document.getElementById('timeWarningModal');
        const timeUpModal = document.getElementById('timeUpModal');
        const btnAcknowledgeWarning = document.getElementById('btnAcknowledgeWarning');
        const btnAcknowledgeTimeUp = document.getElementById('btnAcknowledgeTimeUp');
        const floatingNotification = document.getElementById('floatingNotification');
        const notificationMessage = document.getElementById('notificationMessage');
        const welcomeModal = document.getElementById('welcomeModal');
        const btnWelcomeContinue = document.getElementById('btnWelcomeContinue');
        const levelModal = document.getElementById('levelModal');
        const levelModalTitle = document.getElementById('levelModalTitle');
        const levelModalSubtitle = document.getElementById('levelModalSubtitle');
        const levelsGrid = document.getElementById('levelsGrid');
        const btnCloseLevels = document.getElementById('btnCloseLevels');
        const lessonCards = document.querySelectorAll('.lesson-card');
        const btnStartQuiz = document.querySelectorAll('.btn-start-quiz');
        const sendSpinner = document.getElementById('sendSpinner');
        const sendText = document.getElementById('sendText');

        // Initialize the app
        function init() {
            setupEventListeners();
            checkAuthState();
            initParticles();
            
            // Load saved login info if available
            loadSavedLogin();
            
            // Show welcome message based on time of day
            showTimeBasedWelcome();
            
            // Show main content immediately without requiring login
            setTimeout(() => {
                mainContainer.style.display = 'block';
                setTimeout(() => {
                    mainContainer.classList.add('show');
                }, 10);
            }, 1000);
        }

        // Show time-based welcome message
        function showTimeBasedWelcome() {
            const hour = new Date().getHours();
            let message = "";
            let emoji = "";
            
            if (hour >= 5 && hour < 12) {
                message = "Good Morning!";
                emoji = "☀️";
            } else if (hour >= 12 && hour < 17) {
                message = "Good Afternoon!";
                emoji = "🌞";
            } else if (hour >= 17 && hour < 21) {
                message = "Good Evening!";
                emoji = "🌆";
            } else {
                message = "Good Night!";
                emoji = "🌙";
            }
            
            showNotification(`${message} ${emoji} Welcome to ET Panthiya Quiz Portal`, 'success');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Back button
            backButton.addEventListener('click', handleBackButton);
            
            // User profile
            userProfile.addEventListener('click', toggleProfilePopup);
            btnCloseProfile.addEventListener('click', () => profilePopup.classList.remove('show'));
            btnLogout.addEventListener('click', handleLogout);
            
            // Close profile popup when clicking outside
            document.addEventListener('click', (e) => {
                if (!userProfile.contains(e.target) && !profilePopup.contains(e.target)) {
                    profilePopup.classList.remove('show');
                }
            });
            
            // WhatsApp button
            whatsappButton.addEventListener('click', () => {
                window.open('https://wa.me/94779817525?text=Hello%20Quiz%20Support,%20I%20need%20help%20with...', '_blank');
            });
            
            // Papers button
            papersButton.addEventListener('click', () => {
                window.open('https://example.com/papers', '_blank');
            });
            
            // Quick actions dropdown
            quickActionsBtn.addEventListener('click', toggleQuickActions);
            
            // Close quick actions when clicking outside
            document.addEventListener('click', (e) => {
                if (!quickActionsBtn.contains(e.target) && !quickActionsMenu.contains(e.target)) {
                    quickActionsMenu.classList.remove('show');
                }
            });
            
            // Welcome modal
            btnWelcomeContinue.addEventListener('click', () => {
                welcomeModal.querySelector('.welcome-content').style.transform = 'scale(0.9)';
                welcomeModal.querySelector('.welcome-content').style.opacity = '0';
                setTimeout(() => {
                    welcomeModal.style.display = 'none';
                }, 300);
            });
            
            // Auth modal tabs
            authTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    switchAuthTab(tabName);
                });
            });
            
            // Show signup/login links
            showSignup.addEventListener('click', () => switchAuthTab('signup'));
            showLoginFromSignup.addEventListener('click', () => switchAuthTab('login'));
            showLoginFromEmail.addEventListener('click', () => switchAuthTab('login'));
            
            // Login form
            btnLogin.addEventListener('click', handleLogin);
            loginPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            
            // Signup phone form
            btnSendOtp.addEventListener('click', handleSendOtp);
            signupPhone.addEventListener('input', formatPhoneNumber);
            
            // OTP verification
            btnVerifyOtp.addEventListener('click', verifyOtp);
            resendOtp.addEventListener('click', resendOtpCode);
            
            // Signup form
            btnSignup.addEventListener('click', handleSignup);
            
            // Student form
            studentForm.addEventListener('submit', saveStudentDetails);
            studentWhatsapp.addEventListener('input', formatPhoneNumber);
            
            // Terms modal
            agreeTerms.addEventListener('change', (e) => {
                btnAcceptTerms.disabled = !e.target.checked;
            });
            
            btnAcceptTerms.addEventListener('click', () => {
                hideTermsModal();
                showStudentModal();
            });
            
            // Quiz controls
            btnCloseQuiz.addEventListener('click', closeQuiz);
            btnAcknowledgeWarning.addEventListener('click', () => hideAlertModal(timeWarningModal));
            btnAcknowledgeTimeUp.addEventListener('click', () => {
                hideAlertModal(timeUpModal);
                closeQuiz();
            });
            
            // Level selection modal
            btnCloseLevels.addEventListener('click', () => {
                hideLevelModal();
            });
            
            // Start quiz buttons
            btnStartQuiz.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const lessonId = btn.getAttribute('data-lesson');
                    showLevelModal(lessonId);
                });
            });
            
            // Beforeunload event
            window.addEventListener('beforeunload', handleBeforeUnload);
        }

        // Toggle quick actions menu
        function toggleQuickActions() {
            quickActionsMenu.classList.toggle('show');
        }

        // Show level selection modal
        function showLevelModal(lessonId) {
            currentLesson = lessonId;
            levelModalTitle.textContent = `${lessonTitles[lessonId]}`;
            levelModalSubtitle.textContent = 'Select a level to start the quiz';
            
            // Clear existing levels
            levelsGrid.innerHTML = '';
            
            // Get user's completed levels if logged in
            let completedLevels = [];
            const user = auth.currentUser;
            
            if (user) {
                db.collection('users').doc(user.uid).get()
                    .then(doc => {
                        if (doc.exists) {
                            const userData = doc.data();
                            completedLevels = userData.completedLevels?.[lessonId] || [];
                        }
                        populateLevels(completedLevels);
                    })
                    .catch(error => {
                        console.error('Error getting user data:', error);
                        populateLevels([]);
                    });
            } else {
                // For guest users, only allow level 1
                populateLevels([]);
            }
            
            levelModal.style.display = 'flex';
            setTimeout(() => {
                levelModal.querySelector('.level-content').style.transform = 'scale(1)';
                levelModal.querySelector('.level-content').style.opacity = '1';
            }, 10);
        }

        // Populate levels in the modal
        function populateLevels(completedLevels) {
            const user = auth.currentUser;
            
            for (let i = 1; i <= 20; i++) {
                const levelBtn = document.createElement('div');
                levelBtn.className = 'level-btn';
                levelBtn.textContent = `Level ${i}`;
                
                if (completedLevels.includes(i)) {
                    levelBtn.classList.add('completed');
                } else if (i > 1 && !user) {
                    // Lock all levels except level 1 for guests
                    levelBtn.classList.add('locked');
                } else if (i > 1 && !completedLevels.includes(i-1)) {
                    // Lock level if previous level not completed
                    levelBtn.classList.add('locked');
                }
                
                if (!levelBtn.classList.contains('locked')) {
                    levelBtn.addEventListener('click', () => {
                        if (i === 1 || user) {
                            startQuiz(currentLesson, i);
                            hideLevelModal();
                        } else {
                            // Show auth modal if trying to access level 2+ without login
                            showNotification('Please login to access this level', 'warning');
                            showAuthModal('login');
                        }
                    });
                }
                
                levelsGrid.appendChild(levelBtn);
            }
        }

        // Hide level modal
        function hideLevelModal() {
            levelModal.querySelector('.level-content').style.transform = 'scale(0.9)';
            levelModal.querySelector('.level-content').style.opacity = '0';
            setTimeout(() => {
                levelModal.style.display = 'none';
            }, 300);
        }

        // Load saved login info from localStorage
        function loadSavedLogin() {
            const savedEmail = localStorage.getItem('quizPortalEmail');
            const savedPassword = localStorage.getItem('quizPortalPassword');
            
            if (savedEmail && savedPassword) {
                loginEmail.value = savedEmail;
                loginPassword.value = savedPassword;
                rememberMe.checked = true;
            }
        }

        // Save login info to localStorage
        function saveLoginInfo(email, password) {
            if (rememberMe.checked) {
                localStorage.setItem('quizPortalEmail', email);
                localStorage.setItem('quizPortalPassword', password);
            } else {
                localStorage.removeItem('quizPortalEmail');
                localStorage.removeItem('quizPortalPassword');
            }
        }

        // Clear saved login info
        function clearSavedLogin() {
            localStorage.removeItem('quizPortalEmail');
            localStorage.removeItem('quizPortalPassword');
        }

        // Check auth state
        function checkAuthState() {
            auth.onAuthStateChanged(async user => {
                if (user) {
                    // User is signed in
                    updateUserProfile(user);
                    
                    // Check if user has completed profile
                    await checkUserProfile(user);
                    
                    // Auto-fill login form for next time
                    if (user.email) {
                        loginEmail.value = user.email;
                    }
                } else {
                    // User is signed out
                    userAvatar.textContent = 'G';
                    profileAvatar.textContent = 'G';
                    profileName.textContent = 'Guest';
                    profileBadge.textContent = 'Not Logged In';
                    profileBadge.className = 'profile-badge';
                    profileBody.innerHTML = '';
                    
                    // Hide profile popup
                    profilePopup.classList.remove('show');
                }
            });
        }

        // Check if user has completed profile
        async function checkUserProfile(user) {
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                if (!userData.profileCompleted) {
                    showTermsModal();
                } else {
                    // Update profile popup with user details
                    updateProfilePopup(user, userData);
                }
            } else {
                showTermsModal();
            }
        }

        // Update user profile display
        function updateUserProfile(user) {
            if (user.displayName) {
                const firstLetter = user.displayName.charAt(0).toUpperCase();
                userAvatar.textContent = firstLetter;
                profileAvatar.textContent = firstLetter;
            } else {
                userAvatar.textContent = 'U';
                profileAvatar.textContent = 'U';
            }
        }

        // Update profile popup with user details
        function updateProfilePopup(user, userData) {
            if (user.displayName) {
                profileName.textContent = user.displayName;
            } else {
                profileName.textContent = 'User';
            }
            
            // Determine badge based on completed lessons
            const completedLessons = Object.keys(userData.completedLevels || {}).length;
            let badgeText = '';
            let badgeClass = '';
            
            if (completedLessons >= 10) {
                badgeText = 'Diamond Member';
                badgeClass = 'badge-diamond';
            } else if (completedLessons >= 5) {
                badgeText = 'Gold Member';
                badgeClass = 'badge-gold';
            } else if (completedLessons > 0) {
                badgeText = 'Silver Member';
                badgeClass = 'badge-silver';
            } else {
                badgeText = 'New Member';
                badgeClass = 'profile-badge';
            }
            
            profileBadge.textContent = badgeText;
            profileBadge.className = `profile-badge ${badgeClass}`;
            
            // Populate user details
            let profileHTML = `
                <div class="profile-detail">
                    <div class="detail-label">Email</div>
                    <div class="detail-value">${user.email || 'Not provided'}</div>
                </div>
                <div class="profile-detail">
                    <div class="detail-label">School</div>
                    <div class="detail-value">${userData.school || 'Not provided'}</div>
                </div>
                <div class="profile-detail">
                    <div class="detail-label">District</div>
                    <div class="detail-value">${userData.district || 'Not provided'}</div>
                </div>
                <div class="profile-detail">
                    <div class="detail-label">Exam Year</div>
                    <div class="detail-value">${userData.examYear || 'Not provided'}</div>
                </div>
                <div class="profile-detail">
                    <div class="detail-label">WhatsApp</div>
                    <div class="detail-value">${userData.whatsapp || 'Not provided'}</div>
                </div>
                <div class="profile-detail">
                    <div class="detail-label">Completed Lessons</div>
                    <div class="detail-value">${Object.keys(userData.completedLevels || {}).length} / 17</div>
                </div>
            `;
            
            profileBody.innerHTML = profileHTML;
        }

        // Toggle profile popup
        function toggleProfilePopup() {
            if (auth.currentUser) {
                profilePopup.classList.toggle('show');
            } else {
                showAuthModal('login');
            }
        }

        // Handle logout
        function handleLogout() {
            auth.signOut().then(() => {
                showNotification('Logged out successfully', 'success');
                profilePopup.classList.remove('show');
                clearSavedLogin();
            }).catch(error => {
                console.error('Logout error:', error);
                showNotification('Failed to log out', 'danger');
            });
        }

        // Show auth modal
        function showAuthModal(tab = 'login') {
            authModal.style.display = 'flex';
            setTimeout(() => {
                authModal.querySelector('.auth-content').style.transform = 'scale(1)';
                authModal.querySelector('.auth-content').style.opacity = '1';
                switchAuthTab(tab);
            }, 10);
        }

        // Hide auth modal
        function hideAuthModal() {
            authModal.querySelector('.auth-content').style.transform = 'scale(0.9)';
            authModal.querySelector('.auth-content').style.opacity = '0';
            setTimeout(() => {
                authModal.style.display = 'none';
            }, 300);
        }

        // Show student modal
        function showStudentModal() {
            studentModal.style.display = 'flex';
            setTimeout(() => {
                studentModal.querySelector('.student-content').style.transform = 'scale(1)';
                studentModal.querySelector('.student-content').style.opacity = '1';
            }, 10);
        }

        // Hide student modal
        function hideStudentModal() {
            studentModal.querySelector('.student-content').style.transform = 'scale(0.9)';
            studentModal.querySelector('.student-content').style.opacity = '0';
            setTimeout(() => {
                studentModal.style.display = 'none';
            }, 300);
        }

        // Show terms modal
        function showTermsModal() {
            termsModal.style.display = 'flex';
            setTimeout(() => {
                termsModal.querySelector('.terms-content').style.transform = 'scale(1)';
                termsModal.querySelector('.terms-content').style.opacity = '1';
            }, 10);
        }

        // Hide terms modal
        function hideTermsModal() {
            termsModal.querySelector('.terms-content').style.transform = 'scale(0.9)';
            termsModal.querySelector('.terms-content').style.opacity = '0';
            setTimeout(() => {
                termsModal.style.display = 'none';
            }, 300);
        }

        // Switch auth tab
        function switchAuthTab(tab) {
            authTabs.forEach(t => t.classList.remove('active'));
            document.querySelector(`.auth-tab[data-tab="${tab}"]`).classList.add('active');
            
            loginForm.classList.remove('active');
            signupPhoneForm.classList.remove('active');
            signupOtpForm.classList.remove('active');
            signupForm.classList.remove('active');
            
            if (tab === 'login') {
                authModalTitle.textContent = 'Welcome Back!';
                authModalSubtitle.textContent = 'Please login to continue';
                loginForm.classList.add('active');
            } else if (tab === 'signup') {
                authModalTitle.textContent = 'Sign Up - Part 1';
                authModalSubtitle.textContent = 'Verify your phone number';
                signupPhoneForm.classList.add('active');
            }
        }

        // Show OTP form
        function showOtpForm(phoneNumber) {
            authModalTitle.textContent = 'Sign Up - Part 2';
            authModalSubtitle.textContent = 'Enter the 6-digit code we sent';
            
            loginForm.classList.remove('active');
            signupPhoneForm.classList.remove('active');
            signupOtpForm.classList.add('active');
            
            // Clear OTP input
            verificationCode.value = '';
            
            // Reset OTP attempts
            otpAttempts = 0;
            lastOtpSentTime = Date.now();
            
            // Disable resend button for 1 minute
            resendOtp.classList.add('disabled');
            resendOtp.textContent = 'Resend OTP (60s)';
            
            // Start countdown for resend button
            let secondsLeft = 60;
            otpResendTimer = setInterval(() => {
                secondsLeft--;
                resendOtp.textContent = `Resend OTP (${secondsLeft}s)`;
                
                if (secondsLeft <= 0) {
                    clearInterval(otpResendTimer);
                    resendOtp.classList.remove('disabled');
                    resendOtp.textContent = 'Resend OTP';
                }
            }, 1000);
        }

        // Show email/password form
        function showEmailPasswordForm() {
            authModalTitle.textContent = 'Sign Up - Part 3';
            authModalSubtitle.textContent = 'Create your account';
            
            loginForm.classList.remove('active');
            signupOtpForm.classList.remove('active');
            signupForm.classList.add('active');
            
            // Clear form
            signupEmail.value = '';
            signupPassword.value = '';
        }

        // Handle send OTP
        async function handleSendOtp() {
            const phoneNumber = signupPhone.value.trim();
            
            if (!phoneNumber) {
                showNotification('Please enter a phone number', 'error');
                return;
            }
            
            // Validate phone number format
            if (!/^\d+$/.test(phoneNumber)) {
                showNotification('Phone number should contain only digits', 'error');
                return;
            }
            
            try {
                // Disable button and show loading
                btnSendOtp.disabled = true;
                sendSpinner.style.display = 'inline-block';
                sendText.textContent = 'Sending SMS...';
                
                // Generate a 6-digit random code
                generatedCode = Math.floor(100000 + Math.random() * 900000).toString();
                
                // Prepare message (URL encoded)
                const message = `Your+verification+code+is:+${generatedCode}`;
                
                // Build the API URL
                const apiUrl = `https://www.textit.biz/sendmsg/?id=${TEXTIT_ID}&pw=${TEXTIT_PW}&to=${phoneNumber}&text=${message}`;
                
                // Make the API call
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`SMS gateway error: ${response.status}`);
                }
                
                const responseText = await response.text();
                
                // Check for success response (TextIt.biz returns "OK" on success)
                if (responseText.includes("OK")) {
                    showNotification(`Verification code sent to ${phoneNumber}`, 'success');
                    showOtpForm(phoneNumber);
                } else {
                    throw new Error(responseText);
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification("Failed to send verification code. Error: " + error.message, "error");
                
                // For testing purposes, show the code anyway
                showNotification(`Test mode: Would send code ${generatedCode} to ${phoneNumber}`, "error");
                showOtpForm(phoneNumber);
            } finally {
                // Re-enable button
                btnSendOtp.disabled = false;
                sendSpinner.style.display = 'none';
                sendText.textContent = 'Send Verification Code';
            }
        }

        // Handle login
        async function handleLogin() {
            const email = loginEmail.value.trim();
            const password = loginPassword.value.trim();
            
            if (!email || !password) {
                showNotification('Please fill all fields', 'warning');
                return;
            }
            
            try {
                btnLogin.disabled = true;
                btnLogin.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
                
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                
                // Save login info if "Remember me" is checked
                if (rememberMe.checked) {
                    saveLoginInfo(email, password);
                } else {
                    clearSavedLogin();
                }
                
                showNotification('Login successful!', 'success');
                hideAuthModal();
                updateUserProfile(userCredential.user);
                
                // If there's a pending lesson, show level selection
                if (currentLesson) {
                    showLevelModal(currentLesson);
                    currentLesson = null;
                }
            } catch (error) {
                console.error('Login error:', error);
                let message = 'Login failed. Please try again.';
                if (error.code === 'auth/user-not-found') {
                    message = 'User not found. Please sign up.';
                } else if (error.code === 'auth/wrong-password') {
                    message = 'Incorrect password. Please try again.';
                }
                showNotification(message, 'danger');
            } finally {
                btnLogin.disabled = false;
                btnLogin.textContent = 'Login';
            }
        }

        // Verify OTP
        async function verifyOtp() {
            const enteredCode = verificationCode.value.trim();
            
            if (!enteredCode) {
                showNotification("Please enter the verification code", "error");
                return;
            }
            
            if (enteredCode === generatedCode) {
                showNotification("✓ Phone number verified successfully!", "success");
                showEmailPasswordForm();
            } else {
                showNotification("Invalid verification code. Please try again.", "error");
            }
        }

        // Resend OTP
        async function resendOtpCode() {
            if (resendOtp.classList.contains('disabled')) return;
            
            try {
                resendOtp.classList.add('disabled');
                resendOtp.textContent = 'Sending...';
                
                // In a real app, you would resend the OTP via SMS gateway
                // For demo purposes, we'll simulate it
                setTimeout(() => {
                    showNotification('New OTP sent to your phone number', 'success');
                    
                    // Reset timer
                    clearInterval(otpResendTimer);
                    lastOtpSentTime = Date.now();
                    
                    // Disable resend button for 1 minute
                    let secondsLeft = 60;
                    resendOtp.textContent = `Resend OTP (${secondsLeft}s)`;
                    
                    otpResendTimer = setInterval(() => {
                        secondsLeft--;
                        resendOtp.textContent = `Resend OTP (${secondsLeft}s)`;
                        
                        if (secondsLeft <= 0) {
                            clearInterval(otpResendTimer);
                            resendOtp.classList.remove('disabled');
                            resendOtp.textContent = 'Resend OTP';
                        }
                    }, 1000);
                }, 1000);
            } catch (error) {
                console.error('Resend OTP error:', error);
                showNotification('Failed to resend OTP. Please try again.', 'danger');
                resendOtp.classList.remove('disabled');
                resendOtp.textContent = 'Resend OTP';
            }
        }

        // Handle signup
        async function handleSignup() {
            const email = signupEmail.value.trim();
            const password = signupPassword.value.trim();
            
            if (!email || !password) {
                showNotification('Please fill all fields', 'warning');
                return;
            }
            
            if (password.length < 6) {
                showNotification('Password must be at least 6 characters', 'warning');
                return;
            }
            
            try {
                btnSignup.disabled = true;
                btnSignup.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing up...';
                
                // Create user with email/password
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // Save login info if "Remember me" is checked
                const rememberMeSignup = document.getElementById('rememberMeSignup');
                if (rememberMeSignup.checked) {
                    saveLoginInfo(email, password);
                }
                
                showNotification('Account created successfully!', 'success');
                hideAuthModal();
                updateUserProfile(userCredential.user);
                
                // Show terms modal before student details
                showTermsModal();
            } catch (error) {
                console.error('Signup error:', error);
                let message = 'Signup failed. Please try again.';
                if (error.code === 'auth/email-already-in-use') {
                    message = 'Email already in use. Please login.';
                } else if (error.code === 'auth/weak-password') {
                    message = 'Password should be at least 6 characters';
                }
                showNotification(message, 'danger');
            } finally {
                btnSignup.disabled = false;
                btnSignup.textContent = 'Complete Sign Up';
            }
        }

        // Save student details
        async function saveStudentDetails(e) {
            e.preventDefault();
            
            const name = studentName.value.trim();
            const email = studentEmail.value.trim();
            const examYear = studentExamYear.value.trim();
            const school = studentSchool.value.trim();
            const district = studentDistrict.value.trim();
            const whatsapp = studentWhatsapp.value.trim();
            
            if (!name || !email || !examYear || !school || !district || !whatsapp) {
                showNotification('Please fill all fields', 'warning');
                return;
            }
            
            if (whatsapp.length !== 9 || !/^\d+$/.test(whatsapp)) {
                showNotification('Please enter a valid 9-digit WhatsApp number', 'warning');
                return;
            }
            
            try {
                btnSaveStudent.disabled = true;
                btnSaveStudent.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                
                const user = auth.currentUser;
                
                // Update user profile with display name
                await user.updateProfile({
                    displayName: name
                });
                
                // Save additional user data to Firestore
                const userData = {
                    uid: user.uid,
                    name,
                    email,
                    examYear: parseInt(examYear),
                    school,
                    district,
                    whatsapp: `+94${whatsapp}`,
                    profileCompleted: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    completedLevels: {}
                };
                
                await db.collection('users').doc(user.uid).set(userData, { merge: true });
                
                showNotification('Profile information saved successfully!', 'success');
                hideStudentModal();
                updateUserProfile(user);
                updateProfilePopup(user, userData);
                
                // If there's a pending lesson, show level selection
                if (currentLesson) {
                    showLevelModal(currentLesson);
                    currentLesson = null;
                }
            } catch (error) {
                console.error('Error saving student details:', error);
                showNotification('Failed to save information. Please try again.', 'danger');
            } finally {
                btnSaveStudent.disabled = false;
                btnSaveStudent.textContent = 'Save Information';
            }
        }

        // Format phone number
        function formatPhoneNumber() {
            let value = this.value.replace(/\D/g, '');
            if (value.length > 9) value = value.substring(0, 9);
            this.value = value;
        }

        // Start quiz
        function startQuiz(lessonId, level) {
            currentLesson = lessonId;
            currentLevel = level;
            quizActive = true;
            quizDuration = 30; // 30 minutes for all levels
            timeLeft = quizDuration * 60; // Convert minutes to seconds
            warned10 = false;
            warned5 = false;
            updateTimerDisplay();
            
            // Play start sound
            startSound.play();
            
            // Set quiz title
            quizTitle.textContent = `${lessonTitles[lessonId]} - Level ${level}`;
            
            // Show preloader before loading iframe
            quizIframe.onload = () => {
                // Hide preloader when iframe is loaded
            };
            
            // Load Google Form in iframe
            quizIframe.src = formUrls[lessonId][level - 1] || 'about:blank';
            
            // Show quiz container
            quizContainer.style.display = 'flex';
            
            // Start timer
            quizTimer = setInterval(updateQuizTimer, 1000);
            
            // Show notification
            showNotification(`Quiz started! You have 30 minutes to complete 15 questions.`, 'success');
            
            // Speak the time limit
            if ('speechSynthesis' in window) {
                const speech = new SpeechSynthesisUtterance();
                speech.text = `Your ${lessonTitles[lessonId]} Level ${level} quiz has started. You have 30 minutes to complete 15 questions. Good luck!`;
                window.speechSynthesis.speak(speech);
            }
            
            // Show back button
            backButton.classList.add('show');
        }

        // Update quiz timer
        function updateQuizTimer() {
            timeLeft--;
            updateTimerDisplay();
            
            // Check for warnings (10, 5 minutes remaining)
            const minutesLeft = Math.ceil(timeLeft / 60);
            
            if (minutesLeft === 10 && !warned10) {
                showTimeWarning(`You have 10 minutes remaining to complete your quiz.`);
                warningSound.play();
                warned10 = true;
            } else if (minutesLeft === 5 && !warned5) {
                showTimeWarning(`Only 5 minutes left! Make sure to submit your answers.`);
                warningSound.play();
                warned5 = true;
            } else if (timeLeft <= 0) {
                // Time's up
                timeUpSound.play();
                endQuiz(true);
            }
        }

        // Update timer display
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            quizTimerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Change color when time is running low
            if (timeLeft <= quizDuration * 60 * 0.25) {
                quizTimerDisplay.style.color = 'var(--danger)';
            } else if (timeLeft <= quizDuration * 60 * 0.5) {
                quizTimerDisplay.style.color = 'var(--warning)';
            } else {
                quizTimerDisplay.style.color = 'white';
            }
        }

        // Show time warning
        function showTimeWarning(message) {
            document.getElementById('timeWarningMessage').textContent = message;
            timeWarningModal.style.display = 'flex';
            setTimeout(() => {
                timeWarningModal.querySelector('.alert-content').style.transform = 'scale(1)';
                timeWarningModal.querySelector('.alert-content').style.opacity = '1';
            }, 10);
            
            // Also show floating notification
            showNotification(message, 'warning');
            
            // Speak the warning
            if ('speechSynthesis' in window) {
                const speech = new SpeechSynthesisUtterance();
                speech.text = message;
                window.speechSynthesis.speak(speech);
            }
        }

        // End quiz
        async function endQuiz(timeExpired = false) {
            clearInterval(quizTimer);
            quizActive = false;
            
            // Update user's completed levels in Firestore if logged in
            if (auth.currentUser && currentLesson && currentLevel) {
                try {
                    const userRef = db.collection('users').doc(auth.currentUser.uid);
                    const userDoc = await userRef.get();
                    
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        const completedLevels = userData.completedLevels || {};
                        
                        if (!completedLevels[currentLesson]) {
                            completedLevels[currentLesson] = [];
                        }
                        
                        if (!completedLevels[currentLesson].includes(currentLevel)) {
                            completedLevels[currentLesson].push(currentLevel);
                            await userRef.update({
                                completedLevels: completedLevels
                            });
                            
                            // Update the profile popup with new data
                            updateProfilePopup(auth.currentUser, { ...userData, completedLevels });
                            
                            // If this was level 1 and user is not logged in, show auth modal
                            if (currentLevel === 1 && !auth.currentUser) {
                                showNotification('Please login or sign up to access more levels', 'info');
                                showAuthModal('signup');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error updating completed levels:', error);
                }
            }
            
            if (timeExpired) {
                // Show time up modal
                timeUpModal.style.display = 'flex';
                setTimeout(() => {
                    timeUpModal.querySelector('.alert-content').style.transform = 'scale(1)';
                    timeUpModal.querySelector('.alert-content').style.opacity = '1';
                }, 10);
            }
        }

        // Close quiz
        async function closeQuiz() {
            if (quizActive) {
                if (confirm('Are you sure you want to close the quiz? Your progress may be lost.')) {
                    clearInterval(quizTimer);
                    quizContainer.style.display = 'none';
                    quizIframe.src = '';
                    quizActive = false;
                }
            } else {
                quizContainer.style.display = 'none';
                quizIframe.src = '';
            }
            
            // Hide back button
            backButton.classList.remove('show');
            
            // If user just completed level 1 as guest, show auth modal
            if (currentLevel === 1 && !auth.currentUser) {
                showNotification('Please login or sign up to access more levels', 'info');
                showAuthModal('signup');
            }
        }

        // Hide alert modal
        function hideAlertModal(modal) {
            modal.querySelector('.alert-content').style.transform = 'scale(0.9)';
            modal.querySelector('.alert-content').style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        // Show notification
        function showNotification(message, type = 'info') {
            notificationMessage.textContent = message;
            floatingNotification.className = `notification ${type}`;
            floatingNotification.classList.add('show');
            
            setTimeout(() => {
                floatingNotification.classList.remove('show');
            }, 5000);
        }

        // Toggle auth modal
        function toggleAuthModal() {
            if (auth.currentUser) {
                // User is logged in, show profile popup
                toggleProfilePopup();
            } else {
                showAuthModal('login');
            }
        }

        // Handle back button
        function handleBackButton() {
            if (quizContainer.style.display === 'flex') {
                closeQuiz();
            } else {
                // Handle other back button cases if needed
            }
        }

        // Handle beforeunload event
        function handleBeforeUnload(e) {
            if (quizActive) {
                e.preventDefault();
                e.returnValue = 'Are you sure you want to leave? Your quiz progress may be lost.';
                return e.returnValue;
            }
        }

        // Simple particles effect
        function initParticles() {
            const particles = document.querySelector('.particles');
            const particleCount = 30;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.style.position = 'absolute';
                particle.style.width = `${Math.random() * 5 + 2}px`;
                particle.style.height = particle.style.width;
                particle.style.backgroundColor = `rgba(255, 255, 255, ${Math.random() * 0.5 + 0.1})`;
                particle.style.borderRadius = '50%';
                particle.style.top = `${Math.random() * 100}%`;
                particle.style.left = `${Math.random() * 100}%`;
                
                // Animation
                const duration = Math.random() * 20 + 10;
                const delay = Math.random() * 5;
                particle.style.animation = `float ${duration}s ease-in-out ${delay}s infinite`;
                
                particles.appendChild(particle);
            }
        }

        // Preloader
        window.addEventListener('load', function() {
            setTimeout(function() {
                document.querySelector('.preloader').classList.add('fade-out');
                
                setTimeout(function() {
                    document.querySelector('.preloader').style.display = 'none';
                }, 500);
            }, 1500);
        });

        // Initialize the app
        init();
    </script>
</body>
</html>
