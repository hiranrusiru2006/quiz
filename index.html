<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ET Panthiya.lk Quiz Portal 2025</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <style>
        :root {
            --primary: #6c5ce7;
            --primary-dark: #5649c7;
            --secondary: #a29bfe;
            --accent: #fd79a8;
            --dark: #2d3436;
            --light: #f5f6fa;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #d63031;
            --info: #0984e3;
            --card-bg: rgba(255, 255, 255, 0.9);
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            --border-radius: 12px;
            --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --silver: #C0C0C0;
            --gold: #FFD700;
            --diamond: #b9f2ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            background-attachment: fixed;
        }

        /* Preloader Styles */
        .preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .preloader.fade-out {
            opacity: 0;
        }

        .loader {
            width: 80px;
            height: 80px;
            position: relative;
        }

        .loader div {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent);
            animation: load 1.2s linear infinite;
        }

        .loader div:nth-child(1) {
            top: 8px;
            left: 8px;
            animation-delay: 0s;
        }

        .loader div:nth-child(2) {
            top: 8px;
            left: 32px;
            animation-delay: -0.4s;
        }

        .loader div:nth-child(3) {
            top: 8px;
            left: 56px;
            animation-delay: -0.8s;
        }

        .loader div:nth-child(4) {
            top: 32px;
            left: 8px;
            animation-delay: -0.4s;
        }

        .loader div:nth-child(5) {
            top: 32px;
            left: 32px;
            animation-delay: -0.8s;
        }

        .loader div:nth-child(6) {
            top: 32px;
            left: 56px;
            animation-delay: -1.2s;
        }

        .loader div:nth-child(7) {
            top: 56px;
            left: 8px;
            animation-delay: -0.8s;
        }

        .loader div:nth-child(8) {
            top: 56px;
            left: 32px;
            animation-delay: -1.2s;
        }

        .loader div:nth-child(9) {
            top: 56px;
            left: 56px;
            animation-delay: -1.6s;
        }

        @keyframes load {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(0.5);
                opacity: 0.5;
            }
        }

        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 18px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* Terms Modal */
        .terms-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9998;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .terms-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            box-shadow: var(--box-shadow);
            transform: scale(0.9);
            opacity: 0;
            transition: var(--transition);
            overflow: hidden;
            max-height: 80vh;
            overflow-y: auto;
        }

        .terms-modal.show .terms-content {
            transform: scale(1);
            opacity: 1;
        }

        .terms-header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .terms-header h2 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .terms-body {
            padding: 30px;
            color: var(--text-primary);
        }

        .terms-body h3 {
            margin: 15px 0 10px;
            color: var(--primary);
        }

        .terms-body p {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .terms-body ul {
            margin-bottom: 15px;
            padding-left: 20px;
        }

        .terms-body li {
            margin-bottom: 8px;
        }

        .terms-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .terms-checkbox {
            display: flex;
            align-items: center;
        }

        .terms-checkbox input {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }

        .btn-terms {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-terms:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-terms:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4);
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
            display: none;
        }

        .container.show {
            opacity: 1;
            transform: translateY(0);
            display: block;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            color: white;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            font-weight: 800;
            background: linear-gradient(to right, #fff, #a29bfe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: var(--light);
            font-size: 1.1rem;
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .greeting {
            color: var(--light);
            font-size: 1.2rem;
            margin-top: 10px;
            font-weight: 600;
        }

        .logo-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            border: 4px solid white;
            margin: 0 auto 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(255,255,255,0.2);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .logo-circle img {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
        }

        /* Banner */
        .banner {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 30px;
            color: white;
            text-align: center;
            box-shadow: var(--box-shadow);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .banner h2 {
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .banner p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .updated-date {
            font-size: 0.9rem;
            margin-top: 5px;
            color: rgba(255,255,255,0.7);
            font-style: italic;
        }

        /* Lessons Grid */
        .lessons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .lesson-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
            border: none;
        }

        .lesson-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .lesson-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, var(--primary), var(--accent));
        }

        .lesson-card .lesson-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 3px solid var(--light);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .lesson-card h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .lesson-card p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .lesson-meta {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .time-indicator, .question-count {
            display: inline-block;
            background: rgba(108, 92, 231, 0.1);
            color: var(--primary);
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .dropdown {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .dropdown-btn {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
            width: 100%;
        }

        .dropdown-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(108, 92, 231, 0.4);
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
        }

        .dropdown-content a {
            color: var(--text-primary);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: var(--transition);
        }

        .dropdown-content a:hover {
            background-color: #f1f1f1;
            border-radius: 8px;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        /* Auth Modals */
        .auth-modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            overflow-y: auto;
        }

        .auth-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--box-shadow);
            transform: scale(0.9);
            opacity: 0;
            transition: var(--transition);
            overflow: hidden;
            margin: 20px 0;
            position: relative;
        }

        .auth-modal.show .auth-content {
            transform: scale(1);
            opacity: 1;
        }

        .auth-header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .auth-header h2 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .auth-header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .close-auth {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.2);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .close-auth:hover {
            background: rgba(0,0,0,0.4);
            transform: rotate(90deg);
        }

        .auth-body {
            padding: 30px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .auth-tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: var(--transition);
            border-bottom: 3px solid transparent;
        }

        .auth-tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-group input:focus, .form-group select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
            outline: none;
        }

        .phone-input {
            display: flex;
            align-items: center;
        }

        .phone-input .prefix {
            background: #f5f6fa;
            padding: 12px;
            border: 1px solid #ddd;
            border-right: none;
            border-radius: 8px 0 0 8px;
            font-weight: 600;
        }

        .phone-input input {
            border-radius: 0 8px 8px 0 !important;
        }

        .btn-auth {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
            margin-top: 10px;
        }

        .btn-auth:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(108, 92, 231, 0.4);
        }

        .auth-footer {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .auth-footer a {
            color: var(--primary);
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
        }

        .otp-container {
            display: none;
        }

        .otp-inputs {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .otp-inputs input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 1.2rem;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .otp-inputs input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
        }

        .resend-otp {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .resend-otp a {
            color: var(--primary);
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
        }

        .resend-otp a.disabled {
            color: var(--text-secondary);
            pointer-events: none;
        }

        /* Student Details Modal */
        .student-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            overflow-y: auto;
        }

        .student-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--box-shadow);
            transform: scale(0.9);
            opacity: 0;
            transition: var(--transition);
            overflow: hidden;
            margin: 20px 0;
        }

        .student-modal.show .student-content {
            transform: scale(1);
            opacity: 1;
        }

        .student-header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .student-header h2 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .student-header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .close-student {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.2);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .close-student:hover {
            background: rgba(0,0,0,0.4);
            transform: rotate(90deg);
        }

        .student-body {
            padding: 30px;
        }

        /* Important Notice Modal */
        .notice-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1002;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            overflow-y: auto;
        }

        .notice-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--box-shadow);
            transform: scale(0.9);
            opacity: 0;
            transition: var(--transition);
            overflow: hidden;
            margin: 20px 0;
        }

        .notice-modal.show .notice-content {
            transform: scale(1);
            opacity: 1;
        }

        .notice-header {
            background: var(--warning);
            color: var(--dark);
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .notice-header h2 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .notice-body {
            padding: 30px;
            color: var(--text-primary);
        }

        .notice-body p {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .btn-notice {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
            margin-top: 20px;
        }

        .btn-notice:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(108, 92, 231, 0.4);
        }

        /* Quiz Container */
        .quiz-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1003;
            flex-direction: column;
        }

        .quiz-header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .quiz-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .timer {
            background: rgba(0,0,0,0.2);
            padding: 5px 15px;
            border-radius: 50px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .timer i {
            margin-right: 8px;
        }

        .quiz-iframe {
            flex: 1;
            border: none;
            width: 100%;
        }

        .btn-close-quiz {
            background: var(--danger);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            margin-left: 15px;
        }

        .btn-close-quiz:hover {
            transform: rotate(90deg);
        }

        /* Alert Modal */
        .alert-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1004;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .alert-content {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: var(--box-shadow);
            transform: scale(0.9);
            opacity: 0;
            transition: var(--transition);
        }

        .alert-modal.show .alert-content {
            transform: scale(1);
            opacity: 1;
        }

        .alert-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .alert-icon.warning {
            color: var(--warning);
        }

        .alert-icon.danger {
            color: var(--danger);
        }

        .alert-title {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .alert-message {
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .btn-alert {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-block;
        }

        .btn-alert:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4);
        }

        /* Welcome Modal */
        .welcome-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1005;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .welcome-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--box-shadow);
            transform: scale(0.9);
            opacity: 0;
            transition: var(--transition);
            overflow: hidden;
        }

        .welcome-modal.show .welcome-content {
            transform: scale(1);
            opacity: 1;
        }

        .welcome-header {
            height: 150px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .welcome-header img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid white;
            object-fit: cover;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .welcome-body {
            padding: 30px;
            text-align: center;
        }

        .welcome-body h2 {
            color: var(--primary);
            margin-bottom: 15px;
        }

        .welcome-body p {
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* Floating Notification */
        .notification {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--dark);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            z-index: 999;
            transform: translateX(150%);
            transition: var(--transition);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification i {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .notification.warning {
            background: var(--warning);
            color: var(--dark);
        }

        .notification.danger {
            background: var(--danger);
        }

        .notification.success {
            background: var(--success);
        }

        /* WhatsApp Floating Button */
        .whatsapp-float {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 60px;
            height: 60px;
            background: #25D366;
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            z-index: 999;
            cursor: pointer;
            transition: var(--transition);
            animation: pulse-whatsapp 2s infinite;
        }

        .whatsapp-float:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        @keyframes pulse-whatsapp {
            0% {
                box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(37, 211, 102, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(37, 211, 102, 0);
            }
        }

        /* Particles Background */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        /* ET Panthiya Link */
        .etpanthiya-link {
            display: inline-block;
            margin-top: 30px;
            background: linear-gradient(to right, #00b894, #00cec9);
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0, 184, 148, 0.3);
            transition: var(--transition);
            margin-right: 15px;
        }

        .whatsapp-group-link {
            display: inline-block;
            margin-top: 30px;
            background: linear-gradient(to right, #25D366, #128C7E);
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.3);
            transition: var(--transition);
        }

        .etpanthiya-link:hover, .whatsapp-group-link:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 184, 148, 0.4);
        }

        .etpanthiya-link i, .whatsapp-group-link i {
            margin-right: 8px;
        }

        .links-container {
            text-align: center;
            margin-bottom: 30px;
        }

        /* Back Button */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.5);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
        }

        .back-button.show {
            opacity: 1;
            pointer-events: auto;
        }

        .back-button:hover {
            background: rgba(0,0,0,0.7);
            transform: translateX(-3px);
        }

        /* User Profile */
        .user-profile {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(5px);
            padding: 5px 10px 5px 5px;
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
            z-index: 999;
        }

        .user-profile:hover {
            background: rgba(255,255,255,0.3);
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            margin-right: 8px;
        }

        .user-name {
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
            display: none; /* Hide the full name */
        }

        /* Profile Modal */
        .profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1006;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .profile-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--box-shadow);
            transform: scale(0.9);
            opacity: 0;
            transition: var(--transition);
            overflow: hidden;
        }

        .profile-modal.show .profile-content {
            transform: scale(1);
            opacity: 1;
        }

        .profile-header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .profile-header h2 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            font-weight: 600;
            margin: 0 auto 15px;
            border: 3px solid white;
        }

        .profile-body {
            padding: 30px;
        }

        .profile-info {
            margin-bottom: 20px;
        }

        .profile-info p {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .profile-info p span:first-child {
            font-weight: 600;
            color: var(--text-primary);
        }

        .profile-info p span:last-child {
            color: var(--text-secondary);
        }

        .badge-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .badge {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .badge-silver {
            background: var(--silver);
            color: #333;
        }

        .badge-gold {
            background: var(--gold);
            color: #333;
        }

        .badge-diamond {
            background: var(--diamond);
            color: #333;
        }

        .badge-label {
            position: absolute;
            bottom: -20px;
            left: 0;
            right: 0;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .profile-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        .btn-delete-account {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-delete-account:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(214, 48, 49, 0.4);
        }

        .btn-logout {
            background: var(--warning);
            color: var(--dark);
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-logout:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(253, 203, 110, 0.4);
        }

        /* Delete Account Modal */
        .delete-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1007;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .delete-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--box-shadow);
            transform: scale(0.9);
            opacity: 0;
            transition: var(--transition);
            overflow: hidden;
        }

        .delete-modal.show .delete-content {
            transform: scale(1);
            opacity: 1;
        }

        .delete-header {
            background: var(--danger);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .delete-header h2 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .delete-body {
            padding: 30px;
            text-align: center;
        }

        .delete-body p {
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .delete-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        /* Verify Phone Modal */
        .verify-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1008;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .verify-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--box-shadow);
            transform: scale(0.9);
            opacity: 0;
            transition: var(--transition);
            overflow: hidden;
        }

        .verify-modal.show .verify-content {
            transform: scale(1);
            opacity: 1;
        }

        .verify-header {
            background: var(--warning);
            color: var(--dark);
            padding: 20px;
            text-align: center;
        }

        .verify-header h2 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .verify-body {
            padding: 30px;
        }

        .verify-body p {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .verify-otp-inputs {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .verify-otp-inputs input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 1.2rem;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .verify-otp-inputs input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
        }

        .verify-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        /* Delete Confirmation Modal */
        .confirm-delete-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1009;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .confirm-delete-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--box-shadow);
            transform: scale(0.9);
            opacity: 0;
            transition: var(--transition);
            overflow: hidden;
        }

        .confirm-delete-modal.show .confirm-delete-content {
            transform: scale(1);
            opacity: 1;
        }

        .confirm-delete-header {
            background: var(--danger);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .confirm-delete-header h2 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .confirm-delete-body {
            padding: 30px;
        }

        .confirm-delete-body p {
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .confirm-delete-note {
            background: #fff8e1;
            border-left: 4px solid var(--warning);
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .confirm-delete-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        .btn-cancel-delete {
            background: var(--secondary);
            color: white;
        }

        .btn-confirm-delete {
            background: var(--danger);
            color: white;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .dropdown-content {
                position: relative;
                box-shadow: none;
                border: 1px solid #ddd;
                margin-top: 5px;
            }
            
            .auth-content, .student-content, .notice-content {
                margin: 10px 0;
            }
            
            .auth-body, .student-body, .notice-body {
                padding: 20px;
            }
            
            .terms-content {
                max-height: 70vh;
            }
            
            .profile-footer, .delete-footer, .verify-footer {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn-delete-account, .btn-logout {
                width: 100%;
            }
        }

        @media (max-width: 576px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .lesson-card {
                padding: 15px;
            }
            
            .lesson-card h3 {
                font-size: 1.1rem;
            }

            .auth-content {
                padding: 15px;
            }

            .whatsapp-float {
                width: 50px;
                height: 50px;
                font-size: 25px;
                bottom: 20px;
                left: 20px;
            }

            .logo-circle {
                width: 150px;
                height: 150px;
            }

            .logo-circle img {
                width: 130px;
                height: 130px;
            }

            .etpanthiya-link, .whatsapp-group-link {
                display: block;
                margin: 15px auto;
                width: 90%;
                max-width: 300px;
            }
            
            .auth-tabs {
                justify-content: space-between;
            }
            
            .auth-tab {
                padding: 10px;
                font-size: 0.9rem;
            }
            
            .otp-inputs input, .verify-otp-inputs input {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            /* Mobile keyboard fix */
            .student-modal {
                align-items: flex-start;
                padding-top: 20px;
            }
            
            .student-content {
                margin-top: 20px;
            }
            
            .terms-footer {
                flex-direction: column;
                gap: 15px;
            }
            
            .terms-checkbox {
                margin-bottom: 10px;
            }
            
            .btn-terms {
                width: 100%;
            }
        }

        /* Animation Classes */
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        /* Form Preloader */
        .form-preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        .form-preloader .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Preloader -->
    <div class="preloader">
        <div class="loader">
            <div></div><div></div><div></div>
            <div></div><div></div><div></div>
            <div></div><div></div><div></div>
        </div>
        <div class="loading-text">Loading Interactive Quiz Portal</div>
    </div>

    <!-- Form Preloader -->
    <div class="form-preloader">
        <div class="loader"></div>
    </div>

    <!-- Terms and Conditions Modal -->
    <div class="terms-modal" id="termsModal">
        <div class="terms-content">
            <div class="terms-header">
                <h2>Terms and Conditions</h2>
                <button class="close-auth" id="closeTerms">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="terms-body">
                <h3>Welcome to ET Panthiya.lk Quiz Portal</h3>
                <p>Please read these terms and conditions carefully before using our service.</p>
                
                <h3>1. Acceptance of Terms</h3>
                <p>By accessing or using the ET Panthiya.lk Quiz Portal, you agree to be bound by these Terms. If you disagree with any part of the terms, you may not access the service.</p>
                
                <h3>2. User Accounts</h3>
                <p>When you create an account with us, you must provide accurate and complete information. You are responsible for maintaining the confidentiality of your account and password.</p>
                
                <h3>3. Privacy Policy</h3>
                <p>Your privacy is important to us. Please read our Privacy Policy which explains how we collect, use, and protect your personal information.</p>
                
                <h3>4. User Responsibilities</h3>
                <ul>
                    <li>You must not use the service for any illegal or unauthorized purpose</li>
                    <li>You must not attempt to gain unauthorized access to any part of the service</li>
                    <li>You must not interfere with or disrupt the service or servers connected to the service</li>
                    <li>You must not use the service to harass, abuse, or harm others</li>
                </ul>
                
                <h3>5. Intellectual Property</h3>
                <p>The service and its original content, features, and functionality are owned by ET Panthiya.lk and are protected by international copyright, trademark, and other intellectual property laws.</p>
                
                <h3>6. Limitation of Liability</h3>
                <p>ET Panthiya.lk shall not be liable for any indirect, incidental, special, consequential or punitive damages resulting from your use of or inability to use the service.</p>
                
                <h3>7. Changes to Terms</h3>
                <p>We reserve the right to modify or replace these Terms at any time. We will provide notice of any changes by posting the new Terms on this page.</p>
            </div>
            <div class="terms-footer">
                <div class="terms-checkbox">
                    <input type="checkbox" id="acceptTerms">
                    <label for="acceptTerms">I accept the Terms and Conditions</label>
                </div>
                <button class="btn-terms" id="btnAcceptTerms" disabled>Continue</button>
            </div>
        </div>
    </div>

    <!-- Back Button -->
    <div class="back-button" id="backButton">
        <i class="fas fa-arrow-left"></i>
    </div>

    <!-- User Profile -->
    <div class="user-profile" id="userProfile">
        <div class="user-avatar" id="userAvatar">G</div>
    </div>

    <!-- Particles Background -->
    <div class="particles" id="particles-js"></div>

    <!-- WhatsApp Floating Button -->
    <div class="whatsapp-float" id="whatsappButton">
        <i class="fab fa-whatsapp"></i>
    </div>

    <!-- Main Container -->
    <div class="container">
        <div class="header">
            <div class="logo-circle">
                <img src="https://via.placeholder.com/160x160" alt="Quiz Logo">
            </div>
            <h1>ET Panthiya.lk Quiz Portal</h1>
            <p>"The Quiz Portal"  ET Panthiya.lk අපේ වැඩක් ✨🎉. Enjoy & Learn 😎😜</p>
            <div class="greeting" id="greeting"></div>
        </div>

        <!-- Links Container -->
        <div class="links-container">
            <a href="https://etpanthiya.lk" class="etpanthiya-link" target="_blank">
                <i class="fas fa-external-link-alt"></i> Visit ET Panthiya
            </a>
            <a href="https://wa.me/94779817525?text=Hello%20Quiz%20Support,%20I%20need%20help%20with..." class="whatsapp-group-link" target="_blank">
                <i class="fab fa-whatsapp"></i> Join WhatsApp Group
            </a>
        </div>

        <!-- Banner -->
        <div class="banner pulse">
            <h2>🚀 Important Notice!</h2>
            <p>පාඩම් 17 න්ම MCQ අපි Upload කරනවා. Update කරපු දවසේ ඉදන් දවස් 14 කට පස්සෙ අපි ආයේ අලුත්   MCQ Add කරනවා 😍 පාඩමෙන් පාඩමට තියෙන ප්‍රශ්න ගානයි Time එකයි ඔයාලට බලාගන්න පුලුවන්. 
උපකාරක සේවාව සදහා  පහත WhatsApp Button එක ඔස්සෙ අප සමග සම්බන්ද වන්න 
All The best 😚!</p>
            <div class="updated-date">Last updated: June 15, 2025</div>
        </div>

        <!-- Lessons Grid -->
        <div class="lessons-grid">
            <!-- Lesson cards will be populated dynamically -->
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-content">
            <div class="auth-header">
                <h2 id="authModalTitle">Welcome Back!</h2>
                <p id="authModalSubtitle">Please login to continue</p>
                <button class="close-auth" id="closeAuth">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="auth-body">
                <div class="auth-tabs">
                    <div class="auth-tab active" data-tab="login">Login</div>
                    <div class="auth-tab" data-tab="signup">Sign Up</div>
                </div>
                
                <!-- Login Form -->
                <div class="auth-form active" id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password">
                    </div>
                    <button class="btn-auth" id="btnLogin">Login</button>
                    <div class="auth-footer">
                        Don't have an account? <a id="showSignup">Sign up</a>
                    </div>
                </div>
                
                <!-- Signup Form Part 1 - Phone Verification -->
                <div class="auth-form" id="signupPhoneForm">
                    <div class="form-group">
                        <label for="signupPhone">Phone Number</label>
                        <div class="phone-input">
                            <span class="prefix">+94</span>
                            <input type="tel" id="signupPhone" placeholder="7XXXXXXXX" maxlength="9">
                        </div>
                    </div>
                    <button class="btn-auth" id="btnSendOtp">Send Verification Code</button>
                </div>
                
                <!-- Signup Form Part 2 - OTP Verification -->
                <div class="auth-form" id="signupOtpForm">
                    <div class="form-group">
                        <label>OTP Verification</label>
                        <p>We've sent a 6-digit code to +94<span id="otpPhoneNumber"></span></p>
                    </div>
                    <div class="form-group">
                        <div class="otp-inputs">
                            <input type="text" maxlength="1" class="otp-input">
                            <input type="text" maxlength="1" class="otp-input">
                            <input type="text" maxlength="1" class="otp-input">
                            <input type="text" maxlength="1" class="otp-input">
                            <input type="text" maxlength="1" class="otp-input">
                            <input type="text" maxlength="1" class="otp-input">
                        </div>
                    </div>
                    <button class="btn-auth" id="btnVerifyOtp">Verify OTP</button>
                    <div class="resend-otp">
                        Didn't receive code? <a id="resendOtp">Resend OTP</a>
                    </div>
                </div>
                
                <!-- Signup Form Part 3 - Email & Password -->
                <div class="auth-form" id="signupForm">
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" placeholder="Create a password (min 6 chars)">
                    </div>
                    <button class="btn-auth" id="btnSignup">Complete Sign Up</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div class="student-modal" id="studentModal">
        <div class="student-content">
            <div class="student-header">
                <h2>Student Information</h2>
                <p>Please provide your details to continue</p>
                <button class="close-student" id="closeStudent">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="student-body">
                <form id="studentForm">
                    <div class="form-group">
                        <label for="studentName">Full Name</label>
                        <input type="text" id="studentName" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label for="studentGender">Gender</label>
                        <select id="studentGender" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="studentEmail">Email</label>
                        <input type="email" id="studentEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="studentExamYear">Exam Year</label>
                        <input type="number" id="studentExamYear" min="2023" max="2030" placeholder="Enter exam year" required>
                    </div>
                    <div class="form-group">
                        <label for="studentSchool">School</label>
                        <input type="text" id="studentSchool" placeholder="Enter your school" required>
                    </div>
                    <div class="form-group">
                        <label for="studentDistrict">District</label>
                        <input type="text" id="studentDistrict" placeholder="Enter your district" required>
                    </div>
                    <div class="form-group">
                        <label for="studentWhatsapp">WhatsApp Number</label>
                        <div class="phone-input">
                            <span class="prefix">+94</span>
                            <input type="tel" id="studentWhatsapp" placeholder="7XXXXXXXX" maxlength="9" required>
                        </div>
                    </div>
                    <button type="submit" class="btn-auth" id="btnSaveStudent">Save Information</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Important Notice Modal -->
    <div class="notice-modal" id="noticeModal">
        <div class="notice-content">
            <div class="notice-header">
                <h2>IMPORTANT</h2>
                <button class="close-student" id="closeNotice">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="notice-body">
                <p>"Please note that the information below is collected solely to collect feedback from users of our software and to properly maintain our software updates. Please be advised that any information you enter will not be shared with any other party in any way."</p>
                <p>"පහත තොරතුරු ලබා ගනුයේ අපගේ මෘදුකාංගය භාවිතා කරන පරීශීලකයින් පිලිබද අදහස් ලබාගෙන අපගේ මෘදුකාංගයේ යාවත්කාලීන කටයුතු නිසියාකාරව පවත්වා ගැනීමට පමණක් බව කරුණාවෙන් සලකන්න . ඔබ ඇතුළත් කරන කිසිදු තොරතුරක් කිසිදු ආකරයකින් වෙනත් පාර්ශවයක් වෙත නොලැබෙන බව කාරුණිකව දන්වා සිටිමු"</p>
                <button class="btn-notice" id="btnAcceptNotice">I Understand</button>
            </div>
        </div>
    </div>

    <!-- Quiz Container -->
    <div class="quiz-container" id="quizContainer">
        <div class="quiz-header">
            <div class="quiz-title" id="quizTitle">Quiz Title</div>
            <div class="timer">
                <i class="fas fa-clock"></i>
                <span id="quizTimer">30:00</span>
            </div>
            <button class="btn-close-quiz" id="btnCloseQuiz">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <iframe class="quiz-iframe" id="quizIframe" frameborder="0"></iframe>
    </div>

    <!-- Time Warning Modal -->
    <div class="alert-modal" id="timeWarningModal">
        <div class="alert-content">
            <div class="alert-icon warning">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="alert-title">Time Warning!</h3>
            <p class="alert-message" id="timeWarningMessage">You have 10 minutes remaining to complete your quiz.</p>
            <button class="btn-alert" id="btnAcknowledgeWarning">Continue Quiz</button>
        </div>
    </div>

    <!-- Time Up Modal -->
    <div class="alert-modal" id="timeUpModal">
        <div class="alert-content">
            <div class="alert-icon danger">
                <i class="fas fa-hourglass-end"></i>
            </div>
            <h3 class="alert-title">Time's Up!</h3>
            <p class="alert-message">Your quiz time has expired. The quiz will now be submitted automatically.</p>
            <button class="btn-alert" id="btnAcknowledgeTimeUp">OK</button>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="profile-modal" id="profileModal">
        <div class="profile-content">
            <div class="profile-header">
                <div class="profile-avatar" id="profileAvatar">U</div>
                <h2>User Profile</h2>
                <p id="profileEmail">user@example.com</p>
                <button class="close-auth" id="closeProfile">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="profile-body">
                <div class="profile-info">
                    <p><span>Name:</span> <span id="profileName">User Name</span></p>
                    <p><span>Gender:</span> <span id="profileGender">Male</span></p>
                    <p><span>Exam Year:</span> <span id="profileExamYear">2025</span></p>
                    <p><span>School:</span> <span id="profileSchool">School Name</span></p>
                    <p><span>District:</span> <span id="profileDistrict">District</span></p>
                    <p><span>WhatsApp:</span> <span id="profileWhatsapp">+947XXXXXXXX</span></p>
                    <p><span>Completed Levels:</span> <span id="profileCompletedLevels">0/17</span></p>
                </div>
                
                <div class="badge-container">
                    <div class="badge badge-silver" id="badgeSilver">
                        <i class="fas fa-award"></i>
                        <span class="badge-label">Silver</span>
                    </div>
                    <div class="badge badge-gold" id="badgeGold" style="display: none;">
                        <i class="fas fa-award"></i>
                        <span class="badge-label">Gold</span>
                    </div>
                    <div class="badge badge-diamond" id="badgeDiamond" style="display: none;">
                        <i class="fas fa-gem"></i>
                        <span class="badge-label">Diamond</span>
                    </div>
                </div>
            </div>
            <div class="profile-footer">
                <button class="btn-delete-account" id="btnDeleteAccount">Delete Account</button>
                <button class="btn-logout" id="btnLogout">Logout</button>
            </div>
        </div>
    </div>

    <!-- Delete Account Modal -->
    <div class="delete-modal" id="deleteModal">
        <div class="delete-content">
            <div class="delete-header">
                <h2>Delete Account</h2>
                <p>This action cannot be undone</p>
            </div>
            <div class="delete-body">
                <p>Are you sure you want to delete your account? All your data including completed levels will be permanently removed.</p>
                <p>You will need to verify your phone number to confirm this action.</p>
            </div>
            <div class="delete-footer">
                <button class="btn-alert" id="btnCancelDelete">Cancel</button>
                <button class="btn-delete-account" id="btnConfirmDelete">Delete Account</button>
            </div>
        </div>
    </div>

    <!-- Verify Phone Modal -->
    <div class="verify-modal" id="verifyModal">
        <div class="verify-content">
            <div class="verify-header">
                <h2>Verify Phone Number</h2>
                <p>Enter the OTP sent to your phone</p>
            </div>
            <div class="verify-body">
                <p>We've sent a 6-digit verification code to <span id="verifyPhoneNumber">+947XXXXXXXX</span></p>
                <div class="verify-otp-inputs">
                    <input type="text" maxlength="1" class="verify-otp-input">
                    <input type="text" maxlength="1" class="verify-otp-input">
                    <input type="text" maxlength="1" class="verify-otp-input">
                    <input type="text" maxlength="1" class="verify-otp-input">
                    <input type="text" maxlength="1" class="verify-otp-input">
                    <input type="text" maxlength="1" class="verify-otp-input">
                </div>
                <div class="resend-otp">
                    Didn't receive code? <a id="resendVerifyOtp">Resend OTP</a>
                </div>
            </div>
            <div class="verify-footer">
                <button class="btn-alert" id="btnCancelVerify">Cancel</button>
                <button class="btn-auth" id="btnVerifyDelete">Verify & Delete</button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="confirm-delete-modal" id="confirmDeleteModal">
        <div class="confirm-delete-content">
            <div class="confirm-delete-header">
                <h2>Confirm Account Deletion</h2>
                <p>Final confirmation required</p>
            </div>
            <div class="confirm-delete-body">
                <p>You are about to permanently delete your account and all associated data.</p>
                
                <div class="confirm-delete-note">
                    <p><strong>Important Note:</strong> This action will delete your account permanently and you won't be able to use our app again. If you need any data removed from our servers, please contact support.</p>
                    <a href="https://wa.me/94779817525?text=DELETE%20MY%20ALL%20CREDITIONALS" class="whatsapp-group-link" target="_blank" style="margin-top: 10px; display: inline-block;">
                        <i class="fab fa-whatsapp"></i> Contact Support via WhatsApp
                    </a>
                </div>
                
                <p>To proceed with account deletion, click the "Delete My Account" button below.</p>
            </div>
            <div class="confirm-delete-footer">
                <button class="btn-alert btn-cancel-delete" id="btnFinalCancelDelete">Cancel</button>
                <button class="btn-alert btn-confirm-delete" id="btnFinalConfirmDelete">Delete My Account</button>
            </div>
        </div>
    </div>

    <!-- Floating Notification -->
    <div class="notification" id="floatingNotification">
        <i class="fas fa-info-circle"></i>
        <span id="notificationMessage">Notification message</span>
    </div>

    <!-- Audio Elements -->
    <audio id="startSound" src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3" preload="auto"></audio>
    <audio id="warningSound" src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" preload="auto"></audio>
    <audio id="timeUpSound" src="https://assets.mixkit.co/sfx/preview/mixkit-unlock-game-notification-253.mp3" preload="auto"></audio>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAf1282ikjQ7MUSP4fKrGQjRTAb1kDWUV8",
            authDomain: "quiz-app-5b02d.firebaseapp.com",
            projectId: "quiz-app-5b02d",
            storageBucket: "quiz-app-5b02d.appspot.com",
            messagingSenderId: "345835769588",
            appId: "1:345835769588:web:702129bc15f30f3d5f18a1"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Enable Firestore persistence
        firebase.firestore().enablePersistence()
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.log("Persistence can only be enabled in one tab at a time");
                } else if (err.code == 'unimplemented') {
                    console.log("The current browser does not support all of the features required to enable persistence");
                }
            });

        // TextIt.biz SMS Gateway Credentials
        const TEXTIT_ID = "94769343928";
        const TEXTIT_PW = "9694";

        // Audio elements
        const startSound = document.getElementById('startSound');
        const warningSound = document.getElementById('warningSound');
        const timeUpSound = document.getElementById('timeUpSound');

        // Google Form URLs for each lesson level (replace with your actual form URLs)
        const formUrls = {
            1: Array(20).fill().map((_, i) => `https://docs.google.com/forms/d/e/YOUR_FORM_ID_1/viewform?embedded=true&level=${i+1}`),
            2: Array(20).fill().map((_, i) => `https://docs.google.com/forms/d/e/YOUR_FORM_ID_2/viewform?embedded=true&level=${i+1}`),
            3: Array(20).fill().map((_, i) => `https://docs.google.com/forms/d/e/YOUR_FORM_ID_3/viewform?embedded=true&level=${i+1}`),
            4: Array(20).fill().map((_, i) => `https://docs.google.com/forms/d/e/YOUR_FORM_ID_4/viewform?embedded=true&level=${i+1}`),
            5: Array(20).fill().map((_, i) => `https://docs.google.com/forms/d/e/YOUR_FORM_ID_5/viewform?embedded=true&level=${i+1}`),
            6: Array(20).fill().map((_, i) => `https://docs.google.com/forms/d/e/YOUR_FORM_ID_6/viewform?embedded=true&level=${i+1}`),
            7: Array(20).fill().map((_, i) => `https://docs.google.com/forms/d/e/YOUR_FORM_ID_7/viewform?embedded=true&level=${i+1}`),
            8: Array(20).fill().map((_, i) => `https://docs.google.com/forms/d/e/YOUR_FORM_ID_8/viewform?embedded=true&level=${i+1}`),
            9: Array(20).fill().map((_, i) => `https://docs.google.com/forms/d/e/YOUR_FORM_ID_9/viewform?embedded=true&level=${i+1}`),
            10: Array(20).fill().map((_, i) => `https://docs.google.com/forms/d/e/YOUR_FORM_ID_10/viewform?embedded=true&level=${i+1}`),
            11: Array(20).fill().map((_, i) => `https://docs.google.com/forms/d/e/YOUR_FORM_ID_11/viewform?embedded=true&level=${i+1}`),
            12: Array(20).fill().map((_, i) => `https://docs.google.com/forms/d/e/YOUR_FORM_ID_12/viewform?embedded=true&level=${i+1}`),
            13: Array(20).fill().map((_, i) => `https://docs.google.com/forms/d/e/YOUR_FORM_ID_13/viewform?embedded=true&level=${i+1}`),
            14: Array(20).fill().map((_, i) => `https://docs.google.com/forms/d/e/YOUR_FORM_ID_14/viewform?embedded=true&level=${i+1}`),
            15: Array(20).fill().map((_, i) => `https://docs.google.com/forms/d/e/YOUR_FORM_ID_15/viewform?embedded=true&level=${i+1}`),
            16: Array(20).fill().map((_, i) => `https://docs.google.com/forms/d/e/YOUR_FORM_ID_16/viewform?embedded=true&level=${i+1}`),
            17: Array(20).fill().map((_, i) => `https://docs.google.com/forms/d/e/YOUR_FORM_ID_17/viewform?embedded=true&level=${i+1}`)
        };

        // Lesson titles for display
        const lessonTitles = {
            1: "ET හැඳින්වීම",
            2: "ඉංජිනේරු ඇඳීම Drawing",
            3: "නිෂ්පාදන තාක්ෂණවේදය Production",
            4: "ගොඩනැගිලි තාක්ෂණවේදය",
            5: "යන්ත්‍ර වල බල සම්ප්‍රේෂණය හා චලිත හැසිරීම්",
            6: "ඉංජිනේරු ආරක්ෂාව Safety",
            7: "ස්වයංචල තාක්ෂණය Automobile",
            8: "විදුලි තාක්ෂණවේදය Electrical",
            9: "ඒකක හා මිනුම්",
            10: "විදුලි යන්ත්‍ර හා බල පද්ධති (මෝටර් පාඩම)",
            11: "ප්‍රමිති හා පිරිවිතර",
            12: "බිම් මැනුම්",
            13: "තරල යන්‍ත්‍ර",
            14: "ඉලෙක්ට්‍රොනික් තාක්ෂණය",
            15: "ජල සම්පාදනය හා කසල අපහනය",
            16: "ප්‍රමාණ බිල්පත් සැකසීම ඇස්තමේන්තුකරණය (TDS BOQ)",
            17: "ව්‍යවසායකත්වය හා කළමනාකරණය"
        };

        // Image URLs for lessons
        const lessonImages = {
            1: "https://via.placeholder.com/300x150?text=Lesson+1",
            2: "https://via.placeholder.com/300x150?text=Lesson+2",
            3: "https://via.placeholder.com/300x150?text=Lesson+3",
            4: "https://via.placeholder.com/300x150?text=Lesson+4",
            5: "https://via.placeholder.com/300x150?text=Lesson+5",
            6: "https://via.placeholder.com/300x150?text=Lesson+6",
            7: "https://via.placeholder.com/300x150?text=Lesson+7",
            8: "https://via.placeholder.com/300x150?text=Lesson+8",
            9: "https://via.placeholder.com/300x150?text=Lesson+9",
            10: "https://via.placeholder.com/300x150?text=Lesson+10",
            11: "https://via.placeholder.com/300x150?text=Lesson+11",
            12: "https://via.placeholder.com/300x150?text=Lesson+12",
            13: "https://via.placeholder.com/300x150?text=Lesson+13",
            14: "https://via.placeholder.com/300x150?text=Lesson+14",
            15: "https://via.placeholder.com/300x150?text=Lesson+15",
            16: "https://via.placeholder.com/300x150?text=Lesson+16",
            17: "https://via.placeholder.com/300x150?text=Lesson+17"
        };

        // Variables for timer
        let quizTimer;
        let timeLeft;
        let quizActive = false;
        let quizDuration = 30; // Default duration in minutes
        let warned10 = false;
        let warned5 = false;
        let currentLesson = null;
        let currentLevel = null;
        let verificationId = null;
        let otpAttempts = 0;
        let lastOtpSentTime = 0;
        let otpResendTimer;
        let generatedOtp = "";
        let deleteVerificationOtp = "";

        // DOM Elements
        const backButton = document.getElementById('backButton');
        const userProfile = document.getElementById('userProfile');
        const userAvatar = document.getElementById('userAvatar');
        const whatsappButton = document.getElementById('whatsappButton');
        const mainContainer = document.querySelector('.container');
        const authModal = document.getElementById('authModal');
        const authModalTitle = document.getElementById('authModalTitle');
        const authModalSubtitle = document.getElementById('authModalSubtitle');
        const authTabs = document.querySelectorAll('.auth-tab');
        const loginForm = document.getElementById('loginForm');
        const signupPhoneForm = document.getElementById('signupPhoneForm');
        const signupOtpForm = document.getElementById('signupOtpForm');
        const signupForm = document.getElementById('signupForm');
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const btnLogin = document.getElementById('btnLogin');
        const signupEmail = document.getElementById('signupEmail');
        const signupPassword = document.getElementById('signupPassword');
        const signupPhone = document.getElementById('signupPhone');
        const btnSendOtp = document.getElementById('btnSendOtp');
        const btnSignup = document.getElementById('btnSignup');
        const otpPhoneNumber = document.getElementById('otpPhoneNumber');
        const otpInputs = document.querySelectorAll('.otp-input');
        const btnVerifyOtp = document.getElementById('btnVerifyOtp');
        const resendOtp = document.getElementById('resendOtp');
        const showSignup = document.getElementById('showSignup');
        const studentModal = document.getElementById('studentModal');
        const studentForm = document.getElementById('studentForm');
        const studentName = document.getElementById('studentName');
        const studentGender = document.getElementById('studentGender');
        const studentEmail = document.getElementById('studentEmail');
        const studentExamYear = document.getElementById('studentExamYear');
        const studentSchool = document.getElementById('studentSchool');
        const studentDistrict = document.getElementById('studentDistrict');
        const studentWhatsapp = document.getElementById('studentWhatsapp');
        const btnSaveStudent = document.getElementById('btnSaveStudent');
        const noticeModal = document.getElementById('noticeModal');
        const btnAcceptNotice = document.getElementById('btnAcceptNotice');
        const quizContainer = document.getElementById('quizContainer');
        const quizIframe = document.getElementById('quizIframe');
        const quizTitle = document.getElementById('quizTitle');
        const quizTimerDisplay = document.getElementById('quizTimer');
        const btnCloseQuiz = document.getElementById('btnCloseQuiz');
        const timeWarningModal = document.getElementById('timeWarningModal');
        const timeUpModal = document.getElementById('timeUpModal');
        const btnAcknowledgeWarning = document.getElementById('btnAcknowledgeWarning');
        const btnAcknowledgeTimeUp = document.getElementById('btnAcknowledgeTimeUp');
        const floatingNotification = document.getElementById('floatingNotification');
        const notificationMessage = document.getElementById('notificationMessage');
        const termsModal = document.getElementById('termsModal');
        const acceptTerms = document.getElementById('acceptTerms');
        const btnAcceptTerms = document.getElementById('btnAcceptTerms');
        const greeting = document.getElementById('greeting');
        const profileModal = document.getElementById('profileModal');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        const profileGender = document.getElementById('profileGender');
        const profileExamYear = document.getElementById('profileExamYear');
        const profileSchool = document.getElementById('profileSchool');
        const profileDistrict = document.getElementById('profileDistrict');
        const profileWhatsapp = document.getElementById('profileWhatsapp');
        const profileCompletedLevels = document.getElementById('profileCompletedLevels');
        const btnDeleteAccount = document.getElementById('btnDeleteAccount');
        const btnLogout = document.getElementById('btnLogout');
        const deleteModal = document.getElementById('deleteModal');
        const btnCancelDelete = document.getElementById('btnCancelDelete');
        const btnConfirmDelete = document.getElementById('btnConfirmDelete');
        const verifyModal = document.getElementById('verifyModal');
        const verifyPhoneNumber = document.getElementById('verifyPhoneNumber');
        const verifyOtpInputs = document.querySelectorAll('.verify-otp-input');
        const btnCancelVerify = document.getElementById('btnCancelVerify');
        const btnVerifyDelete = document.getElementById('btnVerifyDelete');
        const resendVerifyOtp = document.getElementById('resendVerifyOtp');
        const badgeSilver = document.getElementById('badgeSilver');
        const badgeGold = document.getElementById('badgeGold');
        const badgeDiamond = document.getElementById('badgeDiamond');
        const formPreloader = document.querySelector('.form-preloader');
        const lessonsGrid = document.querySelector('.lessons-grid');
        const closeTerms = document.getElementById('closeTerms');
        const closeAuth = document.getElementById('closeAuth');
        const closeStudent = document.getElementById('closeStudent');
        const closeNotice = document.getElementById('closeNotice');
        const closeProfile = document.getElementById('closeProfile');
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const btnFinalCancelDelete = document.getElementById('btnFinalCancelDelete');
        const btnFinalConfirmDelete = document.getElementById('btnFinalConfirmDelete');

        // Initialize the app
        function init() {
            setupEventListeners();
            checkAuthState();
            initParticles();
            updateGreeting();
            populateLessonsGrid();
        }

        // Populate lessons grid
        function populateLessonsGrid() {
            lessonsGrid.innerHTML = '';
            
            for (let i = 1; i <= 17; i++) {
                const lessonCard = document.createElement('div');
                lessonCard.className = 'lesson-card';
                lessonCard.setAttribute('data-lesson', i);
                
                lessonCard.innerHTML = `
                    <img src="${lessonImages[i]}" alt="${lessonTitles[i]}" class="lesson-image">
                    <h3>${lessonTitles[i]}</h3>
                    <p>2025-05-02</p>
                    <div class="lesson-meta">
                        <div class="time-indicator"><i class="fas fa-clock"></i> 30 minutes</div>
                        <div class="question-count"><i class="fas fa-question-circle"></i> 15 questions</div>
                    </div>
                    <div class="dropdown">
                        <button class="dropdown-btn">Start Quiz</button>
                        <div class="dropdown-content">
                            ${Array(20).fill().map((_, j) => 
                                `<a href="#" data-level="${j+1}">Level ${j+1}</a>`
                            ).join('')}
                        </div>
                    </div>
                `;
                
                lessonsGrid.appendChild(lessonCard);
            }
            
            // Add event listeners to lesson cards
            document.querySelectorAll('.lesson-card').forEach(card => {
                card.addEventListener('click', () => {
                    if (!auth.currentUser) {
                        showNotification('Please login to access quiz levels', 'warning');
                        showAuthModal('login');
                        currentLesson = card.getAttribute('data-lesson');
                    }
                });
            });
            
            // Add event listeners to level links
            document.querySelectorAll('.dropdown-content a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const lessonCard = link.closest('.lesson-card');
                    const lessonId = lessonCard.getAttribute('data-lesson');
                    const level = link.getAttribute('data-level');
                    
                    if (auth.currentUser) {
                        startQuiz(lessonId, level);
                    } else {
                        currentLesson = lessonId;
                        currentLevel = level;
                        showNotification('Please login to access quiz levels', 'warning');
                        showAuthModal('login');
                    }
                });
            });
        }

        // Update greeting based on time of day
        function updateGreeting() {
            const hour = new Date().getHours();
            let greetingText = "";
            
            if (hour < 12) {
                greetingText = "Good Morning! 🌞";
            } else if (hour < 17) {
                greetingText = "Good Afternoon! ☀️";
            } else {
                greetingText = "Good Evening! 🌙";
            }
            
            greeting.textContent = greetingText;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Close buttons
            closeTerms.addEventListener('click', () => hideModal(termsModal));
            closeAuth.addEventListener('click', () => {
                if (!auth.currentUser) {
                    showNotification('You must login to access the content', 'warning');
                    return;
                }
                hideAuthModal();
            });
            closeStudent.addEventListener('click', () => hideModal(studentModal));
            closeNotice.addEventListener('click', () => hideModal(noticeModal));
            closeProfile.addEventListener('click', () => hideProfileModal());
            
            // Terms modal
            acceptTerms.addEventListener('change', (e) => {
                btnAcceptTerms.disabled = !e.target.checked;
            });
            
            btnAcceptTerms.addEventListener('click', () => {
                // Store that user has accepted terms in localStorage
                localStorage.setItem('termsAccepted', 'true');
                
                termsModal.querySelector('.terms-content').style.transform = 'scale(0.9)';
                termsModal.querySelector('.terms-content').style.opacity = '0';
                setTimeout(() => {
                    termsModal.style.display = 'none';
                    showAuthModal('login');
                }, 300);
            });
            
            // Back button
            backButton.addEventListener('click', handleBackButton);
            
            // User profile
            userProfile.addEventListener('click', toggleProfileModal);
            
            // WhatsApp button
            whatsappButton.addEventListener('click', () => {
                window.open('https://wa.me/94779817525?text=Hello%20Quiz%20Support,%20I%20need%20help%20with...', '_blank');
            });
            
            // Auth modal tabs
            authTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    switchAuthTab(tabName);
                });
            });
            
            // Show signup link
            showSignup.addEventListener('click', () => switchAuthTab('signup'));
            
            // Login form
            btnLogin.addEventListener('click', handleLogin);
            loginPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            
            // Signup phone form
            btnSendOtp.addEventListener('click', handleSendOtp);
            signupPhone.addEventListener('input', formatPhoneNumber);
            
            // OTP verification
            otpInputs.forEach((input, index) => {
                input.addEventListener('input', () => {
                    if (input.value.length === 1) {
                        if (index < otpInputs.length - 1) {
                            otpInputs[index + 1].focus();
                        }
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && input.value.length === 0 && index > 0) {
                        otpInputs[index - 1].focus();
                    }
                });
            });
            
            btnVerifyOtp.addEventListener('click', verifyOtp);
            resendOtp.addEventListener('click', resendOtpCode);
            
            // Signup form
            btnSignup.addEventListener('click', handleSignup);
            
            // Student form
            studentForm.addEventListener('submit', saveStudentDetails);
            studentWhatsapp.addEventListener('input', formatPhoneNumber);
            
            // Notice modal
            btnAcceptNotice.addEventListener('click', () => {
                hideNoticeModal();
                showStudentModal();
            });
            
            // Quiz controls
            btnCloseQuiz.addEventListener('click', closeQuiz);
            btnAcknowledgeWarning.addEventListener('click', () => hideAlertModal(timeWarningModal));
            btnAcknowledgeTimeUp.addEventListener('click', () => {
                hideAlertModal(timeUpModal);
                closeQuiz();
            });
            
            // Profile modal controls
            btnDeleteAccount.addEventListener('click', showDeleteModal);
            btnLogout.addEventListener('click', handleLogout);
            
            // Delete account modal controls
            btnCancelDelete.addEventListener('click', () => hideModal(deleteModal));
            btnConfirmDelete.addEventListener('click', showVerifyModal);
            
            // Verify modal controls
            btnCancelVerify.addEventListener('click', () => hideModal(verifyModal));
            btnVerifyDelete.addEventListener('click', verifyDeleteAccount);
            resendVerifyOtp.addEventListener('click', resendDeleteOtp);
            
            verifyOtpInputs.forEach((input, index) => {
                input.addEventListener('input', () => {
                    if (input.value.length === 1) {
                        if (index < verifyOtpInputs.length - 1) {
                            verifyOtpInputs[index + 1].focus();
                        }
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && input.value.length === 0 && index > 0) {
                        verifyOtpInputs[index - 1].focus();
                    }
                });
            });
            
            // Final delete confirmation
            btnFinalCancelDelete.addEventListener('click', () => hideModal(confirmDeleteModal));
            btnFinalConfirmDelete.addEventListener('click', finalDeleteAccount);
            
            // Beforeunload event
            window.addEventListener('beforeunload', handleBeforeUnload);
            
            // Click outside modals to close (only for allowed modals)
            document.addEventListener('click', (e) => {
                // Profile modal
                if (profileModal.style.display === 'flex' && e.target === profileModal) {
                    hideProfileModal();
                }
                
                // Student modal
                if (studentModal.style.display === 'flex' && e.target === studentModal) {
                    hideModal(studentModal);
                }
                
                // Notice modal
                if (noticeModal.style.display === 'flex' && e.target === noticeModal) {
                    hideModal(noticeModal);
                }
            });
        }

        // Check auth state
        function checkAuthState() {
            auth.onAuthStateChanged(async user => {
                if (user) {
                    // User is signed in
                    updateUserProfile(user);
                    
                    // Check if user has completed profile
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    
                    if (userDoc.exists && userDoc.data().profileCompleted) {
                        // User has completed profile, show main content
                        showMainContent();
                    } else {
                        // User needs to complete profile
                        showNoticeModal();
                    }
                    
                    // Check if terms were accepted (only show once)
                    const termsAccepted = localStorage.getItem('termsAccepted');
                    if (!termsAccepted) {
                        showTermsModal();
                    }
                } else {
                    // User is signed out
                    userAvatar.textContent = 'G';
                    
                    // Show auth modal immediately
                    showAuthModal('login');
                    
                    // Hide main content
                    mainContainer.classList.remove('show');
                    setTimeout(() => {
                        mainContainer.style.display = 'none';
                    }, 500);
                    
                    // Show terms modal if not accepted yet
                    const termsAccepted = localStorage.getItem('termsAccepted');
                    if (!termsAccepted) {
                        showTermsModal();
                    }
                }
            });
        }

        // Update user profile display
        function updateUserProfile(user) {
            if (user.displayName) {
                userAvatar.textContent = user.displayName.charAt(0).toUpperCase();
            } else {
                userAvatar.textContent = 'U';
            }
        }

        // Show main content
        function showMainContent() {
            mainContainer.style.display = 'block';
            setTimeout(() => {
                mainContainer.classList.add('show');
            }, 10);
        }

        // Show terms modal
        function showTermsModal() {
            termsModal.style.display = 'flex';
            setTimeout(() => {
                termsModal.querySelector('.terms-content').style.transform = 'scale(1)';
                termsModal.querySelector('.terms-content').style.opacity = '1';
            }, 10);
        }

        // Show auth modal
        function showAuthModal(tab = 'login') {
            authModal.style.display = 'flex';
            setTimeout(() => {
                authModal.querySelector('.auth-content').style.transform = 'scale(1)';
                authModal.querySelector('.auth-content').style.opacity = '1';
                switchAuthTab(tab);
            }, 10);
        }

        // Hide auth modal
        function hideAuthModal() {
            authModal.querySelector('.auth-content').style.transform = 'scale(0.9)';
            authModal.querySelector('.auth-content').style.opacity = '0';
            setTimeout(() => {
                authModal.style.display = 'none';
            }, 300);
        }

        // Show student modal
        function showStudentModal() {
            studentModal.style.display = 'flex';
            setTimeout(() => {
                studentModal.querySelector('.student-content').style.transform = 'scale(1)';
                studentModal.querySelector('.student-content').style.opacity = '1';
            }, 10);
        }

        // Hide student modal
        function hideStudentModal() {
            studentModal.querySelector('.student-content').style.transform = 'scale(0.9)';
            studentModal.querySelector('.student-content').style.opacity = '0';
            setTimeout(() => {
                studentModal.style.display = 'none';
            }, 300);
        }

        // Show notice modal
        function showNoticeModal() {
            noticeModal.style.display = 'flex';
            setTimeout(() => {
                noticeModal.querySelector('.notice-content').style.transform = 'scale(1)';
                noticeModal.querySelector('.notice-content').style.opacity = '1';
            }, 10);
        }

        // Hide notice modal
        function hideNoticeModal() {
            noticeModal.querySelector('.notice-content').style.transform = 'scale(0.9)';
            noticeModal.querySelector('.notice-content').style.opacity = '0';
            setTimeout(() => {
                noticeModal.style.display = 'none';
            }, 300);
        }

        // Show profile modal
        async function showProfileModal() {
            if (!auth.currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(auth.currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // Update profile info
                    profileAvatar.textContent = userData.name ? userData.name.charAt(0).toUpperCase() : 'U';
                    profileName.textContent = userData.name || 'Not provided';
                    profileEmail.textContent = userData.email || 'Not provided';
                    profileGender.textContent = userData.gender || 'Not provided';
                    profileExamYear.textContent = userData.examYear || 'Not provided';
                    profileSchool.textContent = userData.school || 'Not provided';
                    profileDistrict.textContent = userData.district || 'Not provided';
                    profileWhatsapp.textContent = userData.whatsapp || 'Not provided';
                    
                    // Calculate completed levels
                    let completedCount = 0;
                    if (userData.completedLevels) {
                        completedCount = Object.keys(userData.completedLevels).length;
                    }
                    profileCompletedLevels.textContent = `${completedCount}/17`;
                    
                    // Update badge display
                    badgeSilver.style.display = 'none';
                    badgeGold.style.display = 'none';
                    badgeDiamond.style.display = 'none';
                    
                    if (completedCount >= 10) {
                        badgeDiamond.style.display = 'flex';
                    } else if (completedCount >= 5) {
                        badgeGold.style.display = 'flex';
                    } else {
                        badgeSilver.style.display = 'flex';
                    }
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                showNotification('Failed to load profile information', 'danger');
            }
            
            profileModal.style.display = 'flex';
            setTimeout(() => {
                profileModal.querySelector('.profile-content').style.transform = 'scale(1)';
                profileModal.querySelector('.profile-content').style.opacity = '1';
            }, 10);
        }

        // Hide profile modal
        function hideProfileModal() {
            profileModal.querySelector('.profile-content').style.transform = 'scale(0.9)';
            profileModal.querySelector('.profile-content').style.opacity = '0';
            setTimeout(() => {
                profileModal.style.display = 'none';
            }, 300);
        }

        // Show delete modal
        function showDeleteModal() {
            deleteModal.style.display = 'flex';
            setTimeout(() => {
                deleteModal.querySelector('.delete-content').style.transform = 'scale(1)';
                deleteModal.querySelector('.delete-content').style.opacity = '1';
            }, 10);
        }

        // Show verify modal
        async function showVerifyModal() {
            hideModal(deleteModal);
            
            try {
                const userDoc = await db.collection('users').doc(auth.currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    verifyPhoneNumber.textContent = userData.whatsapp || '+94XXXXXXXXX';
                    
                    // Generate a 6-digit random code
                    deleteVerificationOtp = Math.floor(100000 + Math.random() * 900000).toString();
                    
                    // Prepare message (URL encoded)
                    const phone = userData.whatsapp.replace('+94', '');
                    const message = `Your+account+deletion+code+is:+${deleteVerificationOtp}`;
                    
                    // Build the API URL
                    const apiUrl = `https://www.textit.biz/sendmsg/?id=${TEXTIT_ID}&pw=${TEXTIT_PW}&to=94${phone}&text=${message}`;
                    
                    // Make the API call
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        throw new Error(`SMS gateway error: ${response.status}`);
                    }
                    
                    const responseText = await response.text();
                    
                    // Check for success response (TextIt.biz returns "OK" on success)
                    if (responseText.includes("OK")) {
                        showNotification(`Verification code sent to ${userData.whatsapp}`, 'success');
                    } else {
                        throw new Error(responseText);
                    }
                }
            } catch (error) {
                console.error('Error sending OTP:', error);
                showNotification('Failed to send OTP. Please try again.', 'danger');
                
                // For testing purposes, show the code anyway
                showNotification(`Demo mode: Your OTP is ${deleteVerificationOtp}`, 'info');
            }
            
            verifyModal.style.display = 'flex';
            setTimeout(() => {
                verifyModal.querySelector('.verify-content').style.transform = 'scale(1)';
                verifyModal.querySelector('.verify-content').style.opacity = '1';
            }, 10);
        }

        // Show confirm delete modal
        function showConfirmDeleteModal() {
            hideModal(verifyModal);
            confirmDeleteModal.style.display = 'flex';
            setTimeout(() => {
                confirmDeleteModal.querySelector('.confirm-delete-content').style.transform = 'scale(1)';
                confirmDeleteModal.querySelector('.confirm-delete-content').style.opacity = '1';
            }, 10);
        }

        // Hide modal (generic function)
        function hideModal(modal) {
            modal.querySelector('.modal-content').style.transform = 'scale(0.9)';
            modal.querySelector('.modal-content').style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        // Toggle profile modal
        function toggleProfileModal() {
            if (auth.currentUser) {
                showProfileModal();
            } else {
                showAuthModal('login');
            }
        }

        // Switch auth tab
        function switchAuthTab(tab) {
            authTabs.forEach(t => t.classList.remove('active'));
            document.querySelector(`.auth-tab[data-tab="${tab}"]`).classList.add('active');
            
            loginForm.classList.remove('active');
            signupPhoneForm.classList.remove('active');
            signupOtpForm.classList.remove('active');
            signupForm.classList.remove('active');
            
            if (tab === 'login') {
                authModalTitle.textContent = 'Welcome Back!';
                authModalSubtitle.textContent = 'Please login to continue';
                loginForm.classList.add('active');
            } else if (tab === 'signup') {
                authModalTitle.textContent = 'Sign Up - Part 1';
                authModalSubtitle.textContent = 'Verify your phone number';
                signupPhoneForm.classList.add('active');
            }
        }

        // Show OTP form
        function showOtpForm(phoneNumber) {
            authModalTitle.textContent = 'Sign Up - Part 2';
            authModalSubtitle.textContent = 'Enter the 6-digit code we sent';
            otpPhoneNumber.textContent = phoneNumber;
            
            loginForm.classList.remove('active');
            signupPhoneForm.classList.remove('active');
            signupOtpForm.classList.add('active');
            
            // Clear OTP inputs
            otpInputs.forEach(input => input.value = '');
            otpInputs[0].focus();
            
            // Reset OTP attempts
            otpAttempts = 0;
            lastOtpSentTime = Date.now();
            
            // Disable resend button for 1 minute
            resendOtp.classList.add('disabled');
            resendOtp.textContent = 'Resend OTP (60s)';
            
            // Start countdown for resend button
            let secondsLeft = 60;
            otpResendTimer = setInterval(() => {
                secondsLeft--;
                resendOtp.textContent = `Resend OTP (${secondsLeft}s)`;
                
                if (secondsLeft <= 0) {
                    clearInterval(otpResendTimer);
                    resendOtp.classList.remove('disabled');
                    resendOtp.textContent = 'Resend OTP';
                }
            }, 1000);
        }

        // Show email/password form
        function showEmailPasswordForm() {
            authModalTitle.textContent = 'Sign Up - Part 3';
            authModalSubtitle.textContent = 'Create your account';
            
            loginForm.classList.remove('active');
            signupOtpForm.classList.remove('active');
            signupForm.classList.add('active');
            
            // Clear form
            signupEmail.value = '';
            signupPassword.value = '';
        }

        // Handle send OTP
        async function handleSendOtp() {
            const phone = signupPhone.value.trim();
            
            if (!phone) {
                showNotification('Please enter your phone number', 'warning');
                return;
            }
            
            if (phone.length !== 9 || !/^\d+$/.test(phone)) {
                showNotification('Please enter a valid 9-digit phone number', 'warning');
                return;
            }
            
            try {
                btnSendOtp.disabled = true;
                btnSendOtp.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                
                // Generate a 6-digit random code
                generatedOtp = Math.floor(100000 + Math.random() * 900000).toString();
                
                // Prepare message (URL encoded)
                const message = `Your+verification+code+is:+${generatedOtp}`;
                
                // Build the API URL
                const apiUrl = `https://www.textit.biz/sendmsg/?id=${TEXTIT_ID}&pw=${TEXTIT_PW}&to=94${phone}&text=${message}`;
                
                // Make the API call
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`SMS gateway error: ${response.status}`);
                }
                
                const responseText = await response.text();
                
                // Check for success response (TextIt.biz returns "OK" on success)
                if (responseText.includes("OK")) {
                    showNotification(`Verification code sent to +94${phone}`, 'success');
                    showOtpForm(phone);
                } else {
                    throw new Error(responseText);
                }
            } catch (error) {
                console.error('Error sending OTP:', error);
                showNotification('Failed to send OTP. Please try again.', 'danger');
                
                // For testing purposes, show the code anyway
                showNotification(`Demo mode: Your OTP is ${generatedOtp}`, 'info');
                showOtpForm(phone);
            } finally {
                btnSendOtp.disabled = false;
                btnSendOtp.textContent = 'Send Verification Code';
            }
        }

        // Handle login
        async function handleLogin() {
            const email = loginEmail.value.trim();
            const password = loginPassword.value.trim();
            
            if (!email || !password) {
                showNotification('Please fill all fields', 'warning');
                return;
            }
            
            try {
                btnLogin.disabled = true;
                btnLogin.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
                
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                showNotification('Login successful!', 'success');
                hideAuthModal();
                updateUserProfile(userCredential.user);
                
                // Check if user has completed profile
                const userDoc = await db.collection('users').doc(userCredential.user.uid).get();
                
                if (userDoc.exists && userDoc.data().profileCompleted) {
                    // User has completed profile, show main content
                    showMainContent();
                } else {
                    // User needs to complete profile
                    showNoticeModal();
                }
                
                // If there's a pending lesson, start quiz
                if (currentLesson && currentLevel) {
                    startQuiz(currentLesson, currentLevel);
                    currentLesson = null;
                    currentLevel = null;
                }
            } catch (error) {
                console.error('Login error:', error);
                let message = 'Login failed. Please try again.';
                if (error.code === 'auth/user-not-found') {
                    message = 'User not found. Please sign up.';
                } else if (error.code === 'auth/wrong-password') {
                    message = 'Incorrect password. Please try again.';
                } else if (error.code === 'auth/too-many-requests') {
                    message = 'Too many attempts. Please try again later.';
                }
                showNotification(message, 'danger');
            } finally {
                btnLogin.disabled = false;
                btnLogin.textContent = 'Login';
            }
        }

        // Verify OTP
        async function verifyOtp() {
            const otp = Array.from(otpInputs).map(input => input.value).join('');
            
            if (otp.length !== 6) {
                showNotification('Please enter a 6-digit code', 'warning');
                return;
            }
            
            try {
                btnVerifyOtp.disabled = true;
                btnVerifyOtp.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
                
                // Increment OTP attempts
                otpAttempts++;
                
                // Verify the OTP
                if (otp === generatedOtp) {
                    showNotification('Phone number verified!', 'success');
                    
                    // Proceed to email/password form
                    showEmailPasswordForm();
                } else {
                    if (otpAttempts >= 3) {
                        showNotification('Maximum attempts reached. Please contact admin.', 'danger');
                        hideAuthModal();
                    } else {
                        showNotification(`Invalid OTP code. ${3 - otpAttempts} attempts remaining.`, 'danger');
                    }
                }
            } catch (error) {
                console.error('OTP verification error:', error);
                showNotification('Verification failed. Please try again.', 'danger');
            } finally {
                btnVerifyOtp.disabled = false;
                btnVerifyOtp.textContent = 'Verify OTP';
            }
        }

        // Resend OTP
        async function resendOtpCode() {
            if (resendOtp.classList.contains('disabled')) return;
            
            try {
                resendOtp.classList.add('disabled');
                resendOtp.textContent = 'Sending...';
                
                // Generate a new OTP
                generatedOtp = Math.floor(100000 + Math.random() * 900000).toString();
                const phone = otpPhoneNumber.textContent;
                
                // Prepare message (URL encoded)
                const message = `Your+new+verification+code+is:+${generatedOtp}`;
                
                // Build the API URL
                const apiUrl = `https://www.textit.biz/sendmsg/?id=${TEXTIT_ID}&pw=${TEXTIT_PW}&to=94${phone}&text=${message}`;
                
                // Make the API call
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`SMS gateway error: ${response.status}`);
                }
                
                const responseText = await response.text();
                
                if (responseText.includes("OK")) {
                    showNotification('New OTP sent to your phone number', 'success');
                    
                    // Reset timer
                    clearInterval(otpResendTimer);
                    lastOtpSentTime = Date.now();
                    
                    // Disable resend button for 1 minute
                    let secondsLeft = 60;
                    resendOtp.textContent = `Resend OTP (${secondsLeft}s)`;
                    
                    otpResendTimer = setInterval(() => {
                        secondsLeft--;
                        resendOtp.textContent = `Resend OTP (${secondsLeft}s)`;
                        
                        if (secondsLeft <= 0) {
                            clearInterval(otpResendTimer);
                            resendOtp.classList.remove('disabled');
                            resendOtp.textContent = 'Resend OTP';
                        }
                    }, 1000);
                } else {
                    throw new Error(responseText);
                }
            } catch (error) {
                console.error('Resend OTP error:', error);
                showNotification('Failed to resend OTP. Please try again.', 'danger');
                resendOtp.classList.remove('disabled');
                resendOtp.textContent = 'Resend OTP';
                
                // For testing purposes, show the code anyway
                showNotification(`Demo mode: Your new OTP is ${generatedOtp}`, 'info');
            }
        }

        // Handle signup
        async function handleSignup() {
            const email = signupEmail.value.trim();
            const password = signupPassword.value.trim();
            
            if (!email || !password) {
                showNotification('Please fill all fields', 'warning');
                return;
            }
            
            if (password.length < 6) {
                showNotification('Password must be at least 6 characters', 'warning');
                return;
            }
            
            try {
                btnSignup.disabled = true;
                btnSignup.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing up...';
                
                // Create user with email/password
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                showNotification('Account created successfully!', 'success');
                hideAuthModal();
                updateUserProfile(userCredential.user);
                
                // Show notice modal before student details
                showNoticeModal();
                
                // If there's a pending lesson, start quiz after profile completion
                if (currentLesson && currentLevel) {
                    // Will be handled after profile completion
                }
            } catch (error) {
                console.error('Signup error:', error);
                let message = 'Signup failed. Please try again.';
                if (error.code === 'auth/email-already-in-use') {
                    message = 'Email already in use. Please login.';
                } else if (error.code === 'auth/weak-password') {
                    message = 'Password should be at least 6 characters';
                } else if (error.code === 'auth/invalid-email') {
                    message = 'Please enter a valid email address';
                }
                showNotification(message, 'danger');
            } finally {
                btnSignup.disabled = false;
                btnSignup.textContent = 'Complete Sign Up';
            }
        }

        // Save student details
        async function saveStudentDetails(e) {
            e.preventDefault();
            
            const name = studentName.value.trim();
            const gender = studentGender.value;
            const email = studentEmail.value.trim();
            const examYear = studentExamYear.value.trim();
            const school = studentSchool.value.trim();
            const district = studentDistrict.value.trim();
            const whatsapp = studentWhatsapp.value.trim();
            
            if (!name || !gender || !email || !examYear || !school || !district || !whatsapp) {
                showNotification('Please fill all fields', 'warning');
                return;
            }
            
            if (whatsapp.length !== 9 || !/^\d+$/.test(whatsapp)) {
                showNotification('Please enter a valid 9-digit WhatsApp number', 'warning');
                return;
            }
            
            try {
                showFormPreloader();
                btnSaveStudent.disabled = true;
                btnSaveStudent.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                
                const user = auth.currentUser;
                
                // Update user profile with display name
                await user.updateProfile({
                    displayName: name
                });
                
                // Save additional user data to Firestore
                const userData = {
                    uid: user.uid,
                    name,
                    gender,
                    email,
                    examYear: parseInt(examYear),
                    school,
                    district,
                    whatsapp: `+94${whatsapp}`,
                    profileCompleted: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    completedLevels: {}
                };
                
                await db.collection('users').doc(user.uid).set(userData, { merge: true });
                
                showNotification('Profile information saved successfully!', 'success');
                hideStudentModal();
                updateUserProfile(user);
                showMainContent();
                
                // If there's a pending lesson, start quiz
                if (currentLesson && currentLevel) {
                    startQuiz(currentLesson, currentLevel);
                    currentLesson = null;
                    currentLevel = null;
                }
            } catch (error) {
                console.error('Error saving student details:', error);
                showNotification('Failed to save information. Please try again.', 'danger');
            } finally {
                hideFormPreloader();
                btnSaveStudent.disabled = false;
                btnSaveStudent.textContent = 'Save Information';
            }
        }

        // Format phone number
        function formatPhoneNumber() {
            let value = this.value.replace(/\D/g, '');
            if (value.length > 9) value = value.substring(0, 9);
            this.value = value;
        }

        // Handle logout
        async function handleLogout() {
            try {
                await auth.signOut();
                showNotification('Logged out successfully', 'success');
                hideProfileModal();
                mainContainer.classList.remove('show');
                setTimeout(() => {
                    mainContainer.style.display = 'none';
                }, 500);
                showAuthModal('login');
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Failed to logout. Please try again.', 'danger');
            }
        }

        // Resend delete account OTP
        async function resendDeleteOtp() {
            try {
                resendVerifyOtp.classList.add('disabled');
                resendVerifyOtp.textContent = 'Sending...';
                
                // Generate a new OTP
                deleteVerificationOtp = Math.floor(100000 + Math.random() * 900000).toString();
                
                const userDoc = await db.collection('users').doc(auth.currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    const phone = userData.whatsapp.replace('+94', '');
                    
                    // Prepare message (URL encoded)
                    const message = `Your+new+account+deletion+code+is:+${deleteVerificationOtp}`;
                    
                    // Build the API URL
                    const apiUrl = `https://www.textit.biz/sendmsg/?id=${TEXTIT_ID}&pw=${TEXTIT_PW}&to=94${phone}&text=${message}`;
                    
                    // Make the API call
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        throw new Error(`SMS gateway error: ${response.status}`);
                    }
                    
                    const responseText = await response.text();
                    
                    if (responseText.includes("OK")) {
                        showNotification('New OTP sent to your phone number', 'success');
                        
                        // Disable resend button for 1 minute
                        let secondsLeft = 60;
                        resendVerifyOtp.textContent = `Resend OTP (${secondsLeft}s)`;
                        
                        const timer = setInterval(() => {
                            secondsLeft--;
                            resendVerifyOtp.textContent = `Resend OTP (${secondsLeft}s)`;
                            
                            if (secondsLeft <= 0) {
                                clearInterval(timer);
                                resendVerifyOtp.classList.remove('disabled');
                                resendVerifyOtp.textContent = 'Resend OTP';
                            }
                        }, 1000);
                    } else {
                        throw new Error(responseText);
                    }
                }
            } catch (error) {
                console.error('Resend OTP error:', error);
                showNotification('Failed to resend OTP. Please try again.', 'danger');
                resendVerifyOtp.classList.remove('disabled');
                resendVerifyOtp.textContent = 'Resend OTP';
                
                // For testing purposes, show the code anyway
                showNotification(`Demo mode: Your new OTP is ${deleteVerificationOtp}`, 'info');
            }
        }

        // Verify delete account
        async function verifyDeleteAccount() {
            const otp = Array.from(verifyOtpInputs).map(input => input.value).join('');
            
            if (otp.length !== 6) {
                showNotification('Please enter a 6-digit code', 'warning');
                return;
            }
            
            try {
                btnVerifyDelete.disabled = true;
                btnVerifyDelete.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
                
                if (otp === deleteVerificationOtp) {
                    showConfirmDeleteModal();
                } else {
                    showNotification('Invalid verification code', 'danger');
                }
            } catch (error) {
                console.error('Error verifying OTP:', error);
                showNotification('Failed to verify OTP. Please try again.', 'danger');
            } finally {
                btnVerifyDelete.disabled = false;
                btnVerifyDelete.textContent = 'Verify & Delete';
            }
        }

        // Final delete account
        async function finalDeleteAccount() {
            try {
                btnFinalConfirmDelete.disabled = true;
                btnFinalConfirmDelete.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                
                // Delete user data from Firestore
                await db.collection('users').doc(auth.currentUser.uid).delete();
                
                // Delete user from Firebase Auth
                await auth.currentUser.delete();
                
                showNotification('Account deleted successfully', 'success');
                hideModal(confirmDeleteModal);
                hideProfileModal();
                mainContainer.classList.remove('show');
                setTimeout(() => {
                    mainContainer.style.display = 'none';
                }, 500);
                showAuthModal('login');
            } catch (error) {
                console.error('Error deleting account:', error);
                showNotification('Failed to delete account. Please try again.', 'danger');
            } finally {
                btnFinalConfirmDelete.disabled = false;
                btnFinalConfirmDelete.textContent = 'Delete My Account';
            }
        }

        // Start quiz
        function startQuiz(lessonId, level) {
            currentLesson = lessonId;
            currentLevel = level;
            quizActive = true;
            quizDuration = 30; // 30 minutes for all levels
            timeLeft = quizDuration * 60; // Convert minutes to seconds
            warned10 = false;
            warned5 = false;
            updateTimerDisplay();
            
            // Show form preloader
            showFormPreloader();
            
            // Set quiz title
            quizTitle.textContent = `${lessonTitles[lessonId]} - Level ${level}`;
            
            // Load Google Form in iframe after a short delay to show preloader
            setTimeout(() => {
                quizIframe.src = formUrls[lessonId][level - 1] || 'about:blank';
                quizIframe.onload = () => {
                    hideFormPreloader();
                };
                
                // Show quiz container
                quizContainer.style.display = 'flex';
                
                // Start timer
                quizTimer = setInterval(updateQuizTimer, 1000);
                
                // Show notification
                showNotification(`Quiz started! You have 30 minutes to complete 15 questions.`, 'success');
                
                // Speak the time limit
                if ('speechSynthesis' in window) {
                    const speech = new SpeechSynthesisUtterance();
                    speech.text = `Your ${lessonTitles[lessonId]} Level ${level} quiz has started. You have 30 minutes to complete 15 questions. Good luck!`;
                    window.speechSynthesis.speak(speech);
                }
                
                // Show back button
                backButton.classList.add('show');
            }, 500);
        }

        // Show form preloader
        function showFormPreloader() {
            formPreloader.style.display = 'flex';
        }

        // Hide form preloader
        function hideFormPreloader() {
            formPreloader.style.display = 'none';
        }

        // Update quiz timer
        function updateQuizTimer() {
            timeLeft--;
            updateTimerDisplay();
            
            // Check for warnings (10, 5 minutes remaining)
            const minutesLeft = Math.ceil(timeLeft / 60);
            
            if (minutesLeft === 10 && !warned10) {
                showTimeWarning(`You have 10 minutes remaining to complete your quiz.`);
                warningSound.play();
                warned10 = true;
            } else if (minutesLeft === 5 && !warned5) {
                showTimeWarning(`Only 5 minutes left! Make sure to submit your answers.`);
                warningSound.play();
                warned5 = true;
            } else if (timeLeft <= 0) {
                // Time's up
                timeUpSound.play();
                endQuiz(true);
            }
        }

        // Update timer display
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            quizTimerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Change color when time is running low
            if (timeLeft <= quizDuration * 60 * 0.25) {
                quizTimerDisplay.style.color = 'var(--danger)';
            } else if (timeLeft <= quizDuration * 60 * 0.5) {
                quizTimerDisplay.style.color = 'var(--warning)';
            } else {
                quizTimerDisplay.style.color = 'white';
            }
        }

        // Show time warning
        function showTimeWarning(message) {
            document.getElementById('timeWarningMessage').textContent = message;
            timeWarningModal.style.display = 'flex';
            setTimeout(() => {
                timeWarningModal.querySelector('.alert-content').style.transform = 'scale(1)';
                timeWarningModal.querySelector('.alert-content').style.opacity = '1';
            }, 10);
            
            // Also show floating notification
            showNotification(message, 'warning');
            
            // Speak the warning
            if ('speechSynthesis' in window) {
                const speech = new SpeechSynthesisUtterance();
                speech.text = message;
                window.speechSynthesis.speak(speech);
            }
        }

        // End quiz
        async function endQuiz(timeExpired = false) {
            clearInterval(quizTimer);
            quizActive = false;
            
            // Update user's completed levels in Firestore
            if (auth.currentUser && currentLesson && currentLevel) {
                try {
                    const userRef = db.collection('users').doc(auth.currentUser.uid);
                    const userDoc = await userRef.get();
                    
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        const completedLevels = userData.completedLevels || {};
                        
                        if (!completedLevels[currentLesson]) {
                            completedLevels[currentLesson] = [];
                        }
                        
                        if (!completedLevels[currentLesson].includes(currentLevel)) {
                            completedLevels[currentLesson].push(currentLevel);
                            await userRef.update({
                                completedLevels: completedLevels,
                                lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error updating completed levels:', error);
                }
            }
            
            if (timeExpired) {
                // Show time up modal
                timeUpModal.style.display = 'flex';
                setTimeout(() => {
                    timeUpModal.querySelector('.alert-content').style.transform = 'scale(1)';
                    timeUpModal.querySelector('.alert-content').style.opacity = '1';
                }, 10);
            }
        }

        // Close quiz
        async function closeQuiz() {
            if (quizActive) {
                if (confirm('Are you sure you want to close the quiz? Your progress may be lost.')) {
                    clearInterval(quizTimer);
                    quizContainer.style.display = 'none';
                    quizIframe.src = '';
                    quizActive = false;
                }
            } else {
                quizContainer.style.display = 'none';
                quizIframe.src = '';
            }
            
            // Hide back button
            backButton.classList.remove('show');
        }

        // Hide alert modal
        function hideAlertModal(modal) {
            modal.querySelector('.alert-content').style.transform = 'scale(0.9)';
            modal.querySelector('.alert-content').style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        // Show notification
        function showNotification(message, type = 'info') {
            notificationMessage.textContent = message;
            floatingNotification.className = `notification ${type}`;
            floatingNotification.classList.add('show');
            
            setTimeout(() => {
                floatingNotification.classList.remove('show');
            }, 5000);
        }

        // Handle back button
        function handleBackButton() {
            if (quizContainer.style.display === 'flex') {
                closeQuiz();
            } else {
                // Handle other back button cases if needed
            }
        }

        // Handle beforeunload event
        function handleBeforeUnload(e) {
            if (quizActive) {
                e.preventDefault();
                e.returnValue = 'Are you sure you want to leave? Your quiz progress may be lost.';
                return e.returnValue;
            }
        }

        // Simple particles effect
        function initParticles() {
            const particles = document.querySelector('.particles');
            const particleCount = 30;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.style.position = 'absolute';
                particle.style.width = `${Math.random() * 5 + 2}px`;
                particle.style.height = particle.style.width;
                particle.style.backgroundColor = `rgba(255, 255, 255, ${Math.random() * 0.5 + 0.1})`;
                particle.style.borderRadius = '50%';
                particle.style.top = `${Math.random() * 100}%`;
                particle.style.left = `${Math.random() * 100}%`;
                
                // Animation
                const duration = Math.random() * 20 + 10;
                const delay = Math.random() * 5;
                particle.style.animation = `float ${duration}s ease-in-out ${delay}s infinite`;
                
                particles.appendChild(particle);
            }
        }

        // Preloader
        window.addEventListener('load', function() {
            setTimeout(function() {
                document.querySelector('.preloader').classList.add('fade-out');
                
                setTimeout(function() {
                    document.querySelector('.preloader').style.display = 'none';
                }, 500);
            }, 1500);
        });

        // Initialize the app
        init();
    </script>
</body>
</html>
